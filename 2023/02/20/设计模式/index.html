<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>设计模式 | Huang Blog</title><meta name="author" content="Huang RD"><meta name="copyright" content="Huang RD"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Java 常见的设计模式设计模式的原则六大设计原则:  单一职责原则 (Single Responsibility Principle)：一个类只有一个发生变化的原因。 开闭原则原则 (Open-Closed Principle)：扩展开放，修改关闭。 里氏替换原则 (Liskov Substitution Principle)：继承必须保证超类拥有的性质在子类依然成立。 迪米特法则（Law Of">
<meta property="og:type" content="article">
<meta property="og:title" content="设计模式">
<meta property="og:url" content="http://www.haungrd.top/2023/02/20/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/index.html">
<meta property="og:site_name" content="Huang Blog">
<meta property="og:description" content="Java 常见的设计模式设计模式的原则六大设计原则:  单一职责原则 (Single Responsibility Principle)：一个类只有一个发生变化的原因。 开闭原则原则 (Open-Closed Principle)：扩展开放，修改关闭。 里氏替换原则 (Liskov Substitution Principle)：继承必须保证超类拥有的性质在子类依然成立。 迪米特法则（Law Of">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.huangrd.top/images/agentina/10.jpg">
<meta property="article:published_time" content="2023-02-20T10:12:57.000Z">
<meta property="article:modified_time" content="2023-05-06T13:12:57.000Z">
<meta property="article:author" content="Huang RD">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="设计模式">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.huangrd.top/images/agentina/10.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.haungrd.top/2023/02/20/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '设计模式',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 21:12:57'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://getwallpapers.com/wallpaper/full/a/1/8/1057222-free-download-cool-nature-backgrounds-1920x1200-windows-10.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">56</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://www.huangrd.top/images/agentina/10.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Huang Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">设计模式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-20T10:12:57.000Z" title="发表于 2023-02-20 18:12:57">2023-02-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T13:12:57.000Z" title="更新于 2023-05-06 21:12:57">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">32.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>127分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="设计模式"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Java-常见的设计模式"><a href="#Java-常见的设计模式" class="headerlink" title="Java 常见的设计模式"></a>Java 常见的设计模式</h1><h2 id="设计模式的原则"><a href="#设计模式的原则" class="headerlink" title="设计模式的原则"></a>设计模式的原则</h2><p>六大设计原则:</p>
<ol>
<li><strong>单一职责原则</strong> (Single Responsibility Principle)：一个类只有一个发生变化的原因。</li>
<li><strong>开闭原则原则</strong> (Open-Closed Principle)：扩展开放，修改关闭。</li>
<li><strong>里氏替换原则</strong> (Liskov Substitution Principle)：继承必须保证超类拥有的性质在子类依然成立。</li>
<li><strong>迪米特法则</strong>（Law Of Demeter）：减少类之间的耦合，保证最少知道，减少依赖。</li>
<li><strong>接口隔离原则</strong> (Interface Segregation Principle)：更小的接口、更具体的接口。</li>
<li><strong>依赖倒转原则</strong> (Dependence Inversion Principle)：面向抽象的依赖接口而不是实现。</li>
<li><strong>组合&#x2F;聚合复用原则</strong> (Composite&#x2F;Aggregate Reuse Principle)</li>
</ol>
<h4 id="1-单一职责原则-SRP"><a href="#1-单一职责原则-SRP" class="headerlink" title="1.单一职责原则 SRP"></a>1.单一职责原则 SRP</h4><p>单一职责原则表示一个模块的组成元素之间的功能相关性。从软件变化的角度来看，就一个类而言，应该仅有一个让它变化的原因，即一个类只负责一项职责。</p>
<p>举例场景：动物呼吸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">(String animal)</span>&#123;  </span><br><span class="line">        System.out.println(animal + <span class="string">&quot;呼吸空气&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">        <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Animal</span>();  </span><br><span class="line">        animal.breathe(<span class="string">&quot;牛&quot;</span>);  </span><br><span class="line">        animal.breathe(<span class="string">&quot;羊&quot;</span>);  </span><br><span class="line">        animal.breathe(<span class="string">&quot;猪&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>如果有新物种如🐟不需要呼吸，根据<strong>单一职责原则</strong>就需要对代码进行修改，需要拆分之前的 Animal 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Terrestrial</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">(String animal)</span>&#123;  </span><br><span class="line">        System.out.println(animal + <span class="string">&quot;呼吸空气&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Aquatic</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">(String animal)</span>&#123;  </span><br><span class="line">        System.out.println(animal + <span class="string">&quot;呼吸水&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">        <span class="type">Terrestrial</span> <span class="variable">terrestrial</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Terrestrial</span>();  </span><br><span class="line">        terrestrial.breathe(<span class="string">&quot;牛&quot;</span>);  </span><br><span class="line">        terrestrial.breathe(<span class="string">&quot;羊&quot;</span>);  </span><br><span class="line">        terrestrial.breathe(<span class="string">&quot;猪&quot;</span>);  </span><br><span class="line">          </span><br><span class="line">        <span class="type">Aquatic</span> <span class="variable">aquatic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Aquatic</span>();  </span><br><span class="line">        aquatic.breathe(<span class="string">&quot;鱼&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>如果违反单一职责原则，则修改代码的花销会减少。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">(String animal)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;鱼&quot;</span>.equals(animal))&#123;  </span><br><span class="line">            System.out.println(animal + <span class="string">&quot;呼吸水&quot;</span>);  </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            System.out.println(animal + <span class="string">&quot;呼吸空气&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">        <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Animal</span>();  </span><br><span class="line">        animal.breathe(<span class="string">&quot;牛&quot;</span>);  </span><br><span class="line">        animal.breathe(<span class="string">&quot;羊&quot;</span>);  </span><br><span class="line">        animal.breathe(<span class="string">&quot;猪&quot;</span>);  </span><br><span class="line">        animal.breathe(<span class="string">&quot;鱼&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一种修改方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">(String animal)</span>&#123;  </span><br><span class="line">        System.out.println(animal + <span class="string">&quot;呼吸空气&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe2</span><span class="params">(String animal)</span>&#123;  </span><br><span class="line">        System.out.println(animal + <span class="string">&quot;呼吸水&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">        <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Animal</span>();  </span><br><span class="line">        animal.breathe(<span class="string">&quot;牛&quot;</span>);  </span><br><span class="line">        animal.breathe(<span class="string">&quot;羊&quot;</span>);  </span><br><span class="line">        animal.breathe(<span class="string">&quot;猪&quot;</span>);  </span><br><span class="line">        animal.breathe2(<span class="string">&quot;鱼&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>但是这样可能存在安全隐患。</p>
<p><strong>总结</strong>:</p>
<ol>
<li>SRP 是一个简单又直观的原则，但是在实际编码的过程中很难将它恰当地运用，需要结合实际情况进行运用。</li>
<li>单一职责原则可以降低类的复杂度，一个类仅负责一项职责，其逻辑肯定要比负责多项职责简单。</li>
<li>提高了代码的可读性，提高系统的可维护性。</li>
</ol>
<h4 id="2-开放-关闭原则-OCP"><a href="#2-开放-关闭原则-OCP" class="headerlink" title="2.开放-关闭原则 OCP"></a>2.开放-关闭原则 OCP</h4><p>开放-关闭原则表示软件实体 (类、模块、函数等等) 应该是<strong>可以被扩展的，但是不可被修改</strong>。(Open for extension, close for modification)</p>
<p>优点：</p>
<ol>
<li>能够扩展已存在的系统，能够提供新的功能满足新的需求，因此该软件有着很强的适应性和灵活性。</li>
<li>已存在的模块，特别是那些重要的抽象模块，不需要被修改，那么该软件就有很强的稳定性和持久性。</li>
</ol>
<p>举例：电脑生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Computer</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Macbook</span> <span class="keyword">implements</span> <span class="title class_">Computer</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Surface</span> <span class="keyword">implements</span> <span class="title class_">Computer</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Computer <span class="title function_">produceComputer</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="type">Computer</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(type.equals(<span class="string">&quot;macbook&quot;</span>))&#123;</span><br><span class="line">            c = <span class="keyword">new</span> <span class="title class_">Macbook</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type.equals(<span class="string">&quot;surface&quot;</span>))&#123;</span><br><span class="line">            c = <span class="keyword">new</span> <span class="title class_">Surface</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果加入新的品牌，则需要修改之前的代码。应该提供一个接口让新的品牌去拓展加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Computer</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Macbook</span> <span class="keyword">implements</span> <span class="title class_">Computer</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Surface</span> <span class="keyword">implements</span> <span class="title class_">Computer</span> &#123;&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Computer <span class="title function_">produceComputer</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppleFactory</span> <span class="keyword">implements</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Computer <span class="title function_">produceComputer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Macbook</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MSFactory</span> <span class="keyword">implements</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Computer <span class="title function_">produceComputer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Surface</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写抽象工厂提供接口，让不同的品牌的工厂进行实现拓展。</p>
<p><strong>总结</strong>：</p>
<ol>
<li>OCP 可以具有良好的可扩展性，可维护性。</li>
<li>不可能让一个系统的所有模块都满足 OCP 原则，我们能做到的是尽可能地不要修改已经写好的代码，已有的功能，而是去扩展它。</li>
</ol>
<h4 id="3-里氏替换原则-LSP"><a href="#3-里氏替换原则-LSP" class="headerlink" title="3.里氏替换原则 LSP"></a>3.里氏替换原则 LSP</h4><p>里氏替换原则告诉我们，当使用继承时候，类 B 继承类 A 时，除添加新的方法完成新增功能 P2，尽量不要修改父类方法预期的行为。</p>
<p><strong>里氏替换原则的重点在不影响原功能，而不是不覆盖原方法</strong></p>
<p>里氏替换原则通俗的来讲就是：子类可以扩展父类的功能，但不能改变父类原有的功能。</p>
<h4 id="4-依赖倒转原则-DIP"><a href="#4-依赖倒转原则-DIP" class="headerlink" title="4.依赖倒转原则 DIP"></a>4.依赖倒转原则 DIP</h4><p>定义：高层模块不应该依赖低层模块，二者都应该于抽象。进一步说，抽象不应该依赖于细节，细节应该依赖于抽象。</p>
<p><strong>依赖倒转原则的核心思想就是面向接口编程</strong></p>
<p>举例：讲故事</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;这是一个有趣的故事&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mother</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">(Book book)</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;妈妈开始讲故事&quot;</span>);  </span><br><span class="line">        System.out.println(book.getContent());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">        <span class="type">Mother</span> <span class="variable">mother</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mother</span>();  </span><br><span class="line">        mother.say(<span class="keyword">new</span> <span class="title class_">Book</span>());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>现在需要母亲给盖孩子将报纸的内容，则需要修改代码。较好的方式就是 引入一个抽象接口 IReader 读物，让书和报纸去实现这个接口，那么无论提供什么样的读物，该母亲都能读。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IReader</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Newspaper</span> <span class="keyword">implements</span> <span class="title class_">IReader</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;这个一则重要的新闻&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span> <span class="keyword">implements</span> <span class="title class_">IReader</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;这是一个有趣的故事&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mother</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">(IReader reader)</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;妈妈开始讲故事&quot;</span>);  </span><br><span class="line">        System.out.println(reader.getContent());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">        <span class="type">Mother</span> <span class="variable">mother</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mother</span>();  </span><br><span class="line">        mother.say(<span class="keyword">new</span> <span class="title class_">Book</span>());  </span><br><span class="line">        mother.say(<span class="keyword">new</span> <span class="title class_">Newspaper</span>());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>依赖倒转原则的核心就是要我们面向接口编程，理解了面向接口编程，也就理解了依赖倒转。</strong></p>
<h4 id="5-接口隔离原则-ISP"><a href="#5-接口隔离原则-ISP" class="headerlink" title="5.接口隔离原则 ISP"></a>5.接口隔离原则 ISP</h4><p>接口隔离原则强调：<strong>客户端不应该依赖它不需要的接口；一个类对另一个类的依赖应该建立在最小的接口上。</strong></p>
<p>案例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/v2-ec9b282b367e9c148a7963b5b23c60e7_720w.webp" alt="img"></p>
<p>存在接口冗余，例如A并不需要方法4,5，但B还是实现了4，5</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">I</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method4</span><span class="params">()</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method5</span><span class="params">()</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend1</span><span class="params">(I i)</span>&#123;  </span><br><span class="line">        i.method1();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend2</span><span class="params">(I i)</span>&#123;  </span><br><span class="line">        i.method2();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend3</span><span class="params">(I i)</span>&#123;  </span><br><span class="line">        i.method3();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">implements</span> <span class="title class_">I</span>&#123;  </span><br><span class="line">	 <span class="comment">// 类 B 只需要实现方法 1，2, 3，而其它方法它并不需要，但是也需要实现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 B 实现接口 I 的方法 1&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 B 实现接口 I 的方法 2&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 B 实现接口 I 的方法 3&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method4</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method5</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend1</span><span class="params">(I i)</span>&#123;  </span><br><span class="line">        i.method1();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend2</span><span class="params">(I i)</span>&#123;  </span><br><span class="line">        i.method4();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend3</span><span class="params">(I i)</span>&#123;  </span><br><span class="line">        i.method5();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span> <span class="keyword">implements</span> <span class="title class_">I</span>&#123;  </span><br><span class="line">	<span class="comment">// 类 D 只需要实现方法 1，4，5，而其它方法它并不需要，但是也需要实现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 D 实现接口 I 的方法 1&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method4</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 D 实现接口 I 的方法 4&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method5</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 D 实现接口 I 的方法 5&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">        <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();  </span><br><span class="line">        a.depend1(<span class="keyword">new</span> <span class="title class_">B</span>());  </span><br><span class="line">        a.depend2(<span class="keyword">new</span> <span class="title class_">B</span>());  </span><br><span class="line">        a.depend3(<span class="keyword">new</span> <span class="title class_">B</span>());  </span><br><span class="line">          </span><br><span class="line">        <span class="type">C</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">C</span>();  </span><br><span class="line">        c.depend1(<span class="keyword">new</span> <span class="title class_">D</span>());  </span><br><span class="line">        c.depend2(<span class="keyword">new</span> <span class="title class_">D</span>());  </span><br><span class="line">        c.depend3(<span class="keyword">new</span> <span class="title class_">D</span>());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>根据接口隔离原则进行修改:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/v2-7611098e41bcfbf5113d978b47fc8466_720w.webp" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">I1</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">I2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">I3</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method4</span><span class="params">()</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method5</span><span class="params">()</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend1</span><span class="params">(I1 i)</span>&#123;  </span><br><span class="line">        i.method1();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend2</span><span class="params">(I2 i)</span>&#123;  </span><br><span class="line">        i.method2();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend3</span><span class="params">(I2 i)</span>&#123;  </span><br><span class="line">        i.method3();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">implements</span> <span class="title class_">I1</span>, I2&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 B 实现接口 I1 的方法 1&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 B 实现接口 I2 的方法 2&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 B 实现接口 I2 的方法 3&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend1</span><span class="params">(I1 i)</span>&#123;  </span><br><span class="line">        i.method1();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend2</span><span class="params">(I3 i)</span>&#123;  </span><br><span class="line">        i.method4();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">depend3</span><span class="params">(I3 i)</span>&#123;  </span><br><span class="line">        i.method5();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span> <span class="keyword">implements</span> <span class="title class_">I1</span>, I3&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 D 实现接口 I1 的方法 1&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method4</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 D 实现接口 I3 的方法 4&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method5</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;类 D 实现接口 I3 的方法 5&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ol>
<li>接口隔离原则的思想在于建立单一接口，尽可能地去细化接口，接口中的方法尽可能少</li>
<li>但是凡事都要有个度，如果接口设计过小，则会造成接口数量过多，使设计复杂化。所以一定要适度。</li>
</ol>
<h4 id="6-迪米特法则-LOD"><a href="#6-迪米特法则-LOD" class="headerlink" title="6.迪米特法则 LOD"></a>6.迪米特法则 LOD</h4><p>迪米特法则又称为 最少知道原则，它表示一个对象应该对其它对象保持最少的了解。只与直接的朋友通信。</p>
<h4 id="7-组合-x2F-聚合复用原则-CRP"><a href="#7-组合-x2F-聚合复用原则-CRP" class="headerlink" title="7.组合&#x2F;聚合复用原则 CRP"></a>7.组合&#x2F;聚合复用原则 CRP</h4><p>组合&#x2F;聚合复用原则就是在一个新的对象里面使用一些已有的对象，使之成为新对象的一部分; 新的对象通过向这些对象的委派达到复用已有功能的目的。</p>
<p>在面向对象的设计中，如果直接继承基类，会破坏封装，因为继承将基类的实现细节暴露给子类；如果基类的实现发生了改变，则子类的实现也不得不改变；从基类继承而来的实现是静态的，不可能在运行时发生改变，没有足够的灵活性。于是就提出了组合&#x2F;聚合复用原则，也就是在实际开发设计中，尽量使用组合&#x2F;聚合，不要使用类继承。</p>
<p>总结：</p>
<ol>
<li>总体说来，组合&#x2F;聚合复用原则告诉我们：组合或者聚合好过于继承。</li>
<li>聚合组合是一种 “黑箱” 复用，因为细节对象的内容对客户端来说是不可见的。</li>
</ol>
<h2 id="一、创建型模式"><a href="#一、创建型模式" class="headerlink" title="一、创建型模式"></a>一、创建型模式</h2><h3 id="1、单例模式"><a href="#1、单例模式" class="headerlink" title="1、单例模式"></a>1、单例模式</h3><p><strong>要求</strong></p>
<ul>
<li>掌握五种单例模式的实现方式</li>
<li>理解为何 (双检锁)DCL 实现时要使用 volatile 修饰静态变量</li>
<li>了解 jdk 中用到单例的场景</li>
</ul>
<h4 id="static-饿汉式"><a href="#static-饿汉式" class="headerlink" title="static 饿汉式"></a>static 饿汉式</h4><ul>
<li>饿汉式就是在类的加载阶段，会初始化类的实例对象。</li>
<li>静态代码的执行处于类生命周期中的初始化阶段，由虚拟机保证其原子且安全执行，所以饿汉式不会有并发的问题，但是存在资源的浪费。</li>
<li>饿汉式为了防止反射的破坏，要在构造上加上对实例的判断。</li>
<li>饿汉式为了防止反序列化的破坏，需要重写 readResolve 方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton1</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;单例对象不能重复创建&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;private Singleton1()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Singleton1</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton1</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton1 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">otherMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;otherMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">readResolve</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>构造方法抛出异常是防止反射破坏单例</li>
<li><code>readResolve()</code> 是防止反序列化破坏单例</li>
</ul>
<h4 id="枚举饿汉式"><a href="#枚举饿汉式" class="headerlink" title="枚举饿汉式"></a>枚举饿汉式</h4><ul>
<li>枚举实现，JVM在编译成字节码时会自动的继承 Enum 类来实现单列。</li>
<li>反编译后，实际上是使用 static 定义变量，之后通过定义 static 代码块来进行创建。</li>
<li>枚举饿汉式能天然防止反射、反序列化破坏单例，但是不能解决 unsafe() 来创建对象。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Singleton2</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;private Singleton2()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getClass().getName() + <span class="string">&quot;@&quot;</span> + Integer.toHexString(hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton2 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">otherMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;otherMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="懒汉式"><a href="#懒汉式" class="headerlink" title="懒汉式"></a>懒汉式</h4><ul>
<li>所谓懒汉式就是只有在调用获取对象的方法时才会创建对象。</li>
<li>懒汉式存在并发问题，在多线程的情况下，并不能保证创建对象的安全性。</li>
<li>如果用 synchronized 来同步获取实例的方法，就会影响并发的性能。</li>
<li>其实只有首次创建单例对象时才需要同步，但该代码实际上每次调用都会同步</li>
<li>因此有了下面的双检锁改进</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton3</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton3</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;private Singleton3()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton3</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Singleton3.class</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton3 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">            INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton3</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">otherMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;otherMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="双检锁懒汉式"><a href="#双检锁懒汉式" class="headerlink" title="双检锁懒汉式"></a>双检锁懒汉式</h4><p>采用双检锁的方式。</p>
<p>为何必须加 volatile：</p>
<ul>
<li><code>INSTANCE = new Singleton4()</code> 不是原子的，在底层的JVM中，分成 3 步：开辟空间、初始化、给变量赋值，其中后两步可能被指令重排序优化，变成先赋值、再初始化，来提高效率。</li>
<li>如果线程1 先执行了赋值，线程2 执行到第一个 <code>INSTANCE == null</code> 时发现 INSTANCE 已经不为 null，此时就会返回一个未完全构造的对象。</li>
<li>volatile 可以保证静态的变量赋值不能被重排调优，保证构造和赋值的执行顺序。但是这样就损失了一点点重排优化带来的效率。</li>
</ul>
<p>搞懂 volatile 的作用(可见性和有序性)，有序性是通过内存屏障来实现的，可见性是因为使用 volatile 关键字，每次都会从主存中获取数据，而不是 CPU 的缓存中，在写入时会立即同步到主存中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton4</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton4</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;private Singleton4()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">Singleton4</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// 可见性，有序性</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton4 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton4.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton4</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">otherMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;otherMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="内部类懒汉式"><a href="#内部类懒汉式" class="headerlink" title="内部类懒汉式"></a>内部类懒汉式</h4><ul>
<li>避免了双检锁的缺点</li>
<li>使用内部类的方法取代了双检锁的实现方式</li>
<li>缺点就是内部类不能传递参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton5</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton5</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;private Singleton5()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Holder</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="type">Singleton5</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton5</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton5 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">otherMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;otherMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CAS-AtomicReference-懒汉式"><a href="#CAS-AtomicReference-懒汉式" class="headerlink" title="CAS (AtomicReference)懒汉式"></a>CAS (AtomicReference)懒汉式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton6</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicReference&lt;Singleton_06&gt; INSTANCE = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;Singleton_06&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton_06</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton_06 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="type">Singleton_06</span> <span class="variable">instance</span> <span class="operator">=</span> INSTANCE.get();</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != instance) <span class="keyword">return</span> instance;</span><br><span class="line">            INSTANCE.compareAndSet(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Singleton_06</span>());</span><br><span class="line">            <span class="keyword">return</span> INSTANCE.get();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、工厂方法模式"><a href="#2、工厂方法模式" class="headerlink" title="2、工厂方法模式"></a>2、工厂方法模式</h3><h4 id="普通工厂"><a href="#普通工厂" class="headerlink" title="普通工厂"></a>普通工厂</h4><p>工厂模式又称工厂方法模式，是一种创建型设计模式，其在父类中提供一个创建对象的方法，允许子类决定实例化对象的类型。</p>
<p>这种设计模式也是 Java 开发中最常见的一种模式，它的主要意图是定义一个创建对象的接口，让其子类自己决定实例化哪一个工厂类，工厂模式使其创建过程延迟到子类进行。</p>
<p>简单说就是为了提供代码结构的扩展性，屏蔽每一个功能类中的具体实现逻辑。让外部可以更加简单的只是知道调用即可，同时，这也是去掉众多<code>ifelse</code>的方式。当然这可能也有一些缺点，比如需要实现的类非常多，如何去维护，怎样减低开发成本。但这些问题都可以在后续的设计模式结合使用中，逐步降低。</p>
<p>如果要设计一个多种类型商品发放的业务，采用工厂模式实现：</p>
<p><strong>抽象发奖接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICommodity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sendCommodity</span><span class="params">(String uId, String commodityId, String bizId, Map&lt;String, String&gt; extMap)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现奖品发放接口</strong></p>
<p><strong>优惠券</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CouponCommodityService</span> <span class="keyword">implements</span> <span class="title class_">ICommodity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(CouponCommodityService.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">CouponService</span> <span class="variable">couponService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CouponService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCommodity</span><span class="params">(String uId, String commodityId, String bizId, Map&lt;String, String&gt; extMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CouponResult</span> <span class="variable">couponResult</span> <span class="operator">=</span> couponService.sendCoupon(uId, commodityId, bizId);</span><br><span class="line">        logger.info(<span class="string">&quot;请求参数[优惠券] =&gt; uId：&#123;&#125; commodityId：&#123;&#125; bizId：&#123;&#125; extMap：&#123;&#125;&quot;</span>, uId, commodityId, bizId, JSON.toJSON(extMap));</span><br><span class="line">        logger.info(<span class="string">&quot;测试结果[优惠券]：&#123;&#125;&quot;</span>, JSON.toJSON(couponResult));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;0000&quot;</span>.equals(couponResult.getCode())) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(couponResult.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实物商品</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsCommodityService</span> <span class="keyword">implements</span> <span class="title class_">ICommodity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(GoodsCommodityService.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">GoodsService</span> <span class="variable">goodsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GoodsService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCommodity</span><span class="params">(String uId, String commodityId, String bizId, Map&lt;String, String&gt; extMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DeliverReq</span> <span class="variable">deliverReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverReq</span>();</span><br><span class="line">        deliverReq.setUserName(queryUserName(uId));</span><br><span class="line">        deliverReq.setUserPhone(queryUserPhoneNumber(uId));</span><br><span class="line">        deliverReq.setSku(commodityId);</span><br><span class="line">        deliverReq.setOrderId(bizId);</span><br><span class="line">        deliverReq.setConsigneeUserName(extMap.get(<span class="string">&quot;consigneeUserName&quot;</span>));</span><br><span class="line">        deliverReq.setConsigneeUserPhone(extMap.get(<span class="string">&quot;consigneeUserPhone&quot;</span>));</span><br><span class="line">        deliverReq.setConsigneeUserAddress(extMap.get(<span class="string">&quot;consigneeUserAddress&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> goodsService.deliverGoods(deliverReq);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;请求参数[优惠券] =&gt; uId：&#123;&#125; commodityId：&#123;&#125; bizId：&#123;&#125; extMap：&#123;&#125;&quot;</span>, uId, commodityId, bizId, JSON.toJSON(extMap));</span><br><span class="line">        logger.info(<span class="string">&quot;测试结果[优惠券]：&#123;&#125;&quot;</span>, isSuccess);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isSuccess) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;实物商品发放失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">queryUserName</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;花花&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">queryUserPhoneNumber</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;15200101232&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第三方兑换卡</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CardCommodityService</span> <span class="keyword">implements</span> <span class="title class_">ICommodity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(CardCommodityService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟注入</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">IQiYiCardService</span> <span class="variable">iQiYiCardService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IQiYiCardService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCommodity</span><span class="params">(String uId, String commodityId, String bizId, Map&lt;String, String&gt; extMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> queryUserMobile(uId);</span><br><span class="line">        iQiYiCardService.grantToken(mobile, bizId);</span><br><span class="line">        logger.info(<span class="string">&quot;请求参数[爱奇艺兑换卡] =&gt; uId：&#123;&#125; commodityId：&#123;&#125; bizId：&#123;&#125; extMap：&#123;&#125;&quot;</span>, uId, commodityId, bizId, JSON.toJSON(extMap));</span><br><span class="line">        logger.info(<span class="string">&quot;测试结果[爱奇艺兑换卡]：success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">queryUserMobile</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;15200101232&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p><strong>创建商店工厂</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StoreFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ICommodity <span class="title function_">getCommodityService</span><span class="params">(Integer commodityType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == commodityType) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == commodityType) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CouponCommodityService</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">2</span> == commodityType) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GoodsCommodityService</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">3</span> == commodityType) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CardCommodityService</span>();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;不存在的商品服务类型&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h4><p>抽象工厂模式与工厂方法模式虽然主要意图都是为了解决，<strong>接口选择</strong>问题。但在实现上，抽象工厂是一个中心工厂，创建其他工厂的模式。</p>
<p>抽象工厂和普通工厂的区别：</p>
<ul>
<li><p>抽象工厂和普通工厂的区别主要在于，抽象工厂可以生产一组相关或相互依赖的产品，而普通工厂只能生产单一的产品。</p>
</li>
<li><p>例如，假设有一个电脑工厂，它可以生产电脑的各种配件，如CPU、内存、硬盘等。如果使用普通工厂模式，那么每种配件都需要一个单独的工厂来生产，这样会导致工厂类过多，不利于管理和扩展。</p>
</li>
<li><p>如果使用抽象工厂模式，那么可以将电脑配件按照品牌或者类型进行分组，每个分组对应一个抽象工厂，这样就可以减少工厂类的数量，同时也方便增加新的分组或者新的产品。</p>
</li>
<li><p>例如，可以按照品牌分为戴尔、惠普、联想等抽象工厂，每个抽象工厂可以生产该品牌的CPU、内存、硬盘等产品；也可以按照类型分为CPU工厂、内存工厂、硬盘工厂等抽象工厂，每个抽象工厂可以生产不同品牌的同类产品。</p>
</li>
</ul>
<p>业务场景：使用抽像工厂模式替换Redis双集群升级，代理类抽象场景。使用到了(适配器模式，代理模式，抽象工厂模式)</p>
<p>不同的Redis集群可能方法不一样，<strong>创建适配器接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">get</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value, <span class="type">long</span> timeout, TimeUnit timeUnit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现集群使用服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EGMCacheAdapter</span> <span class="keyword">implements</span> <span class="title class_">ICacheAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">EGM</span> <span class="variable">egm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EGM</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> egm.gain(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        egm.set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value, <span class="type">long</span> timeout, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        egm.setEx(key, value, timeout, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        egm.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IIRCacheAdapter</span> <span class="keyword">implements</span> <span class="title class_">ICacheAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">IIR</span> <span class="variable">iir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IIR</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iir.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        iir.set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value, <span class="type">long</span> timeout, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        iir.setExpire(key, value, timeout, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        iir.del(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>定义抽象工厂代理类和实现</strong></p>
<p>创建获取代理对象的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class&lt;T&gt; interfaceClass, ICacheAdapter cacheAdapter)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JDKInvocationHandler</span>(cacheAdapter);</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">    Class&lt;?&gt;[] classes = interfaceClass.getInterfaces();</span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(classLoader, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;classes[<span class="number">0</span>]&#125;, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDKInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICacheAdapter cacheAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JDKInvocationHandler</span><span class="params">(ICacheAdapter cacheAdapter)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cacheAdapter = cacheAdapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> ICacheAdapter.class.getMethod(method.getName(), ClassLoaderUtils.getClazzByArgs(args)).invoke(cacheAdapter, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、建造者模式"><a href="#3、建造者模式" class="headerlink" title="3、建造者模式"></a>3、建造者模式</h3><p>建造者模式所完成的内容就是通过将多个简单对象通过一步步的组装构建出一个复杂对象的过程。</p>
<p>建造者模式主要的实现方法就是让 set() 方法返回当前对象，这样就可以一直使用 set() 方法进行构建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DecorationPackageMenu</span> <span class="keyword">implements</span> <span class="title class_">IMenu</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Matter&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Matter&gt;();  <span class="comment">// 装修清单</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> BigDecimal.ZERO;      <span class="comment">// 装修价格</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal area;  <span class="comment">// 面积</span></span><br><span class="line">    <span class="keyword">private</span> String grade;     <span class="comment">// 装修等级；豪华欧式、轻奢田园、现代简约</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DecorationPackageMenu</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DecorationPackageMenu</span><span class="params">(Double area, String grade)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.area = <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(area);</span><br><span class="line">        <span class="built_in">this</span>.grade = grade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IMenu <span class="title function_">appendCeiling</span><span class="params">(Matter matter)</span> &#123;</span><br><span class="line">        list.add(matter);</span><br><span class="line">        price = price.add(area.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.2&quot;</span>)).multiply(matter.price()));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IMenu <span class="title function_">appendCoat</span><span class="params">(Matter matter)</span> &#123;</span><br><span class="line">        list.add(matter);</span><br><span class="line">        price = price.add(area.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;1.4&quot;</span>)).multiply(matter.price()));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IMenu <span class="title function_">appendFloor</span><span class="params">(Matter matter)</span> &#123;</span><br><span class="line">        list.add(matter);</span><br><span class="line">        price = price.add(area.multiply(matter.price()));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IMenu <span class="title function_">appendTile</span><span class="params">(Matter matter)</span> &#123;</span><br><span class="line">        list.add(matter);</span><br><span class="line">        price = price.add(area.multiply(matter.price()));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、原型模式"><a href="#4、原型模式" class="headerlink" title="4、原型模式"></a>4、原型模式</h3><ul>
<li><p>原型模式是一种创建型设计模式，它的目的是通过复制一个已有的对象来创建新的对象，而不是通过调用构造函数来实例化。</p>
</li>
<li><p>原型模式的优点是可以避免重复的初始化操作，提高性能和效率；也可以逃避构造函数的约束，实现动态创建对象。</p>
</li>
<li><p>原型模式的缺点是需要实现克隆方法，这可能会比较复杂，特别是当对象包含引用类型的属性时，需要考虑浅拷贝和深拷贝的问题。</p>
</li>
<li><p>原型模式的应用场景有：资源优化，类初始化消耗较多资源时；性能和安全要求高，通过 new 产生对象需要非常繁琐或权限受限时；一个对象需要提供给其他对象访问，且各个调用者可能修改其值时。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//抽象原型类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Prototype</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="comment">//抽象方法，子类实现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重写clone()方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Prototype <span class="title function_">clone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Prototype</span> <span class="variable">prototype</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            prototype = (Prototype) <span class="built_in">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> prototype;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类定义了一个抽象方法 show ()，让子类实现；并且重写了 clone () 方法，调用了父类 Object 的 clone () 方法，来实现对象的复制。</p>
<p>下面是两个具体的原型子类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//具体原型类A</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcretePrototypeA</span> <span class="keyword">extends</span> <span class="title class_">Prototype</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;原型A&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//具体原型类B</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcretePrototypeB</span> <span class="keyword">extends</span> <span class="title class_">Prototype</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;原型B&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个原型A对象</span></span><br><span class="line">        <span class="type">Prototype</span> <span class="variable">prototypeA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcretePrototypeA</span>();</span><br><span class="line">        <span class="comment">//调用原型A对象的show()方法</span></span><br><span class="line">        prototypeA.show();</span><br><span class="line">        <span class="comment">//复制出一个原型A对象，并赋值给prototypeCopyA</span></span><br><span class="line">        <span class="type">Prototype</span> <span class="variable">prototypeCopyA</span> <span class="operator">=</span> prototypeA.clone();</span><br><span class="line">        <span class="comment">//调用复制出的对象的show()方法</span></span><br><span class="line">        prototypeCopyA.show();</span><br><span class="line">        <span class="comment">//比较两个对象是否相同</span></span><br><span class="line">        System.out.println(prototypeA == prototypeCopyA);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建一个原型B对象</span></span><br><span class="line">        <span class="type">Prototype</span> <span class="variable">prototypeB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcretePrototypeB</span>();</span><br><span class="line">        <span class="comment">//调用原型B对象的show()方法</span></span><br><span class="line">        prototypeB.show();</span><br><span class="line">        <span class="comment">//复制出一个原型B对象，并赋值给prototypeCopyB</span></span><br><span class="line">        <span class="type">Prototype</span> <span class="variable">prototypeCopyB</span> <span class="operator">=</span> prototypeB.clone();</span><br><span class="line">        <span class="comment">//调用复制出的对象的show()方法</span></span><br><span class="line">        prototypeCopyB.show();</span><br><span class="line">        <span class="comment">//比较两个对象是否相同</span></span><br><span class="line">        System.out.println(prototypeB == prototypeCopyB);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个测试类创建了两个不同类型的原型对象，并分别调用了它们的 show () 方法。然后，它使用 clone () 方法复制了两个新的对象，并再次调用了它们的 show () 方法。最后，它比较了两对对象是否相同。</p>
<p>运行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">原型A</span><br><span class="line">原型A</span><br><span class="line">false</span><br><span class="line">原型B</span><br><span class="line">原型B</span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<p>可以看到，通过 clone () 方法复制出来的对象和原来的对象具有相同的类型和行为，但是它们不是同一个对象。这就是原型模式的基本用法。</p>
<h2 id="二、结构性模式"><a href="#二、结构性模式" class="headerlink" title="二、结构性模式"></a>二、结构性模式</h2><h3 id="1、适配器模式"><a href="#1、适配器模式" class="headerlink" title="1、适配器模式"></a>1、适配器模式</h3><p>适配器模式是一种结构型设计模式，它可以让两个不兼容的接口能够一起工作。适配器模式的核心是创建一个新的类，这个类实现了目标接口，同时持有被适配接口的引用，然后在目标接口的方法中调用被适配接口的方法，从而实现接口转换。</p>
<p>适配器模式有三种类型：类适配器、对象适配器和接口适配器。</p>
<ul>
<li><code>类适配器</code>是通过继承被适配类和实现目标接口来实现的，这种方式需要修改被适配类的源码，而且只能适配一个类。</li>
<li><code>对象适配器</code>是通过组合被适配对象和实现目标接口来实现的，这种方式不需要修改被适配对象的源码，而且可以适配多个类。</li>
<li><code>接口适配器</code>是通过继承目标接口和抽象类来实现的，这种方式可以让子类只实现需要的方法，而不用实现目标接口的所有方法。</li>
</ul>
<p>一个简单的例子是，假设你有一个220v电压的插座，但是你的笔记本电脑只能使用20v电压。你可以使用一个电源适配器，这个适配器实现了20v电压的接口，同时持有220v电压的对象，然后在20v电压的方法中调用220v电压的方法，并进行一定的转换，从而让你的笔记本电脑可以正常工作。</p>
<h4 id="类适配器-amp-对象适配器"><a href="#类适配器-amp-对象适配器" class="headerlink" title="类适配器&amp;对象适配器"></a>类适配器&amp;对象适配器</h4><p>业务场景：</p>
<p>假设我们还是有一个220v电压的接口和一个20v电压的接口，以及一个220v电压的实现类。我们想要使用一个电源适配器，让我们的笔记本电脑可以使用220v电压的插座。</p>
<p>220v 电压接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Voltage220V</span> &#123;</span><br><span class="line">    <span class="comment">// 输出220v电压</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">output220V</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>220v 电压实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Voltage220VImpl</span> <span class="keyword">implements</span> <span class="title class_">Voltage220V</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">output220V</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">voltage</span> <span class="operator">=</span> <span class="number">220</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;输出&quot;</span> + voltage + <span class="string">&quot;v电压&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> voltage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>20v 电压接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Voltage20V</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出20v电压</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">output20V</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>适配器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang RD</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/7 17:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 电源适配器，继承了被适配类，同时实现了目标接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PowerAdapter</span> <span class="keyword">extends</span> <span class="title class_">Voltage220VImpl</span> <span class="keyword">implements</span> <span class="title class_">Voltage20V</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">output20V</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 调用父类的方法</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">voltage</span> <span class="operator">=</span> output220V();</span><br><span class="line">        <span class="comment">// 进行转换 适配操作</span></span><br><span class="line">        voltage = voltage / <span class="number">11</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;输出&quot;</span> + voltage + <span class="string">&quot;v电压&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> voltage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PowerAdapter</span> <span class="variable">powerAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PowerAdapter</span>();</span><br><span class="line">        powerAdapter.output20V(); <span class="comment">// 输出20v</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口适配器"><a href="#接口适配器" class="headerlink" title="接口适配器"></a>接口适配器</h4><p>业务场景：</p>
<p>假设我们有一个多功能的接口，它有四个方法，分别是打印、扫描、复印和传真。我们想要实现一个只能打印的类，但是我们不想实现接口的其他方法。我们可以使用一个抽象类来实现接口的所有方法，但是不做任何操作，然后让子类继承这个抽象类，并重写需要的方法。</p>
<p>多功能接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MultiFunction</span> &#123;</span><br><span class="line">    <span class="comment">// 打印</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复印</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传真</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fax</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抽象类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAdapter</span> <span class="keyword">implements</span> <span class="title class_">MultiFunction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fax</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只读</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintOnly</span> <span class="keyword">extends</span> <span class="title class_">AbstractAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;print paper&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PrintOnly</span> <span class="variable">printOnly</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintOnly</span>();</span><br><span class="line">        printOnly.print();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、桥接模式"><a href="#2、桥接模式" class="headerlink" title="2、桥接模式"></a>2、桥接模式</h3><p><code>桥接模式</code>是一种结构型设计模式，它可以将一个抽象部分和一个实现部分分离，使它们可以独立地变化。桥接模式的主要目的是解决多层继承导致的类爆炸问题，以及抽象和实现的耦合问题。</p>
<p>桥接模式的核心是创建一个作为桥接的接口，这个接口定义了实现部分的功能，然后让抽象部分持有这个接口的引用，并通过这个引用来调用实现部分的功能。这样，抽象部分和实现部分就可以独立地扩展，而不影响彼此</p>
<p>业务场景：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-7-02.png" alt="场景模拟；多种支付和模式"></p>
<p>实现多支付和多模式的融合。</p>
<p>交接模式模型结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-7-03.png" alt="桥接模式模型结构"></p>
<ul>
<li>左侧<code>Pay</code>是一个抽象类，往下是它的两个支付类型实现；微信支付、支付宝支付。</li>
<li>右侧<code>IPayMode</code>是一个接口，往下是它的两个支付模型；刷脸支付、指纹支付。</li>
<li>那么，<code>支付类型</code> × <code>支付模型</code> &#x3D; 就可以得到相应的组合。</li>
<li><strong>注意</strong>，每种支付方式的不同，刷脸和指纹校验逻辑也有差异，可以使用适配器模式进行处理，这里不是本文重点不做介绍，可以看适配器模式章节。</li>
</ul>
<p><strong>支付类型桥接抽象类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Pay</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Pay.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> IPayMode payMode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pay</span><span class="params">(IPayMode payMode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.payMode = payMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">transfer</span><span class="params">(String uId, String tradeId, BigDecimal amount)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在这个类中定义了支付方式的需要实现的转账接口：<code>transfer</code>，以及桥接接口；<code>IPayMode</code>，并在构造函数中用户方自行选择支付方式。</li>
<li>如果没有接触过此类实现，可以重点关注 <code>IPayMode payMode</code>，这部分是桥接的核心。</li>
</ul>
<p><strong>两个支付类型的实现</strong></p>
<p>微信支付</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxPay</span> <span class="keyword">extends</span> <span class="title class_">Pay</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WxPay</span><span class="params">(IPayMode payMode)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(payMode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">transfer</span><span class="params">(String uId, String tradeId, BigDecimal amount)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;模拟微信渠道支付划账开始。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">security</span> <span class="operator">=</span> payMode.security(uId);</span><br><span class="line">        logger.info(<span class="string">&quot;模拟微信渠道支付风控校验。uId：&#123;&#125; tradeId：&#123;&#125; security：&#123;&#125;&quot;</span>, uId, tradeId, security);</span><br><span class="line">        <span class="keyword">if</span> (!security) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;模拟微信渠道支付划账拦截。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;0001&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">&quot;模拟微信渠道支付划账成功。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0000&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>支付宝支付</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZfbPay</span> <span class="keyword">extends</span> <span class="title class_">Pay</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ZfbPay</span><span class="params">(IPayMode payMode)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(payMode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">transfer</span><span class="params">(String uId, String tradeId, BigDecimal amount)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;模拟支付宝渠道支付划账开始。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">security</span> <span class="operator">=</span> payMode.security(uId);</span><br><span class="line">        logger.info(<span class="string">&quot;模拟支付宝渠道支付风控校验。uId：&#123;&#125; tradeId：&#123;&#125; security：&#123;&#125;&quot;</span>, uId, tradeId, security);</span><br><span class="line">        <span class="keyword">if</span> (!security) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;模拟支付宝渠道支付划账拦截。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;0001&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">&quot;模拟支付宝渠道支付划账成功。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0000&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>定义支付模式接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IPayMode</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">security</span><span class="params">(String uId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>三种支付模式风控(刷脸、指纹、密码)</strong></p>
<p>刷脸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayFaceMode</span> <span class="keyword">implements</span> <span class="title class_">IPayMode</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PayCypher.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">security</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;人脸支付，风控校验脸部识别&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指纹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayFingerprintMode</span> <span class="keyword">implements</span> <span class="title class_">IPayMode</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PayCypher.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">security</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;指纹支付，风控校验指纹信息&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>密码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayCypher</span> <span class="keyword">implements</span> <span class="title class_">IPayMode</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PayCypher.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">security</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;密码支付，风控校验环境安全&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_pay</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;\r\n模拟测试场景；微信支付、人脸方式。&quot;</span>);</span><br><span class="line">    <span class="type">Pay</span> <span class="variable">wxPay</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxPay</span>(<span class="keyword">new</span> <span class="title class_">PayFaceMode</span>());</span><br><span class="line">    wxPay.transfer(<span class="string">&quot;weixin_1092033111&quot;</span>, <span class="string">&quot;100000109893&quot;</span>, <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;\r\n模拟测试场景；支付宝支付、指纹方式。&quot;</span>);</span><br><span class="line">    <span class="type">Pay</span> <span class="variable">zfbPay</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZfbPay</span>(<span class="keyword">new</span> <span class="title class_">PayFingerprintMode</span>());</span><br><span class="line">    zfbPay.transfer(<span class="string">&quot;jlu19dlxo111&quot;</span>,<span class="string">&quot;100000109894&quot;</span>,<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、组合模式"><a href="#3、组合模式" class="headerlink" title="3、组合模式"></a>3、组合模式</h3><p>组合模式可以让服务组节点进行自由组合对外提供服务，例如有三个原子校验功能(<code>A：身份证</code>、<code>B：银行卡</code>、<code>C：手机号</code>)服务并对外提供调用使用。有些调用方需要使用AB组合，有些调用方需要使用到CBA组合，还有一些可能只使用三者中的一个。那么这个时候你就可以使用组合模式进行构建服务，对于不同类型的调用方配置不同的组织关系树，而这个树结构你可以配置到数据库中也可以不断的通过图形界面来控制树结构。</p>
<p>业务场景：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-8-02.png" alt="场景模式；营销决策树"></p>
<p>以上是一个非常简化版的营销规则<code>决策树</code>，根据<code>性别</code>、<code>年龄</code>来发放不同类型的优惠券，来刺激消费起到精准用户促活的目的。</p>
<p>根据条件，选择决策结果。</p>
<p>不用设计模式，代码如下。在后序要求上，要不断添加 <code>if else</code> 维护成本高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EngineController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(EngineController.class);</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">process</span><span class="params">(<span class="keyword">final</span> String userId, <span class="keyword">final</span> String userSex, <span class="keyword">final</span> <span class="type">int</span> userAge)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;ifelse实现方式判断用户结果。userId：&#123;&#125; userSex：&#123;&#125; userAge：&#123;&#125;&quot;</span>, userId, userSex, userAge);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;man&quot;</span>.equals(userSex)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (userAge &lt; <span class="number">25</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;果实A&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (userAge &gt;= <span class="number">25</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;果实B&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;woman&quot;</span>.equals(userSex)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (userAge &lt; <span class="number">25</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;果实C&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (userAge &gt;= <span class="number">25</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;果实D&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <strong>使用组合模式修改</strong>。</p>
<p>模型结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-8-03.png" alt="组合模式模型结构"></p>
<p><strong>树节点逻辑过滤接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogicFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 逻辑决策器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> matterValue          决策值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> treeNodeLineInfoList 决策节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 下一个节点Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Long <span class="title function_">filter</span><span class="params">(String matterValue, List&lt;TreeNodeLink&gt; treeNodeLineInfoList)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取决策值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> decisionMatter 决策物料</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 决策值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">matterValue</span><span class="params">(Long treeId, String userId, Map&lt;String, String&gt; decisionMatter)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义了适配的通用接口，逻辑决策器、获取决策值，让每一个提供决策能力的节点都必须实现此接口，保证统一性。</p>
<p><strong>决策抽象类提供基础服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLogic</span> <span class="keyword">implements</span> <span class="title class_">LogicFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">filter</span><span class="params">(String matterValue, List&lt;TreeNodeLink&gt; treeNodeLinkList)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (TreeNodeLink nodeLine : treeNodeLinkList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (decisionLogic(matterValue, nodeLine)) <span class="keyword">return</span> nodeLine.getNodeIdTo();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">matterValue</span><span class="params">(Long treeId, String userId, Map&lt;String, String&gt; decisionMatter)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">decisionLogic</span><span class="params">(String matterValue, TreeNodeLink nodeLink)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (nodeLink.getRuleLimitType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> matterValue.equals(nodeLink.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &gt; Double.parseDouble(nodeLink.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &lt; Double.parseDouble(nodeLink.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &lt;= Double.parseDouble(nodeLink.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &gt;= Double.parseDouble(nodeLink.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>在抽象方法中实现了接口方法，同时定义了基本的决策方法；<code>1、2、3、4、5</code>，<code>等于、小于、大于、小于等于、大于等于</code>的判断逻辑。</li>
<li>同时定义了抽象方法，让每一个实现接口的类都必须按照规则提供<code>决策值</code>，这个决策值用于做逻辑比对。</li>
</ul>
<p><strong>树节点逻辑实现类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 年龄节点</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAgeFilter</span> <span class="keyword">extends</span> <span class="title class_">BaseLogic</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">matterValue</span><span class="params">(Long treeId, String userId, Map&lt;String, String&gt; decisionMatter)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> decisionMatter.get(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性别节点</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserGenderFilter</span> <span class="keyword">extends</span> <span class="title class_">BaseLogic</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">matterValue</span><span class="params">(Long treeId, String userId, Map&lt;String, String&gt; decisionMatter)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> decisionMatter.get(<span class="string">&quot;gender&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上两个决策逻辑的节点获取值的方式都非常简单，只是获取用户的入参即可。实际的业务开发可以从数据库、RPC接口、缓存运算等各种方式获取。</li>
</ul>
<p><strong>决策引擎接口定义</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IEngine</span> &#123;</span><br><span class="line"></span><br><span class="line">    EngineResult <span class="title function_">process</span><span class="params">(<span class="keyword">final</span> Long treeId, <span class="keyword">final</span> String userId, TreeRich treeRich, <span class="keyword">final</span> Map&lt;String, String&gt; decisionMatter)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对于使用方来说也同样需要定义统一的接口操作，这样的好处非常方便后续拓展出不同类型的决策引擎，也就是可以建造不同的决策工厂。</li>
</ul>
<p>决策节点的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EngineConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Map&lt;String, LogicFilter&gt; logicFilterMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        logicFilterMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        logicFilterMap.put(<span class="string">&quot;userAge&quot;</span>, <span class="keyword">new</span> <span class="title class_">UserAgeFilter</span>());</span><br><span class="line">        logicFilterMap.put(<span class="string">&quot;userGender&quot;</span>, <span class="keyword">new</span> <span class="title class_">UserGenderFilter</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, LogicFilter&gt; <span class="title function_">getLogicFilterMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> logicFilterMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogicFilterMap</span><span class="params">(Map&lt;String, LogicFilter&gt; logicFilterMap)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.logicFilterMap = logicFilterMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在这里将可提供服务的决策节点配置到<code>map</code>结构中，对于这样的<code>map</code>结构可以抽取到数据库中，那么就可以非常方便的管理。</li>
</ul>
<p>基础决策引擎配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">EngineBase</span> <span class="keyword">extends</span> <span class="title class_">EngineConfig</span> <span class="keyword">implements</span> <span class="title class_">IEngine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(EngineBase.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> EngineResult <span class="title function_">process</span><span class="params">(Long treeId, String userId, TreeRich treeRich, Map&lt;String, String&gt; decisionMatter)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> TreeNode <span class="title function_">engineDecisionMaker</span><span class="params">(TreeRich treeRich, Long treeId, String userId, Map&lt;String, String&gt; decisionMatter)</span> &#123;</span><br><span class="line">        <span class="type">TreeRoot</span> <span class="variable">treeRoot</span> <span class="operator">=</span> treeRich.getTreeRoot();</span><br><span class="line">        Map&lt;Long, TreeNode&gt; treeNodeMap = treeRich.getTreeNodeMap();</span><br><span class="line">        <span class="comment">// 规则树根ID</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">rootNodeId</span> <span class="operator">=</span> treeRoot.getTreeRootNodeId();</span><br><span class="line">        <span class="type">TreeNode</span> <span class="variable">treeNodeInfo</span> <span class="operator">=</span> treeNodeMap.get(rootNodeId);</span><br><span class="line">        <span class="comment">//节点类型[NodeType]；1子叶、2果实</span></span><br><span class="line">        <span class="keyword">while</span> (treeNodeInfo.getNodeType().equals(<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ruleKey</span> <span class="operator">=</span> treeNodeInfo.getRuleKey();</span><br><span class="line">            <span class="type">LogicFilter</span> <span class="variable">logicFilter</span> <span class="operator">=</span> logicFilterMap.get(ruleKey);</span><br><span class="line">            <span class="type">String</span> <span class="variable">matterValue</span> <span class="operator">=</span> logicFilter.matterValue(treeId, userId, decisionMatter);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">nextNode</span> <span class="operator">=</span> logicFilter.filter(matterValue, treeNodeInfo.getTreeNodeLinkList());</span><br><span class="line">            treeNodeInfo = treeNodeMap.get(nextNode);</span><br><span class="line">            logger.info(<span class="string">&quot;决策树引擎=&gt;&#123;&#125; userId：&#123;&#125; treeId：&#123;&#125; treeNode：&#123;&#125; ruleKey：&#123;&#125; matterValue：&#123;&#125;&quot;</span>, treeRoot.getTreeName(), userId, treeId, treeNodeInfo.getTreeNodeId(), ruleKey, matterValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> treeNodeInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里主要提供决策树流程的处理过程，有点像通过链路的关系(<code>性别</code>、<code>年龄</code>)在二叉树中寻找果实节点的过程。</li>
<li>同时提供一个抽象方法，执行决策流程的方法供外部去做具体的实现。</li>
</ul>
<p><strong>决策引擎的实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeEngineHandle</span> <span class="keyword">extends</span> <span class="title class_">EngineBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EngineResult <span class="title function_">process</span><span class="params">(Long treeId, String userId, TreeRich treeRich, Map&lt;String, String&gt; decisionMatter)</span> &#123;</span><br><span class="line">        <span class="comment">// 决策流程</span></span><br><span class="line">        <span class="type">TreeNode</span> <span class="variable">treeNode</span> <span class="operator">=</span> engineDecisionMaker(treeRich, treeId, userId, decisionMatter);</span><br><span class="line">        <span class="comment">// 决策结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EngineResult</span>(userId, treeId, treeNode.getTreeNodeId(), treeNode.getNodeValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、装饰器模式"><a href="#4、装饰器模式" class="headerlink" title="4、装饰器模式"></a>4、装饰器模式</h3><p>装饰器的核心就是<strong>在不改原有类的基础上给类新增功能</strong>。</p>
<p><strong>不改变原有类</strong>，通过继承、AOP切面，当然这些方式都可以实现，但是使用装饰器模式会是另外一种思路更为灵活，可以避免继承导致的子类过多，也可以避免AOP带来的复杂性。</p>
<p>业务场景：SSO 单点登录功能拓展，增加拦截用户访问方法范围场景</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-9-02.png" alt="场景模拟；单点登录功能扩展"></p>
<p>一般使用的使用的<code>SSO</code>是一个组件化通用的服务，不能在里面添加需要的用户访问验证功能。这个时候我们就可以使用装饰器模式，扩充原有的单点登录服务。但同时也保证原有功能不受破坏，可以继续使用。</p>
<ul>
<li>这里模拟的是spring中的类：<code>HandlerInterceptor</code>，实现接口功能<code>SsoInterceptor</code>模拟的单点登录拦截服务。</li>
<li>为了避免引入太多spring的内容影响对设计模式的阅读，这里使用了同名的类和方法，尽可能减少外部的依赖。</li>
</ul>
<p>模拟 Spring 的 HandlerInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(String request, String response, Object handler)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟单点登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SsoInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(String request, String response, Object handler)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟获取cookie</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ticket</span> <span class="operator">=</span> request.substring(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// 模拟校验</span></span><br><span class="line">        <span class="keyword">return</span> ticket.equals(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">&#125;                                                                                                       </span><br></pre></td></tr></table></figure>

<ul>
<li>这里的模拟实现非常简单只是截取字符串，实际使用需要从<code>HttpServletRequest request</code>对象中获取<code>cookie</code>信息，解析<code>ticket</code>值做校验。</li>
<li>在返回的里面也非常简单，只要获取到了<code>success</code>就认为是允许登录。</li>
</ul>
<p>通过继承的一般实现方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginSsoDecorator</span> <span class="keyword">extends</span> <span class="title class_">SsoInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; authMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        authMap.put(<span class="string">&quot;huahua&quot;</span>, <span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">        authMap.put(<span class="string">&quot;doudou&quot;</span>, <span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(String request, String response, Object handler)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟获取cookie</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ticket</span> <span class="operator">=</span> request.substring(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// 模拟校验</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> ticket.equals(<span class="string">&quot;success&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!success) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> request.substring(<span class="number">9</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> authMap.get(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟方法校验</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;queryUserInfo&quot;</span>.equals(method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上这部分通过继承重写方法，将个人可访问哪些方法的功能添加到方法中。</li>
<li>以上看着代码还算比较清晰，但如果是比较复杂的业务流程代码，就会很混乱。</li>
</ul>
<p>使用装饰器模式重构代码：</p>
<p>装饰器主要解决的是直接继承下因功能的不断横向扩展导致子类膨胀的问题，而是用装饰器模式后就会比直接继承显得更加灵活同时这样也就不再需要考虑子类的维护。</p>
<p>在装饰器模式中有四个比较重要点抽象出来的点；</p>
<ol>
<li>抽象构件角色(Component) - <code>定义抽象接口</code></li>
<li>具体构件角色(ConcreteComponent) - <code>实现抽象接口，可以是一组</code></li>
<li>装饰角色(Decorator) - <code>定义抽象类并继承接口中的方法，保证一致性</code></li>
<li>具体装饰角色(ConcreteDecorator) - <code>扩展装饰具体的实现逻辑</code></li>
</ol>
<p>通过以上这四项来实现装饰器模式，主要核心内容会体现在抽象类的定义和实现上。</p>
<p>模型结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-9-03.png" alt="装饰器模式模型结构"></p>
<ul>
<li>以上是一个装饰器实现的类图结构，重点的类是<code>SsoDecorator</code>，这个类是一个抽象类主要完成了对接口<code>HandlerInterceptor</code>继承。</li>
<li>当装饰角色继承接口后会提供构造函数，入参就是继承的接口实现类即可，这样就可以很方便的扩展出不同功能组件。</li>
</ul>
<p>抽象类装饰角色：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SsoDecorator</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HandlerInterceptor handlerInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SsoDecorator</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SsoDecorator</span><span class="params">(HandlerInterceptor handlerInterceptor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.handlerInterceptor = handlerInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(String request, String response, Object handler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handlerInterceptor.preHandle(request, response, handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在装饰类中有两个重点的地方是；1)继承了处理接口、2)提供了构造函数、3)覆盖了方法<code>preHandle</code>。</li>
<li>以上三个点是装饰器模式的核心处理部分，这样可以踢掉对子类继承的方式实现逻辑功能扩展。</li>
</ul>
<p>装饰器角色逻辑实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginSsoDecorator</span> <span class="keyword">extends</span> <span class="title class_">SsoDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(LoginSsoDecorator.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; authMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        authMap.put(<span class="string">&quot;huahua&quot;</span>, <span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">        authMap.put(<span class="string">&quot;doudou&quot;</span>, <span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginSsoDecorator</span><span class="params">(HandlerInterceptor handlerInterceptor)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(handlerInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(String request, String response, Object handler)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="built_in">super</span>.preHandle(request, response, handler);</span><br><span class="line">        <span class="keyword">if</span> (!success) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> request.substring(<span class="number">8</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> authMap.get(userId);</span><br><span class="line">        logger.info(<span class="string">&quot;模拟单点登录方法访问拦截校验：&#123;&#125; &#123;&#125;&quot;</span>, userId, method);</span><br><span class="line">        <span class="comment">// 模拟方法校验</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;queryUserInfo&quot;</span>.equals(method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在具体的装饰类实现中，继承了装饰类<code>SsoDecorator</code>，那么现在就可以扩展方法；<code>preHandle</code></li>
<li>在<code>preHandle</code>的实现中可以看到，这里只关心扩展部分的功能，同时不会影响原有类的核心服务，也不会因为使用继承方式而导致的多余子类，增加了整体的灵活性。</li>
</ul>
<p>总结：</p>
<ul>
<li>使用装饰器模式满足单一职责原则，你可以在自己的装饰类中完成功能逻辑的扩展，而不影响主类，同时可以按需在运行时添加和删除这部分逻辑。另外装饰器模式与继承父类重写方法，在某些时候需要按需选择，并不一定某一个就是最好。</li>
<li>装饰器实现的重点是对抽象类继承接口方式的使用，同时设定被继承的接口可以通过构造函数传递其实现类，由此增加扩展性并重写方法里可以实现此部分父类实现的功能。</li>
<li>就像夏天热你穿短裤，冬天冷你穿棉裤，雨天挨浇你穿雨衣一样，你的根本本身没有被改变，而你的需求却被不同的装饰而实现。生活中往往比比皆是设计，当你可以融合这部分活灵活现的例子到代码实现中，往往会创造出更加优雅的实现方式。</li>
</ul>
<h3 id="5、外观模式"><a href="#5、外观模式" class="headerlink" title="5、外观模式"></a>5、外观模式</h3><p>外观模式也叫门面模式，主要解决的是降低调用方的使用接口的复杂逻辑组合。这样调用方与实际的接口提供方提供方提供了一个中间层，用于包装逻辑提供API接口。有些时候外观模式也被用在中间件层，对服务中的通用性复杂逻辑进行中间件层包装，让使用方可以只关心业务开发。</p>
<p><strong>业务场景</strong>：</p>
<p>给服务接口加上白名单。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-10-02.png" alt="场景模拟；所有服务添加白名单校验"></p>
<p>定义基础的查询接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key：需要从入参取值的属性字段，如果是对象则从对象中取值，如果是单个值则直接使用</span></span><br><span class="line"><span class="comment">     * returnJson：预设拦截时返回值，是返回对象的Json</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/api/queryUserInfo?userId=1001</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/api/queryUserInfo?userId=小团团</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/api/queryUserInfo&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> UserInfo <span class="title function_">queryUserInfo</span><span class="params">(<span class="meta">@RequestParam</span> String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>(<span class="string">&quot;虫虫:&quot;</span> + userId, <span class="number">19</span>, <span class="string">&quot;天津市南开区旮旯胡同100号&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里提供了一个基本的查询服务，通过入参<code>userId</code>，查询用户信息。后续就需要在这里扩展白名单，只有指定用户才可以查询，其他用户不能查询。</li>
</ul>
<p>使用外观器模式来进行代码优化，也算是一次很小的重构。</p>
<p>这次重构的核心是使用外观模式也可以说门面模式，结合<code>SpringBoot</code>中的自定义<code>starter</code>中间件开发的方式，统一处理所有需要白名单的地方。</p>
<p>后续接下来的实现中，会涉及的知识；</p>
<ol>
<li>SpringBoot的starter中间件开发方式。</li>
<li>面向切面编程和自定义注解的使用。</li>
<li>外部自定义配置信息的透传，SpringBoot与Spring不同，对于此类方式获取白名单配置存在差异。</li>
</ol>
<p>结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-10-03.png" alt="门面模式模型结构"></p>
<ul>
<li>以上是外观模式的中间件实现思路，右侧是为了获取配置文件，左侧是对于切面的处理。</li>
<li>门面模式可以是对接口的包装提供出接口服务，也可以是对逻辑的包装通过自定义注解对接口提供服务能力。</li>
</ul>
<p>服务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarterService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userStr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StarterService</span><span class="params">(String userStr)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userStr = userStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] split(String separatorChar) &#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.split(<span class="built_in">this</span>.userStr, separatorChar);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上类的内容较简单只是为了获取配置信息。</li>
</ul>
<p>配置类注解定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(&quot;itstack.door&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarterServiceProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userStr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserStr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserStr</span><span class="params">(String userStr)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userStr = userStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>用于定义好后续在 <code>application.yml</code> 中添加 <code>itstack.door</code> 的配置信息。</li>
</ul>
<p>自定义配置类信息获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(StarterService.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(StarterServiceProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarterAutoConfigure</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StarterServiceProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;itstack.door&quot;, value = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    StarterService <span class="title function_">starterService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StarterService</span>(properties.getUserStr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上代码是对配置的获取操作，主要是对注解的定义；<code>@Configuration</code>、<code>@ConditionalOnClass</code>、<code>@EnableConfigurationProperties</code>，这一部分主要是与SpringBoot的结合使用。</li>
</ul>
<p>切面注解定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DoDoor &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">key</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">returnJson</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义了外观模式门面注解，后续就是此注解添加到需要扩展白名单的方法上。</li>
<li>这里提供了两个入参，<strong>key</strong>：获取某个字段例如用户ID、<strong>returnJson</strong>：确定白名单拦截后返回的具体内容。</li>
</ul>
<p>白名单切片逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DoJoinPoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(DoJoinPoint.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StarterService starterService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(org.itstack.demo.design.door.annotation.DoDoor)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aopPoint</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;aopPoint()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doRouter</span><span class="params">(ProceedingJoinPoint jp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//获取内容</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> getMethod(jp);</span><br><span class="line">        <span class="type">DoDoor</span> <span class="variable">door</span> <span class="operator">=</span> method.getAnnotation(DoDoor.class);</span><br><span class="line">        <span class="comment">//获取字段值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">keyValue</span> <span class="operator">=</span> getFiledValue(door.key(), jp.getArgs());</span><br><span class="line">        logger.info(<span class="string">&quot;itstack door handler method：&#123;&#125; value：&#123;&#125;&quot;</span>, method.getName(), keyValue);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == keyValue || <span class="string">&quot;&quot;</span>.equals(keyValue)) <span class="keyword">return</span> jp.proceed();</span><br><span class="line">        <span class="comment">//配置内容</span></span><br><span class="line">        String[] split = starterService.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="comment">//白名单过滤</span></span><br><span class="line">        <span class="keyword">for</span> (String str : split) &#123;</span><br><span class="line">            <span class="keyword">if</span> (keyValue.equals(str)) &#123;</span><br><span class="line">                <span class="keyword">return</span> jp.proceed();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//拦截</span></span><br><span class="line">        <span class="keyword">return</span> returnObject(door, method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Method <span class="title function_">getMethod</span><span class="params">(JoinPoint jp)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">sig</span> <span class="operator">=</span> jp.getSignature();</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) sig;</span><br><span class="line">        <span class="keyword">return</span> getClass(jp).getMethod(methodSignature.getName(), methodSignature.getParameterTypes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt; getClass(JoinPoint jp) <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">return</span> jp.getTarget().getClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回对象</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">returnObject</span><span class="params">(DoDoor doGate, Method method)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException &#123;</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        <span class="type">String</span> <span class="variable">returnJson</span> <span class="operator">=</span> doGate.returnJson();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(returnJson)) &#123;</span><br><span class="line">            <span class="keyword">return</span> returnType.newInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(returnJson, returnType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取属性值</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFiledValue</span><span class="params">(String filed, Object[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filedValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == filedValue || <span class="string">&quot;&quot;</span>.equals(filedValue)) &#123;</span><br><span class="line">                    filedValue = BeanUtils.getProperty(arg, filed);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> args[<span class="number">0</span>].toString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filedValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里包括的内容较多，核心逻辑主要是；<code>Object doRouter(ProceedingJoinPoint jp)</code>，接下来我们分别介绍。</li>
</ul>
<p><strong>@Pointcut(“@annotation(org.itstack.demo.design.door.annotation.DoDoor)”)</strong></p>
<p>定义切面，这里采用的是注解路径，也就是所有的加入这个注解的方法都会被切面进行管理。</p>
<p><strong>getFiledValue</strong></p>
<p>获取指定key也就是获取入参中的某个属性，这里主要是获取用户ID，通过ID进行拦截校验。</p>
<p><strong>returnObject</strong></p>
<p>返回拦截后的转换对象，也就是说当非白名单用户访问时则返回一些提示信息。</p>
<p><strong>doRouter</strong></p>
<p>切面核心逻辑，这一部分主要是判断当前访问的用户ID是否白名单用户，如果是则放行<code>jp.proceed();</code>，否则返回自定义的拦截提示信息。</p>
<p>总结：</p>
<ul>
<li>以上我们通过中间件的方式实现外观模式，这样的设计可以很好的增强代码的隔离性，以及复用性，不仅使用上非常灵活也降低了每一个系统都开发这样的服务带来的风险。</li>
<li>可能目前你看这只是非常简单的白名单控制，是否需要这样的处理。但往往一个小小的开始会影响着后续无限的扩展，实际的业务开发往往也要复杂的很多，不可能如此简单。因而使用设计模式来让代码结构更加干净整洁。</li>
</ul>
<h3 id="6、享元模式"><a href="#6、享元模式" class="headerlink" title="6、享元模式"></a>6、享元模式</h3><p>享元模式，主要在于共享通用对象，减少内存的使用，提升系统的访问效率。而这部分共享对象通常比较耗费内存或者需要查询大量接口或者使用数据库资源，因此统一抽离作为共享对象使用。</p>
<p>另外享元模式可以分为在服务端和客户端，一般互联网H5和Web场景下大部分数据都需要服务端进行处理，比如数据库连接池的使用、多线程线程池的使用，除了这些功能外，还有些需要服务端进行包装后的处理下发给客户端，因为服务端需要做享元处理。但在一些游戏场景下，很多都是客户端需要进行渲染地图效果，比如；树木、花草、鱼虫，通过设置不同元素描述使用享元公用对象，减少内存的占用，让客户端的游戏更加流畅。</p>
<p>在享元模型的实现中需要使用到享元工厂来进行管理这部分独立的对象和共享的对象，避免出现线程安全的问题。</p>
<p><strong>业务场景</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-11-02.png" alt="场景模拟；秒杀场景下商品查询"></p>
<p>模拟秒杀场景</p>
<p>模拟使用享元模式工厂结构，提供活动商品的查询。活动商品相当于不变的信息，而库存部分属于变化的信息。</p>
<p>屎山代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Activity <span class="title function_">queryActivityInfo</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟从实际业务应用从接口中获取活动信息</span></span><br><span class="line">        <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Activity</span>();</span><br><span class="line">        activity.setId(<span class="number">10001L</span>);</span><br><span class="line">        activity.setName(<span class="string">&quot;图书嗨乐&quot;</span>);</span><br><span class="line">        activity.setDesc(<span class="string">&quot;图书优惠券分享激励分享活动第二期&quot;</span>);</span><br><span class="line">        activity.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        activity.setStopTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        activity.setStock(<span class="keyword">new</span> <span class="title class_">Stock</span>(<span class="number">1000</span>,<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最开始的业务需求，数据库可以抗住并发的购物量。</li>
<li>之后业务发展拓展的代码交给redis处理</li>
</ul>
<p><strong>使用享元模式</strong></p>
<p>享元模式一般情况下使用此结构在平时的开发中并不太多，除了一些线程池、数据库连接池外，再就是游戏场景下的场景渲染。另外这个设计的模式思想是减少内存的使用提升效率，与我们之前使用的<strong>原型模式</strong>通过克隆对象的方式生成复杂对象，减少rpc的调用，都是此类思想。</p>
<p><strong>享元模式结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-11-03.png" alt="享元模式模型结构"></p>
<ul>
<li>模拟查询活动场景的类图结构，左侧构建的是享元工厂，提供固定活动数据的查询，右侧是Redis存放的库存数据。</li>
<li>最终交给活动控制类来处理查询操作，并提供活动的所有信息和库存。因为库存是变化的，所以我们模拟的<code>RedisUtils</code>中设置了定时任务使用库存</li>
</ul>
<p>活动信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;        <span class="comment">// 活动ID</span></span><br><span class="line">    <span class="keyword">private</span> String name;    <span class="comment">// 活动名称</span></span><br><span class="line">    <span class="keyword">private</span> String desc;    <span class="comment">// 活动描述</span></span><br><span class="line">    <span class="keyword">private</span> Date startTime; <span class="comment">// 开始时间</span></span><br><span class="line">    <span class="keyword">private</span> Date stopTime;  <span class="comment">// 结束时间</span></span><br><span class="line">    <span class="keyword">private</span> Stock stock;    <span class="comment">// 活动库存</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...get/set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>库存信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Stock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> total; <span class="comment">// 库存总量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> used;  <span class="comment">// 库存已用</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...get/set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>享元工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Map&lt;Long, Activity&gt; activityMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Long, Activity&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Activity <span class="title function_">getActivity</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> activityMap.get(id);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == activity) &#123;</span><br><span class="line">            <span class="comment">// 模拟从实际业务应用从接口中获取活动信息</span></span><br><span class="line">            activity = <span class="keyword">new</span> <span class="title class_">Activity</span>();</span><br><span class="line">            activity.setId(<span class="number">10001L</span>);</span><br><span class="line">            activity.setName(<span class="string">&quot;图书嗨乐&quot;</span>);</span><br><span class="line">            activity.setDesc(<span class="string">&quot;图书优惠券分享激励分享活动第二期&quot;</span>);</span><br><span class="line">            activity.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            activity.setStopTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            activityMap.put(id, activity);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里提供的是一个享元工厂🏭，通过<code>map</code>结构存放已经从库表或者接口中查询到的数据，存放到内存中，用于下次可以直接获取。</li>
<li>这样的结构一般在我们的编程开发中还是比较常见的，当然也有些时候为了分布式的获取，会把数据存放到redis中，可以按需选择。</li>
</ul>
<p>模拟reids</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ScheduledExecutorService</span> <span class="variable">scheduledExecutorService</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">stock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisUtils</span><span class="params">()</span> &#123;</span><br><span class="line">        scheduledExecutorService.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 模拟库存消耗</span></span><br><span class="line">            stock.addAndGet(<span class="number">1</span>);</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">100000</span>, TimeUnit.MICROSECONDS);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStockUsed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stock.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>活动控制类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">RedisUtils</span> <span class="variable">redisUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisUtils</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Activity <span class="title function_">queryActivityInfo</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> ActivityFactory.getActivity(id);</span><br><span class="line">        <span class="comment">// 模拟从Redis中获取库存变化信息</span></span><br><span class="line">        <span class="type">Stock</span> <span class="variable">stock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stock</span>(<span class="number">1000</span>, redisUtils.getStockUsed());</span><br><span class="line">        activity.setStock(stock);</span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在活动控制类中使用了享元工厂获取活动信息，查询后将库存信息在补充上。因为库存信息是变化的，而活动信息是固定不变的。</li>
<li>最终通过统一的控制类就可以把完整包装后的活动信息返回给调用方。</li>
</ul>
<p>总结：</p>
<ul>
<li>关于享元模式的设计可以着重学习享元工厂的设计，在一些有大量重复对象可复用的场景下，使用此场景在服务端减少接口的调用，在客户端减少内存的占用。是这个设计模式的主要应用方式。</li>
<li>另外通过<code>map</code>结构的使用方式也可以看到，使用一个固定id来存放和获取对象，是非常关键的点。而且不只是在享元模式中使用，一些其他工厂模式、适配器模式、组合模式中都可以通过map结构存放服务供外部获取，减少ifelse的判断使用。</li>
<li>当然除了这种设计的减少内存的使用优点外，也有它带来的缺点，在一些复杂的业务处理场景，很不容易区分出内部和外部状态，就像我们活动信息部分与库存变化部分。如果不能很好的拆分，就会把享元工厂设计的非常混乱，难以维护。</li>
</ul>
<h3 id="7、代理模式"><a href="#7、代理模式" class="headerlink" title="7、代理模式"></a>7、代理模式</h3><p>代理模式主要解决的是问题是为某些资源的访问、对象的类的易用操作上提供方便使用的代理服务。而这种设计思想的模式经常会出现在我们的系统中，或者你用到过的组件中，它们都提供给你一种非常简单易用的方式控制原本你需要编写很多代码的进行使用的服务类。</p>
<p>类似这样的场景可以想到；</p>
<ol>
<li>你的数据库访问层面经常会提供一个较为基础的应用，以此来减少应用服务扩容时不至于数据库连接数暴增。</li>
<li>使用过的一些中间件例如；RPC框架，在拿到jar包对接口的描述后，中间件会在服务启动的时候生成对应的代理类，当调用接口的时候，实际是通过代理类发出的socket信息进行通过。</li>
<li>另外像我们常用的<code>MyBatis</code>，基本是定义接口但是不需要写实现类，就可以对<code>xml</code>或者自定义注解里的<code>sql</code>语句进行增删改查操作。</li>
</ol>
<p>业务场景：</p>
<p><strong>模拟实现mybatis-spring中代理类生成部分</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-12-02-16841988792742.png" alt="场景模拟；实现mybatis-spring中代理类生成部分"></p>
<p>模拟实现一个Mybatis中对类的代理过程，也就是只需要定义接口，就可以关联到方法注解中的<code>sql</code>语句完成对数据库的操作。</p>
<p>注意一些知识点；</p>
<ol>
<li><code>BeanDefinitionRegistryPostProcessor</code>，spring的接口类用于处理对bean的定义注册。</li>
<li><code>GenericBeanDefinition</code>，定义bean的信息，在mybatis-spring中使用到的是；<code>ScannedGenericBeanDefinition</code> 略有不同。</li>
<li><code>FactoryBean</code>，用于处理bean工厂的类，这个类非常见。</li>
</ol>
<p><strong>代理模式中间件模型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-12-03.png" alt="代理模式中间件模型结构"></p>
<p>自定义注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Select &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;  <span class="comment">// sql语句</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dao层接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select userName from user where id = #&#123;uId&#125;&quot;)</span></span><br><span class="line">    String <span class="title function_">queryUserInfo</span><span class="params">(String uId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理类定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperFactoryBean</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MapperFactoryBean.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MapperFactoryBean</span><span class="params">(Class&lt;T&gt; mapperInterface)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (proxy, method, args) -&gt; &#123;</span><br><span class="line">            <span class="type">Select</span> <span class="variable">select</span> <span class="operator">=</span> method.getAnnotation(Select.class);</span><br><span class="line">            logger.info(<span class="string">&quot;SQL：&#123;&#125;&quot;</span>, select.value().replace(<span class="string">&quot;#&#123;uId&#125;&quot;</span>, args[<span class="number">0</span>].toString()));</span><br><span class="line">            <span class="keyword">return</span> args[<span class="number">0</span>] + <span class="string">&quot;,小傅哥,bugstack.cn - 沉淀、分享、成长，让自己和他人都能有所收获！&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(<span class="built_in">this</span>.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;mapperInterface&#125;, handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> mapperInterface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果你有阅读过mybatis源码，是可以看到这样的一个类；<code>MapperFactoryBean</code>，这里我们也模拟一个这样的类，在里面实现我们对代理类的定义。</li>
<li>通过继承<code>FactoryBean</code>，提供bean对象，也就是方法；<code>T getObject()</code>。</li>
<li>在方法<code>getObject()</code>中提供类的代理以及模拟对sql语句的处理，这里包含了用户调用dao层方法时候的处理逻辑。</li>
<li>还有最上面我们提供构造函数来透传需要被代理类，<code>Class&lt;T&gt; mapperInterface</code>，在mybatis中也是使用这样的方式进行透传。</li>
<li>另外<code>getObjectType()</code>提供对象类型反馈，以及<code>isSingleton()</code>返回类是单例的。</li>
</ul>
<p>将Bean定义注册到Spring容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterBeanFactory</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">GenericBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericBeanDefinition</span>();</span><br><span class="line">        beanDefinition.setBeanClass(MapperFactoryBean.class);</span><br><span class="line">        beanDefinition.setScope(<span class="string">&quot;singleton&quot;</span>);</span><br><span class="line">        	           			                                                   beanDefinition.getConstructorArgumentValues().addGenericArgumentValue(IUserDao.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanDefinitionHolder</span> <span class="variable">definitionHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDefinition, <span class="string">&quot;userDao&quot;</span>);</span><br><span class="line">        BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory configurableListableBeanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// left intentionally blank</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里我们将代理的bean交给spring容器管理，也就可以非常方便让我们可以获取到代理的bean。这部分是spring中关于一个bean注册过程的源码。</li>
<li><code>GenericBeanDefinition</code>，用于定义一个bean的基本信息<code>setBeanClass(MapperFactoryBean.class);</code>，也包括可以透传给构造函数信息<code>addGenericArgumentValue(IUserDao.class);</code></li>
<li>最后使用 <code>BeanDefinitionReaderUtils.registerBeanDefinition</code>，进行bean的注册，也就是注册到<code>DefaultListableBeanFactory</code>中。</li>
</ul>
<p>配置文件spring-config</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd&quot;</span></span><br><span class="line">       <span class="keyword">default</span>-autowire=<span class="string">&quot;byName&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;userDao&quot;</span> class=<span class="string">&quot;org.itstack.demo.design.agent.RegisterBeanFactory&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_IUserDao</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">BeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-config.xml&quot;</span>);</span><br><span class="line">    <span class="type">IUserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> beanFactory.getBean(<span class="string">&quot;userDao&quot;</span>, IUserDao.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> userDao.queryUserInfo(<span class="string">&quot;100001&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;测试结果：&#123;&#125;&quot;</span>, res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="三、行为型模式"><a href="#三、行为型模式" class="headerlink" title="三、行为型模式"></a>三、行为型模式</h2><h3 id="1、责任链模式"><a href="#1、责任链模式" class="headerlink" title="1、责任链模式"></a>1、责任链模式</h3><p>责任链模式允许将请求沿着一个处理链进行传递，直到有一个处理者能够处理该请求为止。每个处理者都有机会处理请求，但具体由哪个处理者来处理取决于链中的顺序和处理者的能力。</p>
<p>在责任链模式中，通常有一个<code>抽象处理者</code>（Abstract Handler）定义了处理请求的接口和基本行为。每个<code>具体处理者</code>（Concrete Handler）都实现了抽象处理者，并根据自己的能力来判断是否能够处理请求，如果能够处理，则进行处理；如果不能处理，则将请求传递给下一个处理者。</p>
<p>责任链模式的主要优点是：</p>
<ol>
<li>解耦请求发送者和接收者：请求发送者不需要知道具体的接收者是谁，只需将请求发送给第一个处理者即可，实现了请求发送者和接收者的解耦。</li>
<li>灵活性和可扩展性：责任链可以动态地组合和扩展，可以随时添加、删除或修改处理者，以适应不同的业务需求。</li>
<li>可以减少对象之间的直接引用关系：请求者只需持有一个对抽象处理者的引用，而不需要直接引用具体的处理者，降低了对象之间的耦合度。</li>
</ol>
<p>责任链模式适用于以下情况：</p>
<ol>
<li>多个对象可以处理同一种类型的请求，但具体由哪个对象来处理在运行时才能确定。</li>
<li>请求的处理顺序需要动态确定或可配置。</li>
<li>需要在不明确指定接收者的情况下，将请求传递给多个对象中的一个或多个。</li>
</ol>
<p>需要注意的是，责任链模式可能导致请求的未被处理。因此，在设计责任链时，需要合理安排处理者的顺序，确保所有请求都能得到适当的处理，或者提供一个默认的处理者来处理未被处理的请求。</p>
<p><strong>业务案例</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-13-02.png" alt="场景模拟；618大促场景上线审批场景"></p>
<p>模拟系统上线审核场景。</p>
<p>模拟审核服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Date&gt; authMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Date&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title function_">queryAuthInfo</span><span class="params">(String uId, String orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> authMap.get(uId.concat(orderId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">auth</span><span class="params">(String uId, String orderId)</span> &#123;</span><br><span class="line">        authMap.put(uId.concat(orderId), <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里面提供了两个接口一个是查询审核结果(<code>queryAuthInfo</code>)、另外一个是处理审核(<code>auth</code>)。</li>
<li>这部分是把由谁审核的和审核的单子ID作为唯一key值记录到内存Map结构中。</li>
</ul>
<p>常规代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">SimpleDateFormat</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<span class="comment">// 时间格式化</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AuthInfo <span class="title function_">doAuth</span><span class="params">(String uId, String orderId, Date authDate)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 三级审批</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> AuthService.queryAuthInfo(<span class="string">&quot;1000013&quot;</span>, orderId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == date) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：待三级审批负责人 &quot;</span>, <span class="string">&quot;王工&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 二级审批</span></span><br><span class="line">        <span class="keyword">if</span> (authDate.after(f.parse(<span class="string">&quot;2020-06-01 00:00:00&quot;</span>)) &amp;&amp; authDate.before(f.parse(<span class="string">&quot;2020-06-25 23:59:59&quot;</span>))) &#123;</span><br><span class="line">            date = AuthService.queryAuthInfo(<span class="string">&quot;1000012&quot;</span>, orderId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == date) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：待二级审批负责人 &quot;</span>, <span class="string">&quot;张经理&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一级审批</span></span><br><span class="line">        <span class="keyword">if</span> (authDate.after(f.parse(<span class="string">&quot;2020-06-11 00:00:00&quot;</span>)) &amp;&amp; authDate.before(f.parse(<span class="string">&quot;2020-06-20 23:59:59&quot;</span>))) &#123;</span><br><span class="line">            date = AuthService.queryAuthInfo(<span class="string">&quot;1000011&quot;</span>, orderId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == date) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：待一级审批负责人 &quot;</span>, <span class="string">&quot;段总&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：审批完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用责任链完成项目的重构：</p>
<p>责任链模式可以让各个服务模块更加清晰，而每一个模块间可以通过<code>next</code>的方式进行获取。而每一个<code>next</code>是由继承的统一抽象类实现的。最终所有类的职责可以动态的进行编排使用，编排的过程可以做成可配置化。</p>
<p><strong>责任链类图</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-13-03-01.png" alt="责任链类图"></p>
<p><strong>责任链模式模型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-13-03.png" alt="责任链模式模型结构"></p>
<ul>
<li>上图是这个业务模型中责任链结构的核心部分，通过三个实现了统一抽象类<code>AuthLink</code>的不同规则，再进行责任编排模拟出一条链路。这个链路就是业务中的责任链。</li>
<li>一般在使用责任链时候如果是场景比较固定，可以通过写死到代码中进行初始化。但如果业务场景经常变化可以做成xml配置的方式进行处理，也可以落到库里进行初始化操作。</li>
</ul>
<p>责任链中返回对象定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthInfo</span><span class="params">(String code, String ...infos)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="keyword">for</span> (String str:infos)&#123;</span><br><span class="line">            <span class="built_in">this</span>.info = <span class="built_in">this</span>.info.concat(str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...get/set</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这个类的是包装了责任链处理过程中返回结果的类，方面处理每个责任链的返回信息。</li>
</ul>
<p>链路抽象类的定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AuthLink</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AuthLink.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">SimpleDateFormat</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<span class="comment">// 时间格式化</span></span><br><span class="line">    <span class="keyword">protected</span> String levelUserId;                           <span class="comment">// 级别人员ID</span></span><br><span class="line">    <span class="keyword">protected</span> String levelUserName;                         <span class="comment">// 级别人员姓名</span></span><br><span class="line">    <span class="keyword">private</span> AuthLink next;                                  <span class="comment">// 责任链</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthLink</span><span class="params">(String levelUserId, String levelUserName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.levelUserId = levelUserId;</span><br><span class="line">        <span class="built_in">this</span>.levelUserName = levelUserName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AuthLink <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AuthLink <span class="title function_">appendNext</span><span class="params">(AuthLink next)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.next = next;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> AuthInfo <span class="title function_">doAuth</span><span class="params">(String uId, String orderId, Date authDate)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这部分是责任链，<strong>链接起来</strong>的核心部分。<code>AuthLink next</code>，重点在于可以通过<code>next</code>方式获取下一个链路需要处理的节点。</li>
<li><code>levelUserId</code>、<code>levelUserName</code>，是责任链中的公用信息，标记每一个审核节点的人员信息。</li>
<li>抽象类中定义了一个抽象方法，<code>abstract AuthInfo doAuth</code>，这是每一个实现者必须实现的类，不同的审核级别处理不同的业务。</li>
</ul>
<p>三个审核实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Level1AuthLink</span> <span class="keyword">extends</span> <span class="title class_">AuthLink</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Level1AuthLink</span><span class="params">(String levelUserId, String levelUserName)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(levelUserId, levelUserName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AuthInfo <span class="title function_">doAuth</span><span class="params">(String uId, String orderId, Date authDate)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> AuthService.queryAuthInfo(levelUserId, orderId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == date) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：待一级审批负责人 &quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthLink</span> <span class="variable">next</span> <span class="operator">=</span> <span class="built_in">super</span>.next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == next) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：一级审批完成负责人&quot;</span>, <span class="string">&quot; 时间：&quot;</span>, f.format(date), <span class="string">&quot; 审批人：&quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next.doAuth(uId, orderId, authDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Level2AuthLink</span> <span class="keyword">extends</span> <span class="title class_">AuthLink</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Date</span> <span class="variable">beginDate</span> <span class="operator">=</span> f.parse(<span class="string">&quot;2020-06-11 00:00:00&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Date</span> <span class="variable">endDate</span> <span class="operator">=</span> f.parse(<span class="string">&quot;2020-06-20 23:59:59&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Level2AuthLink</span><span class="params">(String levelUserId, String levelUserName)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="built_in">super</span>(levelUserId, levelUserName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AuthInfo <span class="title function_">doAuth</span><span class="params">(String uId, String orderId, Date authDate)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> AuthService.queryAuthInfo(levelUserId, orderId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == date) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：待二级审批负责人 &quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthLink</span> <span class="variable">next</span> <span class="operator">=</span> <span class="built_in">super</span>.next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == next) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：二级审批完成负责人&quot;</span>, <span class="string">&quot; 时间：&quot;</span>, f.format(date), <span class="string">&quot; 审批人：&quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (authDate.before(beginDate) || authDate.after(endDate)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：二级审批完成负责人&quot;</span>, <span class="string">&quot; 时间：&quot;</span>, f.format(date), <span class="string">&quot; 审批人：&quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next.doAuth(uId, orderId, authDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Level3AuthLink</span> <span class="keyword">extends</span> <span class="title class_">AuthLink</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Date</span> <span class="variable">beginDate</span> <span class="operator">=</span> f.parse(<span class="string">&quot;2020-06-01 00:00:00&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Date</span> <span class="variable">endDate</span> <span class="operator">=</span> f.parse(<span class="string">&quot;2020-06-25 23:59:59&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Level3AuthLink</span><span class="params">(String levelUserId, String levelUserName)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="built_in">super</span>(levelUserId, levelUserName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AuthInfo <span class="title function_">doAuth</span><span class="params">(String uId, String orderId, Date authDate)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> AuthService.queryAuthInfo(levelUserId, orderId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == date) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：待三级审批负责人 &quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthLink</span> <span class="variable">next</span> <span class="operator">=</span> <span class="built_in">super</span>.next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == next) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：三级审批负责人完成&quot;</span>, <span class="string">&quot; 时间：&quot;</span>, f.format(date), <span class="string">&quot; 审批人：&quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (authDate.before(beginDate) || authDate.after(endDate)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthInfo</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;单号：&quot;</span>, orderId, <span class="string">&quot; 状态：三级审批负责人完成&quot;</span>, <span class="string">&quot; 时间：&quot;</span>, f.format(date), <span class="string">&quot; 审批人：&quot;</span>, levelUserName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next.doAuth(uId, orderId, authDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>如上三个类；<code>Level1AuthLink</code>、<code>Level2AuthLink</code>、<code>Level3AuthLink</code>，实现了不同的审核级别处理的简单逻辑。</li>
<li>例如第一个审核类中会先判断是否审核通过，如果没有审核通过则返回结果给调用方，引导去审核。<em>（这里简单模拟审核后有时间信息不为空，作为判断条件）</em></li>
<li>判断完成后获取下一个审核节点；<code>super.next();</code>，如果不存在下一个节点，则直接返回结果。</li>
<li>之后是根据不同的业务时间段进行判断是否需要，二级和一级的审核。</li>
<li>最后返回下一个审核结果；<code>next.doAuth(uId, orderId, authDate);</code>，有点像递归调用。</li>
</ul>
<p>总结：</p>
<ul>
<li>在我们前面学习结构性模式中讲到过组合模式，它像是一颗组合树一样，我们搭建出一个流程决策树。其实这样的模式也是可以和责任链模型进行组合扩展使用，而这部分的重点在于如何关联<strong>链路的关联</strong>，最终的执行都是在执行在中间的关系链。</li>
<li>责任链模式很好的处理单一职责和开闭原则，简单了耦合也使对象关系更加清晰，而且外部的调用方并不需要关心责任链是如何进行处理的*(以上程序中可以把责任链的组合进行包装，在提供给外部使用)*。但除了这些优点外也需要是适当的场景才进行使用，避免造成性能以及编排混乱调试测试疏漏问题。</li>
</ul>
<h3 id="2、命令模式"><a href="#2、命令模式" class="headerlink" title="2、命令模式"></a>2、命令模式</h3><p>命令模式（Command Pattern）是一种行为设计模式，它将请求（命令）封装成一个对象，从而使你可以用不同的请求参数化客户端对象，队列或记录请求，并支持可撤销的操作。</p>
<p>在命令模式中，有以下几个核心角色：</p>
<ol>
<li>抽象命令类；声明执行命令的接口和方法</li>
<li>具体的命令实现类；接口类的具体实现，可以是一组相似的行为逻辑</li>
<li>实现者；也就是为命令做实现的具体实现类</li>
<li>调用者；处理命令、实现的具体操作者，负责对外提供命令服务</li>
</ol>
<p>使用命令模式的主要优点是：</p>
<ol>
<li><p>解耦请求发送者和接收者：命令对象将请求发送者和接收者解耦，发送者只需要知道如何发送命令，而无需知道具体如何执行命令。</p>
</li>
<li><p>容易扩展和修改：可以添加新的具体命令类，无需修改调用者和接收者的代码，符合开闭原则。</p>
</li>
<li><p>支持撤销和重做操作：由于命令对象封装了操作，可以轻松实现撤销和重做功能。</p>
</li>
<li><p>支持命令的队列和日志：可以将命令对象放入队列中进行管理，支持撤销、恢复、回滚等操作。</p>
</li>
</ol>
<p>命令模式适用于以下情况：</p>
<ol>
<li><p>需要将请求发送者和接收者解耦，以支持松散耦合的设计。</p>
</li>
<li><p>需要支持撤销、重做、事务等功能。</p>
</li>
<li><p>需要在不同的时间指定、排队和执行请求。</p>
</li>
<li><p>需要将一组操作组合成高层次的操作，形成复杂的操作逻辑。</p>
</li>
</ol>
<p>需要注意的是，命令模式增加了额外的类和对象，可能会导致代码的复杂性增加。因此，在应用命令模式时需要权衡好设计的复杂性和灵活性之间的关系。</p>
<p><strong>业务场景</strong></p>
<p>模拟饭店中在小二这点餐，让对应的厨师进行制作的过程。</p>
<p>常规代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaoEr</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XiaoEr.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, String&gt; cuisineMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;Integer, String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">order</span><span class="params">(<span class="type">int</span> cuisine)</span> &#123;</span><br><span class="line">        <span class="comment">// 广东（粤菜）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == cuisine) &#123;</span><br><span class="line">            cuisineMap.put(<span class="number">1</span>, <span class="string">&quot;广东厨师，烹饪鲁菜，宫廷最大菜系，以孔府风味为龙头&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 江苏（苏菜）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">2</span> == cuisine) &#123;</span><br><span class="line">            cuisineMap.put(<span class="number">2</span>, <span class="string">&quot;江苏厨师，烹饪苏菜，宫廷第二大菜系，古今国宴上最受人欢迎的菜系。&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 山东（鲁菜）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">3</span> == cuisine) &#123;</span><br><span class="line">            cuisineMap.put(<span class="number">3</span>, <span class="string">&quot;山东厨师，烹饪鲁菜，宫廷最大菜系，以孔府风味为龙头.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 四川（川菜）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">4</span> == cuisine) &#123;</span><br><span class="line">            cuisineMap.put(<span class="number">4</span>, <span class="string">&quot;四川厨师，烹饪川菜，中国最有特色的菜系，也是民间最大菜系。&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">placeOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;菜单：&#123;&#125;&quot;</span>, JSON.toJSONString(cuisineMap));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在这个类的实现中提供了两个方法，一个方法用于点单添加菜品<code>order()</code>，另外一个方法展示菜品的信息<code>placeOrder()</code>。</li>
<li>从上面可以看到有比较多的if语句判断类型进行添加菜品，那么对于这样的代码后续就需要大量的经历进行维护，同时可能实际的逻辑要比这复杂的多。都写在这样一个类里会变得耦合的非常严重。</li>
</ul>
<p>命令模式重构代码</p>
<p>命令模式可以将上述的模式拆解三层大块，命令、命令实现者、命令的调用者，当有新的菜品或者厨师扩充时候就可以在指定的类结构下进行实现添加即可，外部的调用也会非常的容易扩展。</p>
<p><strong>命令模式模型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-14-03.png" alt="命令模式模型结构"></p>
<ul>
<li>从上图可以看到整体分为三大块；命令实现(菜品)、逻辑实现(厨师)、调用者(小二)，以上这三面的实现就是命令模式的核心内容。</li>
<li>经过这样的拆解就可以非常方面的扩展菜品、厨师，对于调用者来说这部分都是松耦合的，在整体的框架下可以非常容易加入实现逻辑。</li>
</ul>
<p>抽象命令接口(菜品)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 博客：https://bugstack.cn - 沉淀、分享、成长，让自己和他人都能有所收获！</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈</span></span><br><span class="line"><span class="comment"> * Create by 小傅哥(fustack) @2020</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 菜系</span></span><br><span class="line"><span class="comment"> * 01、山东（鲁菜）——宫廷最大菜系，以孔府风味为龙头。</span></span><br><span class="line"><span class="comment"> * 02、四川（川菜）——中国最有特色的菜系，也是民间最大菜系。</span></span><br><span class="line"><span class="comment"> * 03、江苏（苏菜）——宫廷第二大菜系，古今国宴上最受人欢迎的菜系。</span></span><br><span class="line"><span class="comment"> * 04、广东（粤菜）——国内民间第二大菜系，国外最有影响力的中国菜系，可以代表中国。</span></span><br><span class="line"><span class="comment"> * 05、福建（闽菜）——客家菜的代表菜系。</span></span><br><span class="line"><span class="comment"> * 06、浙江（浙菜）——中国最古老的菜系之一，宫廷第三大菜系。</span></span><br><span class="line"><span class="comment"> * 07、湖南（湘菜）——民间第三大菜系。</span></span><br><span class="line"><span class="comment"> * 08、安徽（徽菜）——徽州文化的典型代表。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICuisine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cook</span><span class="params">()</span>; <span class="comment">// 烹调、制作</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体的命令实现(四种菜品)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuangDoneCuisine</span> <span class="keyword">implements</span> <span class="title class_">ICuisine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICook cook;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GuangDoneCuisine</span><span class="params">(ICook cook)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cook = cook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cook</span><span class="params">()</span> &#123;</span><br><span class="line">        cook.doCooking();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JiangSuCuisine</span> <span class="keyword">implements</span> <span class="title class_">ICuisine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICook cook;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JiangSuCuisine</span><span class="params">(ICook cook)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cook = cook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cook</span><span class="params">()</span> &#123;</span><br><span class="line">        cook.doCooking();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShanDongCuisine</span> <span class="keyword">implements</span> <span class="title class_">ICuisine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICook cook;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ShanDongCuisine</span><span class="params">(ICook cook)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cook = cook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cook</span><span class="params">()</span> &#123;</span><br><span class="line">        cook.doCooking();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SiChuanCuisine</span> <span class="keyword">implements</span> <span class="title class_">ICuisine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICook cook;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SiChuanCuisine</span><span class="params">(ICook cook)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cook = cook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cook</span><span class="params">()</span> &#123;</span><br><span class="line">        cook.doCooking();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>以上是四种菜品的实现，在实现的类中都有添加了一个厨师类(<code>ICook</code>)，并通过这个类提供的方法进行操作命令(烹饪菜品)<code>cook.doCooking()</code>。</li>
<li>命令的实现过程可以是按照逻辑进行添加补充，目前这里抽象的比较简单，只是模拟一个烹饪的过程，相当于同时厨师进行菜品烹饪。</li>
</ul>
<p>抽象实现者接口(厨师)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICook</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doCooking</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现者的具体实现(四类厨师)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuangDongCook</span> <span class="keyword">implements</span> <span class="title class_">ICook</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ICook.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doCooking</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;广东厨师，烹饪鲁菜，宫廷最大菜系，以孔府风味为龙头&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JiangSuCook</span> <span class="keyword">implements</span> <span class="title class_">ICook</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ICook.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doCooking</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;江苏厨师，烹饪苏菜，宫廷第二大菜系，古今国宴上最受人欢迎的菜系。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShanDongCook</span> <span class="keyword">implements</span> <span class="title class_">ICook</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ICook.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doCooking</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;山东厨师，烹饪鲁菜，宫廷最大菜系，以孔府风味为龙头&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SiChuanCook</span> <span class="keyword">implements</span> <span class="title class_">ICook</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ICook.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doCooking</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;四川厨师，烹饪川菜，中国最有特色的菜系，也是民间最大菜系。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用者(店小二)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaoEr</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XiaoEr.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;ICuisine&gt; cuisineList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ICuisine&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">order</span><span class="params">(ICuisine cuisine)</span> &#123;</span><br><span class="line">        cuisineList.add(cuisine);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">placeOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (ICuisine cuisine : cuisineList) &#123;</span><br><span class="line">            cuisine.cook();</span><br><span class="line">        &#125;</span><br><span class="line">        cuisineList.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在调用者的具体实现中，提供了菜品的添加和菜单执行烹饪。这个过程是命令模式的具体调用，通过外部将菜品和厨师传递进来而进行具体的调用.</p>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 菜系 + 厨师；广东（粤菜）、江苏（苏菜）、山东（鲁菜）、四川（川菜）</span></span><br><span class="line">    <span class="type">ICuisine</span> <span class="variable">guangDoneCuisine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuangDoneCuisine</span>(<span class="keyword">new</span> <span class="title class_">GuangDongCook</span>());</span><br><span class="line">    <span class="type">JiangSuCuisine</span> <span class="variable">jiangSuCuisine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JiangSuCuisine</span>(<span class="keyword">new</span> <span class="title class_">JiangSuCook</span>());</span><br><span class="line">    <span class="type">ShanDongCuisine</span> <span class="variable">shanDongCuisine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShanDongCuisine</span>(<span class="keyword">new</span> <span class="title class_">ShanDongCook</span>());</span><br><span class="line">    <span class="type">SiChuanCuisine</span> <span class="variable">siChuanCuisine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SiChuanCuisine</span>(<span class="keyword">new</span> <span class="title class_">SiChuanCook</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点单</span></span><br><span class="line">    <span class="type">XiaoEr</span> <span class="variable">xiaoEr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XiaoEr</span>();</span><br><span class="line">    xiaoEr.order(guangDoneCuisine);</span><br><span class="line">    xiaoEr.order(jiangSuCuisine);</span><br><span class="line">    xiaoEr.order(shanDongCuisine);</span><br><span class="line">    xiaoEr.order(siChuanCuisine);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下单</span></span><br><span class="line">    xiaoEr.placeOrder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里可以主要观察<code>菜品</code>与<code>厨师</code>的组合；<code>new GuangDoneCuisine(new GuangDongCook());</code>，每一个具体的命令都拥有一个对应的实现类，可以进行组合。</li>
<li>当菜品和具体的实现定义完成后，由小二进行操作点单，<code>xiaoEr.order(guangDoneCuisine);</code>，这里分别添加了四种菜品，给小二。</li>
<li>最后是下单，这个是具体命令实现的操作，相当于把小二手里的菜单传递给厨师。当然这里也可以提供删除和撤销，也就是客户取消了自己的某个菜品。</li>
</ul>
<p>总结：</p>
<ul>
<li>命令模式的使用场景需要分为三个比较大的块；<code>命令</code>、<code>实现</code>、<code>调用者</code>，而这三块内容的拆分也是选择适合场景的关键因素，经过这样的拆分可以让逻辑具备单一职责的性质，便于扩展。</li>
<li>通过这样的实现方式与if语句相比，降低了耦合性也方便其他的命令和实现的扩展。但同时这样的设计模式也带来了一点问题，就是在各种命令与实现的组合下，会扩展出很多的实现类，需要进行管理。</li>
</ul>
<h3 id="3、迭代器模式"><a href="#3、迭代器模式" class="headerlink" title="3、迭代器模式"></a>3、迭代器模式</h3><p>迭代器模式，常见的就是我们日常使用的<code>iterator</code>遍历。虽然这个设计模式在我们的实际业务开发中的场景并不多，但却几乎每天都要使用<code>jdk</code>为我们提供的<code>list</code>集合遍历。另外增强的for循环虽然是循环输出数据，但是他不是迭代器模式。迭代器模式的特点是实现<code>Iterable</code>接口，通过<code>next</code>的方式获取集合元素，同时具备对元素的删除等操作。而增强的for循环是不可以的。</p>
<p>这种设计模式的优点是可以让我们以相同的方式，遍历不同的数据结构元素，这些数据结构包括；<code>数组</code>、<code>链表</code>、<code>树</code>等，而用户在使用遍历的时候并不需要去关心每一种数据结构的遍历处理逻辑，从让使用变得统一易用。</p>
<p><strong>业务场景</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-15-02.png" alt="场景模拟；公司树形组织架构"></p>
<p>模拟迭代遍历输出公司中树形结构的组织架构关系中雇员列表</p>
<p>一般我们常用的遍历就是jdk默认提供的方法，对list集合遍历。但是对于这样的偏业务特性较大的树形结构，如果需要使用到遍历，那么就可以自己来实现。接下来我们会把这个组织层次关系通过树形数据结构来实现，并完成迭代器功能。</p>
<p>迭代器模式的结构：</p>
<ol>
<li>Collection，集合方法部分用于对自定义的数据结构添加通用方法；<code>add</code>、<code>remove</code>、<code>iterator</code>等核心方法。</li>
<li>Iterable，提供获取迭代器，这个接口类会被<code>Collection</code>继承。</li>
<li>Iterator，提供了两个方法的定义；<code>hasNext</code>、<code>next</code>，会在具体的数据结构中写实现方式。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-15-03.png" alt="迭代器模式模型结构"></p>
<ul>
<li>左侧是对迭代器的定义，右侧是在数据结构中实现迭代器功能。</li>
<li>左侧部分的实现与jdk中的方式是一样的。</li>
<li>这个遍历方式一个树形结构的深度遍历。</li>
</ul>
<p>雇员实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uId;   <span class="comment">// ID</span></span><br><span class="line">    <span class="keyword">private</span> String name;  <span class="comment">// 姓名</span></span><br><span class="line">    <span class="keyword">private</span> String desc;  <span class="comment">// 备注</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>树节点链路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Link</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String fromId; <span class="comment">// 雇员ID</span></span><br><span class="line">    <span class="keyword">private</span> String toId;   <span class="comment">// 雇员ID    </span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个类用于描述结构树中的各个节点之间的关系链，也就是<code>A to B</code>、<code>B to C</code>、<code>B to D</code>，以此描述出一套完整的树组织结构。</li>
</ul>
<p>迭代器定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    E <span class="title function_">next</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可迭代接口定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Iterable</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个接口中提供了上面迭代器的实现<code>Iterator</code>的获取，也就是后续在自己的数据结构中需要实现迭代器的功能并交给<code>Iterable</code>，由此让外部调用方进行获取使用。</li>
</ul>
<p>集合功能接口的定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Collection</span>&lt;E, L&gt; <span class="keyword">extends</span> <span class="title class_">Iterable</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(E e)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">addLink</span><span class="params">(String key, L l)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">removeLink</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义集合操作接口；<code>Collection</code>，同时继承了另外一个接口<code>Iterable</code>的方法<code>iterator()</code>。这样后续谁来实现这个接口，就需要实现上述定义的一些基本功能；<code>添加元素</code>、<code>删除元素</code>、<code>遍历</code>。</li>
<li>定义了两个泛型<code>&lt;E, L&gt;</code>，因为我们的数据结构一个是用于添加元素，另外一个是用于添加树节点的链路关系。</li>
</ul>
<p>迭代器功能的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupStructure</span> <span class="keyword">implements</span> <span class="title class_">Collection</span>&lt;Employee, Link&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String groupId;                                                 <span class="comment">// 组织ID，也是一个组织链的头部ID</span></span><br><span class="line">    <span class="keyword">private</span> String groupName;                                               <span class="comment">// 组织名称</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Employee&gt; employeeMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Employee&gt;();  <span class="comment">// 雇员列表</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;Link&gt;&gt; linkMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, List&lt;Link&gt;&gt;();  <span class="comment">// 组织架构关系；id-&gt;list</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; invertedMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, String&gt;();       <span class="comment">// 反向关系链</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GroupStructure</span><span class="params">(String groupId, String groupName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.groupId = groupId;</span><br><span class="line">        <span class="built_in">this</span>.groupName = groupName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Employee employee)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> != employeeMap.put(employee.getuId(), employee);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Employee o)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> != employeeMap.remove(o.getuId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addLink</span><span class="params">(String key, Link link)</span> &#123;</span><br><span class="line">        <span class="comment">// 添加反向关系链</span></span><br><span class="line">        invertedMap.put(link.getToId(), link.getFromId());</span><br><span class="line">        <span class="comment">// 添加正向链路关系</span></span><br><span class="line">        <span class="keyword">if</span> (linkMap.containsKey(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> linkMap.get(key).add(link);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List&lt;Link&gt; links = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Link&gt;();</span><br><span class="line">            links.add(link);</span><br><span class="line">            linkMap.put(key, links);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">removeLink</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> != linkMap.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;Employee&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Iterator</span>&lt;Employee&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            HashMap&lt;String, Integer&gt; keyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Integer&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">totalIdx</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">String</span> <span class="variable">fromId</span> <span class="operator">=</span> groupId;  <span class="comment">// 雇员ID，From</span></span><br><span class="line">            <span class="keyword">private</span> <span class="type">String</span> <span class="variable">toId</span> <span class="operator">=</span> groupId;   <span class="comment">// 雇员ID，To</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> totalIdx &lt; employeeMap.size();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> Employee <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 向下扫描</span></span><br><span class="line">                List&lt;Link&gt; links = linkMap.get(toId);</span><br><span class="line">                <span class="type">int</span> <span class="variable">cursorIdx</span> <span class="operator">=</span> getCursorIdx(toId);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 同级节点扫描</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == links)&#123;</span><br><span class="line">                    cursorIdx = getCursorIdx(fromId);</span><br><span class="line">                    links = linkMap.get(fromId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 上级节点扫描</span></span><br><span class="line">                <span class="keyword">while</span> (cursorIdx &gt; links.size() - <span class="number">1</span>)&#123;</span><br><span class="line">                    fromId = invertedMap.get(fromId);</span><br><span class="line">                    cursorIdx = getCursorIdx(fromId);</span><br><span class="line">                    links = linkMap.get(fromId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取节点</span></span><br><span class="line">                <span class="type">Link</span> <span class="variable">link</span> <span class="operator">=</span> links.get(cursorIdx);</span><br><span class="line">                toId = link.getToId();</span><br><span class="line">                fromId = link.getFromId();</span><br><span class="line">                totalIdx++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> employeeMap.get(link.getToId());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 获取游标的key</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCursorIdx</span><span class="params">(String key)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (keyMap.containsKey(key)) &#123;</span><br><span class="line">                    idx = keyMap.get(key);</span><br><span class="line">                    keyMap.put(key, ++idx);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    keyMap.put(key, idx);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> idx;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上的这部分代码稍微有点长，主要包括了对元素的添加和删除。另外最重要的是对遍历的实现<code>new Iterator&lt;Employee&gt;</code>。</li>
<li>添加和删除元素相对来说比较简单，使用了两个map数组结构进行定义；<code>雇员列表</code>、<code>组织架构关系；id-&gt;list</code>。当元素添加元素的时候，会分别在不同的方法中向<code>map</code>结构中进行填充**指向关系(A-&gt;B)**，也就构建出了我们的树形组织关系。</li>
</ul>
<p><strong>迭代器实现思路</strong></p>
<ol>
<li>这里的树形结构我们需要做的是深度遍历，也就是左侧的一直遍历到最深节点。</li>
<li>当遍历到最深节点后，开始遍历最深节点的横向节点。</li>
<li>当横向节点遍历完成后则向上寻找横向节点，直至树结构全部遍历完成。</li>
</ol>
<p>总结：</p>
<ul>
<li>迭代器的设计模式从以上的功能实现可以看到，满足了单一职责和开闭原则，外界的调用方也不需要知道任何一个不同的数据结构在使用上的遍历差异。可以非常方便的扩展，也让整个遍历变得更加干净整洁。</li>
<li>但从结构的实现上可以看到，迭代器模式的实现过程相对来说是比较复杂的，类的实现上也扩增了需要外部定义的类，使得遍历与原数据结构分开。虽然这是比较麻烦的，但可以看到在使用java的jdk时候，迭代器的模式还是很好用的，可以非常方便扩展和升级。</li>
</ul>
<h3 id="4、中介者模式"><a href="#4、中介者模式" class="headerlink" title="4、中介者模式"></a>4、中介者模式</h3><p>中介者模式要解决的就是复杂功能应用之间的重复调用，在这中间添加一层中介者包装服务，对外提供简单、通用、易扩展的服务能力。</p>
<p>业务场景：</p>
<p>模拟Mybatis的ORM框架</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-16-02.png" alt="场景模拟；模仿Mybatis手写ORM框架"></p>
<p>JDBC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(JDBCUtil.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/itstack-demo-design&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//1. 加载驱动程序</span></span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="comment">//2. 获得数据库连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(URL, USER, PASSWORD);</span><br><span class="line">        <span class="comment">//3. 操作数据库</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> stmt.executeQuery(<span class="string">&quot;SELECT id, name, age, createTime, updateTime FROM user&quot;</span>);</span><br><span class="line">        <span class="comment">//4. 如果有数据 resultSet.next() 返回true</span></span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;测试结果 姓名：&#123;&#125; 年龄：&#123;&#125;&quot;</span>, resultSet.getString(<span class="string">&quot;name&quot;</span>),resultSet.getInt(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中介者模式模型架构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-16-03.png" alt="中介者模式模型结构"></p>
<ul>
<li>对ORM框架实现的核心类，包括了；加载配置文件、对xml解析、获取数据库session、操作数据库以及结果返回。</li>
<li>左上是对数据库的定义和处理，基本包括我们常用的方法；<code>&lt;T&gt; T selectOne</code>、<code>&lt;T&gt; List&lt;T&gt; selectList</code>等。</li>
<li>右侧蓝色部分是对数据库配置的开启session的工厂处理类，这里的工厂会操作<code>DefaultSqlSession</code></li>
<li>之后是红色地方的<code>SqlSessionFactoryBuilder</code>，这个类是对数据库操作的核心类；处理工厂、解析文件、拿到session等。</li>
</ul>
<p>定义SqlSession接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SqlSession</span> &#123;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; T <span class="title function_">selectOne</span><span class="params">(String statement)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; T <span class="title function_">selectOne</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; List&lt;T&gt; <span class="title function_">selectList</span><span class="params">(String statement)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; List&lt;T&gt; <span class="title function_">selectList</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SqlSession的具体实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSqlSession</span> <span class="keyword">implements</span> <span class="title class_">SqlSession</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, XNode&gt; mapperElement;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultSqlSession</span><span class="params">(Connection connection, Map&lt;String, XNode&gt; mapperElement)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.connection = connection;</span><br><span class="line">        <span class="built_in">this</span>.mapperElement = mapperElement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">selectOne</span><span class="params">(String statement)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">XNode</span> <span class="variable">xNode</span> <span class="operator">=</span> mapperElement.get(statement);</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(xNode.getSql());</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> preparedStatement.executeQuery();</span><br><span class="line">            List&lt;T&gt; objects = resultSet2Obj(resultSet, Class.forName(xNode.getResultType()));</span><br><span class="line">            <span class="keyword">return</span> objects.get(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">selectList</span><span class="params">(String statement)</span> &#123;</span><br><span class="line">        <span class="type">XNode</span> <span class="variable">xNode</span> <span class="operator">=</span> mapperElement.get(statement);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(xNode.getSql());</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> preparedStatement.executeQuery();</span><br><span class="line">            <span class="keyword">return</span> resultSet2Obj(resultSet, Class.forName(xNode.getResultType()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">resultSet2Obj</span><span class="params">(ResultSet resultSet, Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        List&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ResultSetMetaData</span> <span class="variable">metaData</span> <span class="operator">=</span> resultSet.getMetaData();</span><br><span class="line">            <span class="type">int</span> <span class="variable">columnCount</span> <span class="operator">=</span> metaData.getColumnCount();</span><br><span class="line">            <span class="comment">// 每次遍历行值</span></span><br><span class="line">            <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> (T) clazz.newInstance();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= columnCount; i++) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> resultSet.getObject(i);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">columnName</span> <span class="operator">=</span> metaData.getColumnName(i);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">setMethod</span> <span class="operator">=</span> <span class="string">&quot;set&quot;</span> + columnName.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + columnName.substring(<span class="number">1</span>);</span><br><span class="line">                    Method method;</span><br><span class="line">                    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Timestamp) &#123;</span><br><span class="line">                        method = clazz.getMethod(setMethod, Date.class);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        method = clazz.getMethod(setMethod, value.getClass());</span><br><span class="line">                    &#125;</span><br><span class="line">                    method.invoke(obj, value);</span><br><span class="line">                &#125;</span><br><span class="line">                list.add(obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == connection) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义SqlSessionFactory接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SqlSessionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    SqlSession <span class="title function_">openSession</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当有数据库操作的时候都会获取每一次执行的<code>SqlSession</code></li>
</ul>
<p>SqlSessionFactory具体实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSqlSessionFactory</span> <span class="keyword">implements</span> <span class="title class_">SqlSessionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultSqlSessionFactory</span><span class="params">(Configuration configuration)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configuration = configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SqlSession <span class="title function_">openSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(configuration.connection, configuration.mapperElement);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>DefaultSqlSessionFactory</code>，是使用mybatis最常用的类，这里我们简单的实现了一个版本。</li>
<li>虽然是简单的版本，但是包括了最基本的核心思路。当开启<code>SqlSession</code>时会进行返回一个<code>DefaultSqlSession</code></li>
<li>这个构造函数中向下传递了<code>Configuration</code>配置文件，在这个配置文件中包括；<code>Connection connection</code>、<code>Map&lt;String, String&gt; dataSource</code>、<code>Map&lt;String, XNode&gt; mapperElement</code>。如果有你阅读过Mybatis源码，对这个就不会陌生</li>
</ul>
<p>总结：</p>
<ul>
<li>以上通过中介者模式的设计思想我们手写了一个ORM框架，隐去了对数据库操作的复杂度，让外部的调用方可以非常简单的进行操作数据库。这也是我们平常使用的<code>Mybatis</code>的原型，在我们日常的开发使用中，只需要按照配置即可非常简单的操作数据库。</li>
<li>除了以上这种组件模式的开发外，还有服务接口的包装也可以使用中介者模式来实现。比如你们公司有很多的奖品接口需要在营销活动中对接，那么可以把这些奖品接口统一收到中台开发一个奖品中心，对外提供服务。这样就不需要每一个需要对接奖品的接口，都去找具体的提供者，而是找中台服务即可。</li>
<li>在上述的实现和测试使用中可以看到，这种模式的设计满足了；<code>单一职责</code>和<code>开闭原则</code>，也就符合了<code>迪米特原则</code>，即越少人知道越好。外部的人只需要按照需求进行调用，不需要知道具体的是如何实现的，复杂的一面已经有组件合作服务平台处理。</li>
</ul>
<h3 id="5、备忘录模式"><a href="#5、备忘录模式" class="headerlink" title="5、备忘录模式"></a>5、备忘录模式</h3><p>备忘录模式是一种设计模式，用于保存和恢复对象的状态。在备忘录模式中，可以创建一个备忘录对象来保存当前对象的状态，然后在需要时将对象恢复到之前的状态。这种模式通常用于需要撤销操作或者保存进度的场景。</p>
<p><strong>业务场景</strong>：完成配置文件的按需回滚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-17-03.png" alt="场景模拟；系统发布上线配置回滚"></p>
<p><strong>备忘录模式的模型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-17-04.png" alt="备忘录模式模型结构"></p>
<ul>
<li>以上是工程结构的一个类图，其实相对来说并不复杂，除了原有的配置类(<code>ConfigFile</code>)以外，只新增加了三个类。</li>
<li><code>ConfigMemento</code>：备忘录类，相当于是对原有配置类的扩展</li>
<li><code>ConfigOriginator</code>：记录者类，获取和返回备忘录类对象信息</li>
<li><code>Admin</code>：管理员类，用于操作记录备忘信息，比如你一些列的顺序执行了什么或者某个版本下的内容信息</li>
</ul>
<p>配置类信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigFile</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String versionNo; <span class="comment">// 版本号</span></span><br><span class="line">    <span class="keyword">private</span> String content;   <span class="comment">// 内容</span></span><br><span class="line">    <span class="keyword">private</span> Date dateTime;    <span class="comment">// 时间</span></span><br><span class="line">    <span class="keyword">private</span> String operator;  <span class="comment">// 操作人</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>备忘录类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigMemento</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigFile configFile; <span class="comment">// 配置文件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConfigMemento</span><span class="params">(ConfigFile configFile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configFile = configFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigFile <span class="title function_">getConfigFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConfigFile</span><span class="params">(ConfigFile configFile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configFile = configFile;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>记录者类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigOriginator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigFile configFile; <span class="comment">// 配置文件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigFile <span class="title function_">getConfigFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConfigFile</span><span class="params">(ConfigFile configFile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configFile = configFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigMemento <span class="title function_">saveMemento</span><span class="params">()</span>&#123; <span class="comment">// 保存到备忘录</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConfigMemento</span>(configFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getMemento</span><span class="params">(ConfigMemento memento)</span>&#123; <span class="comment">// 获取当前备忘录的配置文件</span></span><br><span class="line">        <span class="built_in">this</span>.configFile = memento.getConfigFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>记录者类除了对<code>ConfigFile</code>配置类增加了获取和设置方法外，还增加了保存<code>saveMemento()</code>、获取<code>getMemento(ConfigMemento memento)</code>。</li>
<li><code>saveMemento</code>：保存备忘录的时候会创建一个备忘录信息，并返回回去，交给管理者处理。</li>
<li><code>getMemento</code>：获取的之后并不是直接返回，而是把备忘录的信息交给现在的配置文件<code>this.configFile</code>，这部分需要注意。</li>
</ul>
<p>管理员类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Admin</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">cursorIdx</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 游标</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ConfigMemento&gt; mementoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ConfigMemento&gt;(); <span class="comment">// 备忘录表</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, ConfigMemento&gt; mementoMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, ConfigMemento&gt;(); <span class="comment">// 备忘录map 版本号:key-&gt;备忘录value</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">append</span><span class="params">(ConfigMemento memento)</span> &#123; <span class="comment">// 添加备忘录</span></span><br><span class="line">        mementoList.add(memento);</span><br><span class="line">        mementoMap.put(memento.getConfigFile().getVersionNo(), memento);</span><br><span class="line">        cursorIdx++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigMemento <span class="title function_">undo</span><span class="params">()</span> &#123; <span class="comment">// 向后回滚</span></span><br><span class="line">        <span class="keyword">if</span> (--cursorIdx &lt;= <span class="number">0</span>) <span class="keyword">return</span> mementoList.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> mementoList.get(cursorIdx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigMemento <span class="title function_">redo</span><span class="params">()</span> &#123; <span class="comment">// 向前回滚</span></span><br><span class="line">        <span class="keyword">if</span> (++cursorIdx &gt; mementoList.size()) <span class="keyword">return</span> mementoList.get(mementoList.size() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> mementoList.get(cursorIdx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigMemento <span class="title function_">get</span><span class="params">(String versionNo)</span>&#123; <span class="comment">// 获取指定版本的备忘录</span></span><br><span class="line">        <span class="keyword">return</span> mementoMap.get(versionNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在这个类中主要实现的核心功能就是记录配置文件信息，也就是备忘录的效果，之后提供可以回滚和获取的方法，拿到备忘录的具体内容。</li>
<li>同时这里设置了两个数据结构来存放备忘录，实际使用中可以按需设置。<code>List&lt;ConfigMemento&gt;</code>、<code>Map&lt;String, ConfigMemento&gt;</code>。</li>
<li>最后是提供的备忘录操作方法；存放(<code>append</code>)、回滚(<code>undo</code>)、返回(<code>redo</code>)、定向获取(<code>get</code>)，这样四个操作方法。</li>
</ul>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Admin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Admin</span>();</span><br><span class="line">    <span class="type">ConfigOriginator</span> <span class="variable">configOriginator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigOriginator</span>();</span><br><span class="line">    configOriginator.setConfigFile(<span class="keyword">new</span> <span class="title class_">ConfigFile</span>(<span class="string">&quot;1000001&quot;</span>, <span class="string">&quot;配置内容A=哈哈&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;小傅哥&quot;</span>));</span><br><span class="line">    admin.append(configOriginator.saveMemento()); <span class="comment">// 保存配置</span></span><br><span class="line">    configOriginator.setConfigFile(<span class="keyword">new</span> <span class="title class_">ConfigFile</span>(<span class="string">&quot;1000002&quot;</span>, <span class="string">&quot;配置内容A=嘻嘻&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;小傅哥&quot;</span>));</span><br><span class="line">    admin.append(configOriginator.saveMemento()); <span class="comment">// 保存配置</span></span><br><span class="line">    configOriginator.setConfigFile(<span class="keyword">new</span> <span class="title class_">ConfigFile</span>(<span class="string">&quot;1000003&quot;</span>, <span class="string">&quot;配置内容A=么么&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;小傅哥&quot;</span>));</span><br><span class="line">    admin.append(configOriginator.saveMemento()); <span class="comment">// 保存配置</span></span><br><span class="line">    configOriginator.setConfigFile(<span class="keyword">new</span> <span class="title class_">ConfigFile</span>(<span class="string">&quot;1000004&quot;</span>, <span class="string">&quot;配置内容A=嘿嘿&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;小傅哥&quot;</span>));</span><br><span class="line">    admin.append(configOriginator.saveMemento()); <span class="comment">// 保存配置  </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 历史配置(回滚)</span></span><br><span class="line">    configOriginator.getMemento(admin.undo());</span><br><span class="line">    logger.info(<span class="string">&quot;历史配置(回滚)undo：&#123;&#125;&quot;</span>, JSON.toJSONString(configOriginator.getConfigFile()));  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 历史配置(回滚)</span></span><br><span class="line">    configOriginator.getMemento(admin.undo());</span><br><span class="line">    logger.info(<span class="string">&quot;历史配置(回滚)undo：&#123;&#125;&quot;</span>, JSON.toJSONString(configOriginator.getConfigFile()));  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 历史配置(前进)</span></span><br><span class="line">    configOriginator.getMemento(admin.redo());</span><br><span class="line">    logger.info(<span class="string">&quot;历史配置(前进)redo：&#123;&#125;&quot;</span>, JSON.toJSONString(configOriginator.getConfigFile()));   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 历史配置(获取)</span></span><br><span class="line">    configOriginator.getMemento(admin.get(<span class="string">&quot;1000002&quot;</span>));</span><br><span class="line">    logger.info(<span class="string">&quot;历史配置(获取)get：&#123;&#125;&quot;</span>, JSON.toJSONString(configOriginator.getConfigFile()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong>：</p>
<ul>
<li>此种设计模式的方式可以满足在不破坏原有属性类的基础上，扩充了备忘录的功能。虽然和我们平时使用的思路是一样的，但在具体实现上还可以细细品味，这样的方式在一些源码中也有所体现。</li>
<li>在以上的实现中我们是将配置模拟存放到内存中，如果关机了会导致配置信息丢失，因为在一些真实的场景里还是需要存放到数据库中。那么此种存放到内存中进行回复的场景也不是没有，比如；Photoshop、运营人员操作ERP配置活动，那么也就是即时性的一般不需要存放到库中进行恢复。另外如果是使用内存方式存放备忘录，需要考虑存储问题，避免造成内存大量消耗。</li>
<li>设计模式的学习都是为了更好的写出可扩展、可管理、易维护的代码，而这个学习的过程需要自己不断的尝试实际操作，理论的知识与实际结合还有很长一段距离。切记多多上手！</li>
</ul>
<p><strong>业务场景</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-18-03.png" alt="场景模拟；小客车指标摇号通知场景"></p>
<p>摇号服务接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinibusTargetService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟摇号，但不是摇号算法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uId 用户编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">lottery</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(uId.hashCode()) % <span class="number">2</span> == <span class="number">0</span> ? <span class="string">&quot;恭喜你，编码&quot;</span>.concat(uId).concat(<span class="string">&quot;在本次摇号中签&quot;</span>) : <span class="string">&quot;很遗憾，编码&quot;</span>.concat(uId).concat(<span class="string">&quot;在本次摇号未中签或摇号资格已过期&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>常规的实现方式</strong>:</p>
<p>包括了三部分内容；返回对象(<code>LotteryResult</code>)、定义接口(<code>LotteryService</code>)、具体实现(<code>LotteryServiceImpl</code>)。</p>
<p>主要的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LotteryServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LotteryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(LotteryServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">MinibusTargetService</span> <span class="variable">minibusTargetService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MinibusTargetService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LotteryResult <span class="title function_">doDraw</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        <span class="comment">// 摇号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lottery</span> <span class="operator">=</span> minibusTargetService.lottery(uId);</span><br><span class="line">        <span class="comment">// 发短信</span></span><br><span class="line">        logger.info(<span class="string">&quot;给用户 &#123;&#125; 发送短信通知(短信)：&#123;&#125;&quot;</span>, uId, lottery);</span><br><span class="line">        <span class="comment">// 发MQ消息</span></span><br><span class="line">        logger.info(<span class="string">&quot;记录用户 &#123;&#125; 摇号结果(MQ)：&#123;&#125;&quot;</span>, uId, lottery);</span><br><span class="line">        <span class="comment">// 结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LotteryResult</span>(uId, lottery, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从以上的方法实现中可以看到，整体过程包括三部分；摇号、发短信、发MQ消息，而这部分都是顺序调用的。</li>
<li>除了<code>摇号</code>接口调用外，后面的两部分都是非核心主链路功能，而且会随着后续的业务需求发展而不断的调整和扩充，在这样的开发方式下就非常不利于维护。</li>
</ul>
<p><strong>观察者模式模型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-18-04.png" alt="观察者模式模型结构"></p>
<ul>
<li>从上图可以分为三大块看；<code>事件监听</code>、<code>事件处理</code>、<code>具体的业务流程</code>，另外在业务流程中 <code>LotteryService</code> 定义的是抽象类，因为这样可以通过抽象类将事件功能屏蔽，外部业务流程开发者不需要知道具体的通知操作。</li>
<li>右下角圆圈图表示的是核心流程与非核心流程的结构，一般在开发中会把主线流程开发完成后，再使用通知的方式处理辅助流程。他们可以是异步的，在MQ以及定时任务的处理下，保证最终一致性。</li>
</ul>
<p>事件监听定义接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doEvent</span><span class="params">(LotteryResult result)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个监听事件的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageEventListener</span> <span class="keyword">implements</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MessageEventListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doEvent</span><span class="params">(LotteryResult result)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;给用户 &#123;&#125; 发送短信通知(短信)：&#123;&#125;&quot;</span>, result.getuId(), result.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQEventListener</span> <span class="keyword">implements</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MQEventListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doEvent</span><span class="params">(LotteryResult result)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;记录用户 &#123;&#125; 摇号结果(MQ)：&#123;&#125;&quot;</span>, result.getuId(), result.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上是两个事件的具体实现，相对来说都比较简单。如果是实际的业务开发那么会需要调用外部接口以及控制异常的处理。</li>
<li>同时我们上面提到事件接口添加泛型，如果有需要那么在事件的实现中就可以按照不同的类型进行包装事件内容。</li>
</ul>
<p>事件处理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;Enum&lt;EventType&gt;, List&lt;EventListener&gt;&gt; listeners = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EventManager</span><span class="params">(Enum&lt;EventType&gt;... operations)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Enum&lt;EventType&gt; operation : operations) &#123;</span><br><span class="line">            <span class="built_in">this</span>.listeners.put(operation, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">EventType</span> &#123;</span><br><span class="line">        MQ, Message</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订阅</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType 事件类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener  监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Enum&lt;EventType&gt; eventType, EventListener listener)</span> &#123;</span><br><span class="line">        List&lt;EventListener&gt; users = listeners.get(eventType);</span><br><span class="line">        users.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消订阅</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType 事件类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener  监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(Enum&lt;EventType&gt; eventType, EventListener listener)</span> &#123;</span><br><span class="line">        List&lt;EventListener&gt; users = listeners.get(eventType);</span><br><span class="line">        users.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType 事件类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result    结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">(Enum&lt;EventType&gt; eventType, LotteryResult result)</span> &#123;</span><br><span class="line">        List&lt;EventListener&gt; users = listeners.get(eventType);</span><br><span class="line">        <span class="keyword">for</span> (EventListener listener : users) &#123;</span><br><span class="line">            listener.doEvent(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>整个处理的实现上提供了三个主要方法；订阅(<code>subscribe</code>)、取消订阅(<code>unsubscribe</code>)、通知(<code>notify</code>)。这三个方法分别用于对监听时间的添加和使用。</li>
<li>另外因为事件有不同的类型，这里使用了枚举的方式进行处理，也方便让外部在规定下使用事件，而不至于乱传信息(<code>EventType.MQ</code>、<code>EventType.Message</code>)。</li>
</ul>
<p>业务抽象类接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">LotteryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EventManager eventManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LotteryService</span><span class="params">()</span> &#123;</span><br><span class="line">        eventManager = <span class="keyword">new</span> <span class="title class_">EventManager</span>(EventManager.EventType.MQ, EventManager.EventType.Message);</span><br><span class="line">        eventManager.subscribe(EventManager.EventType.MQ, <span class="keyword">new</span> <span class="title class_">MQEventListener</span>());</span><br><span class="line">        eventManager.subscribe(EventManager.EventType.Message, <span class="keyword">new</span> <span class="title class_">MessageEventListener</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LotteryResult <span class="title function_">draw</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        <span class="type">LotteryResult</span> <span class="variable">lotteryResult</span> <span class="operator">=</span> doDraw(uId);</span><br><span class="line">        <span class="comment">// 需要什么通知就给调用什么方法</span></span><br><span class="line">        eventManager.notify(EventManager.EventType.MQ, lotteryResult);</span><br><span class="line">        eventManager.notify(EventManager.EventType.Message, lotteryResult);</span><br><span class="line">        <span class="keyword">return</span> lotteryResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> LotteryResult <span class="title function_">doDraw</span><span class="params">(String uId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这种使用抽象类的方式定义实现方法，可以在方法中扩展需要的额外调用。并提供抽象类<code>abstract LotteryResult doDraw(String uId)</code>，让类的继承者实现。</li>
<li>同时方法的定义使用的是<code>protected</code>，也就是保证将来外部的调用方不会调用到此方法，只有调用到<code>draw(String uId)</code>，才能让我们完成事件通知。</li>
<li>此种方式的实现就是在抽象类中写好一个基本的方法，在方法中完成新增逻辑的同时，再增加抽象类的使用。而这个抽象类的定义会有继承者实现。</li>
<li>另外在构造函数中提供了对事件的定义；<code>eventManager.subscribe(EventManager.EventType.MQ, new MQEventListener())</code>。</li>
<li>在使用的时候也是使用枚举的方式进行通知使用，传了什么类型<code>EventManager.EventType.MQ</code>，就会执行什么事件通知，按需添加。</li>
</ul>
<p>业务实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LotteryServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">LotteryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">MinibusTargetService</span> <span class="variable">minibusTargetService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MinibusTargetService</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> LotteryResult <span class="title function_">doDraw</span><span class="params">(String uId)</span> &#123;</span><br><span class="line">        <span class="comment">// 摇号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lottery</span> <span class="operator">=</span> minibusTargetService.lottery(uId);</span><br><span class="line">        <span class="comment">// 结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LotteryResult</span>(uId, lottery, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6、观察者模式"><a href="#6、观察者模式" class="headerlink" title="6、观察者模式"></a>6、观察者模式</h3><p>观察者模式是一种软件设计模式，它定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象，当主题对象发生变化时，它的所有观察者都会收到通知并自动更新。</p>
<p>在观察者模式中，有两个主要角色：主题和观察者。主题是被观察的对象，它包含了一系列观察者需要监视的状态。观察者则是依赖于主题的对象，它们会在主题状态发生变化时得到通知并进行相应的更新操作。</p>
<p>观察者模式的优点是可以实现松耦合，主题和观察者之间的依赖关系比较简单，并且可以实现广播通信。缺点是如果观察者过多，会导致系统运行效率降低。</p>
<h3 id="7、状态模式"><a href="#7、状态模式" class="headerlink" title="7、状态模式"></a>7、状态模式</h3><p>状态模式描述的是一个行为下的多种状态变更，比如我们最常见的一个网站的页面，在你登录与不登录下展示的内容是略有差异的(<code>不登录不能展示个人信息</code>)，而这种<code>登录</code>与<code>不登录</code>就是我们通过改变<strong>状态</strong>，而让整个行为发生了变化。</p>
<p>业务场景：<strong>模拟营销活动审核状态流转场景</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-19-03.png" alt="场景模拟；营销活动审核状态流转"></p>
<p>基本的活动信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String activityId;    <span class="comment">// 活动ID</span></span><br><span class="line">    <span class="keyword">private</span> String activityName;  <span class="comment">// 活动名称</span></span><br><span class="line">    <span class="keyword">private</span> Enum&lt;Status&gt; status;  <span class="comment">// 活动状态</span></span><br><span class="line">    <span class="keyword">private</span> Date beginTime;       <span class="comment">// 开始时间</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;         <span class="comment">// 结束时间</span></span><br><span class="line">    </span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>活动枚举状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Status</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1创建编辑、2待审核、3审核通过(任务扫描成活动中)、4审核拒绝(可以撤审到编辑状态)、5活动中、6活动关闭、7活动开启(任务扫描成活动中)</span></span><br><span class="line">    Editing, Check, Pass, Refuse, Doing, Close, Open</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>活动服务接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Enum&lt;Status&gt;&gt; statusMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Enum&lt;Status&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(String activityId, Enum&lt;Status&gt; status)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟查询活动信息</span></span><br><span class="line">        <span class="type">ActivityInfo</span> <span class="variable">activityInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityInfo</span>();</span><br><span class="line">        activityInfo.setActivityId(activityId);</span><br><span class="line">        activityInfo.setActivityName(<span class="string">&quot;早起学习打卡领奖活动&quot;</span>);</span><br><span class="line">        activityInfo.setStatus(status);</span><br><span class="line">        activityInfo.setBeginTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        activityInfo.setEndTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        statusMap.put(activityId, status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询活动信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId 活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ActivityInfo <span class="title function_">queryActivityInfo</span><span class="params">(String activityId)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟查询活动信息</span></span><br><span class="line">        <span class="type">ActivityInfo</span> <span class="variable">activityInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityInfo</span>();</span><br><span class="line">        activityInfo.setActivityId(activityId);</span><br><span class="line">        activityInfo.setActivityName(<span class="string">&quot;早起学习打卡领奖活动&quot;</span>);</span><br><span class="line">        activityInfo.setStatus(statusMap.get(activityId));</span><br><span class="line">        activityInfo.setBeginTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        activityInfo.setEndTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="keyword">return</span> activityInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询活动状态</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId 活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Enum&lt;Status&gt; <span class="title function_">queryActivityStatus</span><span class="params">(String activityId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> statusMap.get(activityId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行状态变更</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId   活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beforeStatus 变更前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> afterStatus  变更后状态 b</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">execStatus</span><span class="params">(String activityId, Enum&lt;Status&gt; beforeStatus, Enum&lt;Status&gt; afterStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!beforeStatus.equals(statusMap.get(activityId))) <span class="keyword">return</span>;</span><br><span class="line">        statusMap.put(activityId, afterStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在这个静态类中提供了活动的查询和状态变更接口；<code>queryActivityInfo</code>、<code>queryActivityStatus</code>、<code>execStatus</code>。</li>
<li>同时使用Map的结构来记录活动ID和状态变化信息，另外还有init方法来初始化活动数据。实际的开发中这类信息基本都是从<code>数据库</code>或者<code>Redis</code>中获取。</li>
</ul>
<p>屎山代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityExecStatusController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动状态变更</span></span><br><span class="line"><span class="comment">     * 1. 编辑中 -&gt; 提审、关闭</span></span><br><span class="line"><span class="comment">     * 2. 审核通过 -&gt; 拒绝、关闭、活动中</span></span><br><span class="line"><span class="comment">     * 3. 审核拒绝 -&gt; 撤审、关闭</span></span><br><span class="line"><span class="comment">     * 4. 活动中 -&gt; 关闭</span></span><br><span class="line"><span class="comment">     * 5. 活动关闭 -&gt; 开启</span></span><br><span class="line"><span class="comment">     * 6. 活动开启 -&gt; 关闭</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId   活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beforeStatus 变更前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> afterStatus  变更后状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">execStatus</span><span class="params">(String activityId, Enum&lt;Status&gt; beforeStatus, Enum&lt;Status&gt; afterStatus)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 编辑中 -&gt; 提审、关闭</span></span><br><span class="line">        <span class="keyword">if</span> (Status.Editing.equals(beforeStatus)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Status.Check.equals(afterStatus) || Status.Close.equals(afterStatus)) &#123;</span><br><span class="line">                ActivityService.execStatus(activityId, beforeStatus, afterStatus);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;变更状态成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;变更状态拒绝&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 审核通过 -&gt; 拒绝、关闭、活动中</span></span><br><span class="line">        <span class="keyword">if</span> (Status.Pass.equals(beforeStatus)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Status.Refuse.equals(afterStatus) || Status.Doing.equals(afterStatus) || Status.Close.equals(afterStatus)) &#123;</span><br><span class="line">                ActivityService.execStatus(activityId, beforeStatus, afterStatus);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;变更状态成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;变更状态拒绝&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 审核拒绝 -&gt; 撤审、关闭</span></span><br><span class="line">        <span class="keyword">if</span> (Status.Refuse.equals(beforeStatus)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Status.Editing.equals(afterStatus) || Status.Close.equals(afterStatus)) &#123;</span><br><span class="line">                ActivityService.execStatus(activityId, beforeStatus, afterStatus);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;变更状态成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;变更状态拒绝&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 活动中 -&gt; 关闭</span></span><br><span class="line">        <span class="keyword">if</span> (Status.Doing.equals(beforeStatus)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Status.Close.equals(afterStatus)) &#123;</span><br><span class="line">                ActivityService.execStatus(activityId, beforeStatus, afterStatus);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;变更状态成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;变更状态拒绝&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 活动关闭 -&gt; 开启</span></span><br><span class="line">        <span class="keyword">if</span> (Status.Close.equals(beforeStatus)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Status.Open.equals(afterStatus)) &#123;</span><br><span class="line">                ActivityService.execStatus(activityId, beforeStatus, afterStatus);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;变更状态成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;变更状态拒绝&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 活动开启 -&gt; 关闭</span></span><br><span class="line">        <span class="keyword">if</span> (Status.Open.equals(beforeStatus)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Status.Close.equals(afterStatus)) &#123;</span><br><span class="line">                ActivityService.execStatus(activityId, beforeStatus, afterStatus);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;变更状态成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;变更状态拒绝&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;非可处理的活动状态变更&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>大量的 <code>if else</code> 嵌套，代码的可读性差；</li>
<li>不利于维护和拓展；</li>
</ul>
<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">activityId</span> <span class="operator">=</span> <span class="string">&quot;100001&quot;</span>;</span><br><span class="line">    ActivityService.init(activityId, Status.Editing);  </span><br><span class="line"></span><br><span class="line">    <span class="type">ActivityExecStatusController</span> <span class="variable">activityExecStatusController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityExecStatusController</span>();</span><br><span class="line">    <span class="type">Result</span> <span class="variable">resultRefuse</span> <span class="operator">=</span> activityExecStatusController.execStatus(activityId, Status.Editing, Status.Refuse); </span><br><span class="line">    logger.info(<span class="string">&quot;测试结果(编辑中To审核拒绝)：&#123;&#125;&quot;</span>, JSON.toJSONString(resultRefuse));                           </span><br><span class="line"></span><br><span class="line">    <span class="type">Result</span> <span class="variable">resultCheck</span> <span class="operator">=</span> activityExecStatusController.execStatus(activityId, Status.Editing, Status.Check);</span><br><span class="line">    logger.info(<span class="string">&quot;测试结果(编辑中To提交审核)：&#123;&#125;&quot;</span>, JSON.toJSONString(resultCheck));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用状态模式重构代码。</p>
<p>重构的重点往往是处理掉<code>ifelse</code>，而想处理掉<code>ifelse</code>基本离不开<strong>接口</strong>与<strong>抽象类</strong>，另外还需要重新改造代码结构。</p>
<p><strong>状态模式模型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-19-04.png" alt="状态模式模型结构"></p>
<ul>
<li>以上是状态模式的整个工程结构模型，State是一个抽象类，定义了各种操作接口(<code>提审、审核、拒审等</code>)。</li>
<li>右侧的不同颜色状态与我们场景模拟中的颜色保持一致，是各种状态流程流转的实现操作。这里的实现有一个关键点就是每一种状态到下一个状态，都分配到各个实现方法中控制，也就不需要<code>if</code>语言进行判断了。</li>
<li>最后是<code>StateHandler</code>对状态流程的统一处理，里面提供<code>Map</code>结构的各项服务接口调用，也就避免了使用<code>if</code>判断各项状态转变的流程。</li>
</ul>
<p>定义抽象类	</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">State</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动提审</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId    活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentStatus 当前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">arraignment</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核通过</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId    活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentStatus 当前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">checkPass</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核拒绝</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId    活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentStatus 当前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">checkRefuse</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 撤审撤销</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId    活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentStatus 当前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">checkRevoke</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动关闭</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId    活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentStatus 当前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">close</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动开启</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId    活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentStatus 当前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">open</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activityId    活动ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentStatus 当前状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">doing</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>在整个接口中提供了各项状态流转服务的接口，例如；活动提审、审核通过、审核拒绝、撤审撤销等7个方法。</li>
<li>在这些方法中所有的入参都是一样的，activityId(<code>活动ID</code>)、currentStatus(<code>当前状态</code>)，只有他们的具体实现是不同的。</li>
</ul>
<p><strong>编辑状态</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EditingState</span> <span class="keyword">extends</span> <span class="title class_">State</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">arraignment</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        ActivityService.execStatus(activityId, currentStatus, Status.Check);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;活动提审成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkPass</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;编辑中不可审核通过&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkRefuse</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;编辑中不可审核拒绝&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkRevoke</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;编辑中不可撤销审核&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">close</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        ActivityService.execStatus(activityId, currentStatus, Status.Close);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;活动关闭成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">open</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;非关闭活动不可开启&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">doing</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;编辑中活动不可执行活动中变更&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>提审</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheckState</span> <span class="keyword">extends</span> <span class="title class_">State</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">arraignment</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;待审核状态不可重复提审&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkPass</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        ActivityService.execStatus(activityId, currentStatus, Status.Pass);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;活动审核通过完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkRefuse</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        ActivityService.execStatus(activityId, currentStatus, Status.Refuse);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;活动审核拒绝完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkRevoke</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        ActivityService.execStatus(activityId, currentStatus, Status.Editing);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;活动审核撤销回到编辑中&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">close</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        ActivityService.execStatus(activityId, currentStatus, Status.Close);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0000&quot;</span>, <span class="string">&quot;活动审核关闭完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">open</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;非关闭活动不可开启&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">doing</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="string">&quot;0001&quot;</span>, <span class="string">&quot;待审核活动不可执行活动中变更&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>提供状态处理服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Enum&lt;Status&gt;, State&gt; stateMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;Enum&lt;Status&gt;, State&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StateHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        stateMap.put(Status.Check, <span class="keyword">new</span> <span class="title class_">CheckState</span>());     <span class="comment">// 待审核</span></span><br><span class="line">        stateMap.put(Status.Close, <span class="keyword">new</span> <span class="title class_">CloseState</span>());     <span class="comment">// 已关闭</span></span><br><span class="line">        stateMap.put(Status.Doing, <span class="keyword">new</span> <span class="title class_">DoingState</span>());     <span class="comment">// 活动中</span></span><br><span class="line">        stateMap.put(Status.Editing, <span class="keyword">new</span> <span class="title class_">EditingState</span>()); <span class="comment">// 编辑中</span></span><br><span class="line">        stateMap.put(Status.Open, <span class="keyword">new</span> <span class="title class_">OpenState</span>());       <span class="comment">// 已开启</span></span><br><span class="line">        stateMap.put(Status.Pass, <span class="keyword">new</span> <span class="title class_">PassState</span>());       <span class="comment">// 审核通过</span></span><br><span class="line">        stateMap.put(Status.Refuse, <span class="keyword">new</span> <span class="title class_">RefuseState</span>());   <span class="comment">// 审核拒绝</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">arraignment</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateMap.get(currentStatus).arraignment(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkPass</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateMap.get(currentStatus).checkPass(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkRefuse</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateMap.get(currentStatus).checkRefuse(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkRevoke</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateMap.get(currentStatus).checkRevoke(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">close</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateMap.get(currentStatus).close(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">open</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateMap.get(currentStatus).open(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">doing</span><span class="params">(String activityId, Enum&lt;Status&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateMap.get(currentStatus).doing(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一方面是为了方便管理</li>
<li>另一方面为了防止用户直接操作核心接口，存在风险性</li>
</ul>
<p><strong>总结</strong>：</p>
<ul>
<li>从以上的两种方式对一个需求的实现中可以看到，在第二种使用设计模式处理后已经没有了<code>ifelse</code>，代码的结构也更加清晰易于扩展。这就是设计模式的好处，可以非常强大的改变原有代码的结构，让以后的扩展和维护都变得容易些。</li>
<li>在实现结构的编码方式上可以看到这不再是面向过程的编程，而是面向对象的结构。并且这样的设计模式满足了<code>单一职责</code>和<code>开闭原则</code>，当你只有满足这样的结构下才会发现代码的扩展是容易的，也就是增加和修改功能不会影响整体的变化。</li>
<li>但如果状态和各项流转较多像本文的案例中，就会产生较多的实现类。因此可能也会让代码的实现上带来了时间成本，因为如果遇到这样的场景可以按需评估投入回报率。主要点在于看是否经常修改、是否可以做成组件化、抽离业务与非业务功能。</li>
</ul>
<h3 id="8、策略模式"><a href="#8、策略模式" class="headerlink" title="8、策略模式"></a>8、策略模式</h3><p>策略模式是一种行为模式，也是替代大量<code>ifelse</code>的利器。它所能帮你解决的是场景，一般是具有同类可替代的行为逻辑算法场景。比如；不同类型的交易方式(信用卡、支付宝、微信)、生成唯一ID策略(UUID、DB自增、DB+Redis、雪花算法、Leaf算法)等，都可以使用策略模式进行行为包装，供给外部使用。</p>
<p>业务场景：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-20-03.png" alt="场景模拟；商品支付使用营销优惠券"></p>
<p>模拟在购买商品时候使用的各种类型优惠券(满减、直减、折扣、n元购)</p>
<p>一般的是实现场景：(大量的 <code>if else</code>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 优惠券类型；</span></span><br><span class="line"><span class="comment"> * 1. 直减券</span></span><br><span class="line"><span class="comment"> * 2. 满减券</span></span><br><span class="line"><span class="comment"> * 3. 折扣券</span></span><br><span class="line"><span class="comment"> * 4. n元购</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CouponDiscountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">discountAmount</span><span class="params">(<span class="type">int</span> type, <span class="type">double</span> typeContent, <span class="type">double</span> skuPrice, <span class="type">double</span> typeExt)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 直减券</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == type) &#123;</span><br><span class="line">            <span class="keyword">return</span> skuPrice - typeContent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. 满减券</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">2</span> == type) &#123;</span><br><span class="line">            <span class="keyword">if</span> (skuPrice &lt; typeExt) <span class="keyword">return</span> skuPrice;</span><br><span class="line">            <span class="keyword">return</span> skuPrice - typeContent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 折扣券</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">3</span> == type) &#123;</span><br><span class="line">            <span class="keyword">return</span> skuPrice * typeContent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4. n元购</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">4</span> == type) &#123;</span><br><span class="line">            <span class="keyword">return</span> typeContent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0D</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用策略模式解决：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-20-04.png" alt="策略模式模型结构"></p>
<ul>
<li>整体的结构模式并不复杂，主要体现的不同类型的优惠券在计算优惠券方式的不同计算策略。</li>
<li>这里包括一个接口类(<code>ICouponDiscount</code>)以及四种优惠券类型的实现方式。</li>
<li>最后提供了策略模式的上下控制类处理，整体的策略服务。</li>
</ul>
<p>优惠券接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICouponDiscount</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 优惠券金额计算</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> couponInfo 券折扣信息；直减、满减、折扣、N元购</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuPrice   sku金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>           优惠后金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BigDecimal <span class="title function_">discountAmount</span><span class="params">(T couponInfo, BigDecimal skuPrice)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义了优惠券折扣接口，也增加了泛型用于不同类型的接口可以传递不同的类型参数。</li>
<li>接口中包括商品金额以及出参返回最终折扣后的金额，这里在实际开发中会比现在的接口参数多一些，但核心逻辑是这些。</li>
</ul>
<p>满减方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MJCouponDiscount</span> <span class="keyword">implements</span> <span class="title class_">ICouponDiscount</span>&lt;Map&lt;String,String&gt;&gt;  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 满减计算</span></span><br><span class="line"><span class="comment">     * 1. 判断满足x元后-n元，否则不减</span></span><br><span class="line"><span class="comment">     * 2. 最低支付金额1元</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">discountAmount</span><span class="params">(Map&lt;String,String&gt; couponInfo, BigDecimal skuPrice)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">x</span> <span class="operator">=</span> couponInfo.get(<span class="string">&quot;x&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> couponInfo.get(<span class="string">&quot;n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 小于商品金额条件的，直接返回商品原价</span></span><br><span class="line">        <span class="keyword">if</span> (skuPrice.compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(x)) &lt; <span class="number">0</span>) <span class="keyword">return</span> skuPrice;</span><br><span class="line">        <span class="comment">// 减去优惠金额判断</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">discountAmount</span> <span class="operator">=</span> skuPrice.subtract(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(o));</span><br><span class="line">        <span class="keyword">if</span> (discountAmount.compareTo(BigDecimal.ZERO) &lt; <span class="number">1</span>) <span class="keyword">return</span> BigDecimal.ONE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> discountAmount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直减方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZJCouponDiscount</span> <span class="keyword">implements</span> <span class="title class_">ICouponDiscount</span>&lt;Double&gt;  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 直减计算</span></span><br><span class="line"><span class="comment">     * 1. 使用商品价格减去优惠价格</span></span><br><span class="line"><span class="comment">     * 2. 最低支付金额1元</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">discountAmount</span><span class="params">(Double couponInfo, BigDecimal skuPrice)</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">discountAmount</span> <span class="operator">=</span> skuPrice.subtract(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(couponInfo));</span><br><span class="line">        <span class="keyword">if</span> (discountAmount.compareTo(BigDecimal.ZERO) &lt; <span class="number">1</span>) <span class="keyword">return</span> BigDecimal.ONE;</span><br><span class="line">        <span class="keyword">return</span> discountAmount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>折扣方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZKCouponDiscount</span> <span class="keyword">implements</span> <span class="title class_">ICouponDiscount</span>&lt;Double&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折扣计算</span></span><br><span class="line"><span class="comment">     * 1. 使用商品价格乘以折扣比例，为最后支付金额</span></span><br><span class="line"><span class="comment">     * 2. 保留两位小数</span></span><br><span class="line"><span class="comment">     * 3. 最低支付金额1元</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">discountAmount</span><span class="params">(Double couponInfo, BigDecimal skuPrice)</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">discountAmount</span> <span class="operator">=</span> skuPrice.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(couponInfo)).setScale(<span class="number">2</span>, BigDecimal.ROUND_HALF_UP);</span><br><span class="line">        <span class="keyword">if</span> (discountAmount.compareTo(BigDecimal.ZERO) &lt; <span class="number">1</span>) <span class="keyword">return</span> BigDecimal.ONE;</span><br><span class="line">        <span class="keyword">return</span> discountAmount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>N 元购</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NYGCouponDiscount</span> <span class="keyword">implements</span> <span class="title class_">ICouponDiscount</span>&lt;Double&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * n元购购买</span></span><br><span class="line"><span class="comment">     * 1. 无论原价多少钱都固定金额购买</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">discountAmount</span><span class="params">(Double couponInfo, BigDecimal skuPrice)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(couponInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>策略控制类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Context</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICouponDiscount&lt;T&gt; couponDiscount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Context</span><span class="params">(ICouponDiscount&lt;T&gt; couponDiscount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.couponDiscount = couponDiscount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">discountAmount</span><span class="params">(T couponInfo, BigDecimal skuPrice)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> couponDiscount.discountAmount(couponInfo, skuPrice);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>策略模式的控制类主要是外部可以传递不同的策略实现，在通过统一的方法执行优惠策略计算。</li>
<li>另外这里也可以包装成map结构，让外部只需要对应的泛型类型即可使用相应的服务。</li>
</ul>
<p>总结：</p>
<ul>
<li>以上的策略模式案例相对来说不并不复杂，主要的逻辑都是体现在关于不同种类优惠券的计算折扣策略上。结构相对来说也比较简单，在实际的开发中这样的设计模式也是非常常用的。另外这样的设计与命令模式、适配器模式结构相似，但是思路是有差异的。</li>
<li>通过策略设计模式的使用可以把我们方法中的if语句优化掉，大量的if语句使用会让代码难以扩展，也不好维护，同时在后期遇到各种问题也很难维护。在使用这样的设计模式后可以很好的满足隔离性与和扩展性，对于不断新增的需求也非常方便承接。</li>
<li><code>策略模式</code>、<code>适配器模式</code>、<code>组合模式</code>等，在一些结构上是比较相似的，但是每一个模式是有自己的逻辑特点，在使用的过程中最佳的方式是经过较多的实践来吸取经验，为后续的研发设计提供更好的技术输出。</li>
</ul>
<h3 id="9、模板模式"><a href="#9、模板模式" class="headerlink" title="9、模板模式"></a>9、模板模式</h3><p>模板模式的核心设计思路是通过在抽象类中定义抽象方法的执行顺序，并将抽象方法设定为只有子类实现，但不设计<code>独立访问</code>的方法。模板模式最大的作用就是确定抽象方法的执行顺序。</p>
<p><strong>业务案例</strong></p>
<p>模拟爬虫各类电商商品，生成营销推广海报场景</p>
<p>过程分为：模拟登录、爬取信息、生成海报，这三个步骤，另外；</p>
<ol>
<li>因为有些商品只有登录后才可以爬取，并且登录可以看到一些特定的价格这与未登录用户看到的价格不同。</li>
<li>不同的电商网站爬取方式不同，解析方式也不同，因此可以作为每一个实现类中的特定实现。</li>
<li>生成海报的步骤基本一样，但会有特定的商品来源标识。所以这样三个步骤可以使用模版模式来设定，并有具体的场景做子类实现。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-21-04.png" alt="模版模式模型结构"></p>
<ul>
<li>以上的代码结构还是比较简单的，一个定义了抽象方法执行顺序的核心抽象类，以及三个模拟具体的实现(<code>京东</code>、<code>淘宝</code>、<code>当当</code>)的电商服务。</li>
</ul>
<p>定义执行顺序的抽象类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基础电商推广服务</span></span><br><span class="line"><span class="comment"> * 1. 生成最优价商品海报</span></span><br><span class="line"><span class="comment"> * 2. 海报含带推广邀请码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">NetMall</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(NetMall.class);</span><br><span class="line"></span><br><span class="line">    String uId;   <span class="comment">// 用户ID</span></span><br><span class="line">    String uPwd;  <span class="comment">// 用户密码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NetMall</span><span class="params">(String uId, String uPwd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uId = uId;</span><br><span class="line">        <span class="built_in">this</span>.uPwd = uPwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成商品推广海报</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuUrl 商品地址(京东、淘宝、当当)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 海报图片base64位信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateGoodsPoster</span><span class="params">(String skuUrl)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!login(uId, uPwd)) <span class="keyword">return</span> <span class="literal">null</span>;             <span class="comment">// 1. 验证登录</span></span><br><span class="line">        Map&lt;String, String&gt; reptile = reptile(skuUrl);  <span class="comment">// 2. 爬虫商品</span></span><br><span class="line">        <span class="keyword">return</span> createBase64(reptile);                   <span class="comment">// 3. 组装海报</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟登录</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Boolean <span class="title function_">login</span><span class="params">(String uId, String uPwd)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爬虫提取商品信息(登录后的优惠价格)</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Map&lt;String, String&gt; <span class="title function_">reptile</span><span class="params">(String skuUrl)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成商品海报信息</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title function_">createBase64</span><span class="params">(Map&lt;String, String&gt; goodsInfo)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个类是此设计模式的灵魂</li>
<li>定义可被外部访问的方法<code>generateGoodsPoster</code>，用于生成商品推广海报</li>
<li><code>generateGoodsPoster</code> 在方法中定义抽象方法的执行顺序 1 2 3 步</li>
<li>提供三个具体的抽象方法，让外部继承方实现；模拟登录(<code>login</code>)、模拟爬取(<code>reptile</code>)、生成海报(<code>createBase64</code>)</li>
</ul>
<p>模拟爬京东</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDNetMall</span> <span class="keyword">extends</span> <span class="title class_">NetMall</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JDNetMall</span><span class="params">(String uId, String uPwd)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(uId, uPwd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">login</span><span class="params">(String uId, String uPwd)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;模拟京东用户登录 uId：&#123;&#125; uPwd：&#123;&#125;&quot;</span>, uId, uPwd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">reptile</span><span class="params">(String skuUrl)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> HttpClient.doGet(skuUrl);</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">p9</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(?&lt;=title\\&gt;).*(?=&lt;/title)&quot;</span>);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">m9</span> <span class="operator">=</span> p9.matcher(str);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        <span class="keyword">if</span> (m9.find()) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, m9.group());</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(<span class="string">&quot;price&quot;</span>, <span class="string">&quot;5999.00&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;模拟京东商品爬虫解析：&#123;&#125; | &#123;&#125; 元 &#123;&#125;&quot;</span>, map.get(<span class="string">&quot;name&quot;</span>), map.get(<span class="string">&quot;price&quot;</span>), skuUrl);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createBase64</span><span class="params">(Map&lt;String, String&gt; goodsInfo)</span> &#123;</span><br><span class="line">        <span class="type">BASE64Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>();</span><br><span class="line">        logger.info(<span class="string">&quot;模拟生成京东商品base64海报&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> encoder.encode(JSON.toJSONString(goodsInfo).getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>模拟登录</li>
<li>爬取信息，这里只是把<code>title</code>的信息爬取后的结果截取出来。</li>
<li>模拟创建<code>base64</code>图片的方法</li>
</ul>
<p>模拟爬淘宝</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaoBaoNetMall</span> <span class="keyword">extends</span> <span class="title class_">NetMall</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaoBaoNetMall</span><span class="params">(String uId, String uPwd)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(uId, uPwd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">login</span><span class="params">(String uId, String uPwd)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;模拟淘宝用户登录 uId：&#123;&#125; uPwd：&#123;&#125;&quot;</span>, uId, uPwd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">reptile</span><span class="params">(String skuUrl)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> HttpClient.doGet(skuUrl);</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">p9</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(?&lt;=title\\&gt;).*(?=&lt;/title)&quot;</span>);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">m9</span> <span class="operator">=</span> p9.matcher(str);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        <span class="keyword">if</span> (m9.find()) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, m9.group());</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(<span class="string">&quot;price&quot;</span>, <span class="string">&quot;4799.00&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;模拟淘宝商品爬虫解析：&#123;&#125; | &#123;&#125; 元 &#123;&#125;&quot;</span>, map.get(<span class="string">&quot;name&quot;</span>), map.get(<span class="string">&quot;price&quot;</span>), skuUrl);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createBase64</span><span class="params">(Map&lt;String, String&gt; goodsInfo)</span> &#123;</span><br><span class="line">        <span class="type">BASE64Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>();</span><br><span class="line">        logger.info(<span class="string">&quot;模拟生成淘宝商品base64海报&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> encoder.encode(JSON.toJSONString(goodsInfo).getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟爬当当</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DangDangNetMall</span> <span class="keyword">extends</span> <span class="title class_">NetMall</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DangDangNetMall</span><span class="params">(String uId, String uPwd)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(uId, uPwd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">login</span><span class="params">(String uId, String uPwd)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;模拟当当用户登录 uId：&#123;&#125; uPwd：&#123;&#125;&quot;</span>, uId, uPwd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">reptile</span><span class="params">(String skuUrl)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> HttpClient.doGet(skuUrl);</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">p9</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(?&lt;=title\\&gt;).*(?=&lt;/title)&quot;</span>);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">m9</span> <span class="operator">=</span> p9.matcher(str);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        <span class="keyword">if</span> (m9.find()) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, m9.group());</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(<span class="string">&quot;price&quot;</span>, <span class="string">&quot;4548.00&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;模拟当当商品爬虫解析：&#123;&#125; | &#123;&#125; 元 &#123;&#125;&quot;</span>, map.get(<span class="string">&quot;name&quot;</span>), map.get(<span class="string">&quot;price&quot;</span>), skuUrl);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createBase64</span><span class="params">(Map&lt;String, String&gt; goodsInfo)</span> &#123;</span><br><span class="line">        <span class="type">BASE64Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>();</span><br><span class="line">        logger.info(<span class="string">&quot;模拟生成当当商品base64海报&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> encoder.encode(JSON.toJSONString(goodsInfo).getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<ul>
<li>通过上面的实现可以看到<code>模版模式</code>在定义统一结构也就是执行标准上非常方便，也就很好的控制了后续的实现者不用关心调用逻辑，按照统一方式执行。那么类的继承者只需要关心具体的业务逻辑实现即可。</li>
<li>另外模版模式也是为了解决子类通用方法，放到父类中设计的优化。让每一个子类只做子类需要完成的内容，而不需要关心其他逻辑。这样提取公用代码，行为由父类管理，扩展可变部分，也就非常有利于开发拓展和迭代。</li>
</ul>
<h3 id="10、访问者模式"><a href="#10、访问者模式" class="headerlink" title="10、访问者模式"></a>10、访问者模式</h3><p>访问者要解决的核心事项是，在一个稳定的数据结构下，例如用户信息、雇员信息等，增加易变的业务访问逻辑。为了增强扩展性，将这两部分的业务解耦的一种设计模式。</p>
<p><strong>业务场景</strong>：对于学生和老师，家长和校长不同的视角关注的重点不一样，也就是访问的业务不一样。</p>
<p>那么这样<code>学生</code>和<code>老师</code>就是一个固定信息的内容，而想让不同视角的用户获取关心的信息，就比较适合使用观察者模式来实现，从而让实体与业务解耦，增强扩展性。<strong>但观察者模式的整体类结构相对复杂，需要梳理清楚再开发</strong></p>
<p>关于这个案例的核心逻辑实现，有以下几点；</p>
<ol>
<li>建立用户抽象类和抽象访问方法，再由不同的用户实现；老师和学生。</li>
<li>建立访问者接口，用于不同人员的访问操作；校长和家长。</li>
<li>最终是对数据的看板建设，用于实现不同视角的访问结果输出。</li>
</ol>
<p><strong>访问者模式模型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/itstack-demo-design-22-04.png" alt="访问者模式模型结构"></p>
<p>在这里有一个关键的点非常重要，也就是整套设计模式的核心组成部分；<code>visitor.visit(this)</code>，这个方法在每一个用户实现类里，包括；<code>Student</code>、<code>Teacher</code>。</p>
<p><strong>定义用户抽象类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基础用户信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;      <span class="comment">// 姓名</span></span><br><span class="line">    <span class="keyword">public</span> String identity;  <span class="comment">// 身份；重点班、普通班 | 特级教师、普通教师、实习教师</span></span><br><span class="line">    <span class="keyword">public</span> String clazz;     <span class="comment">// 班级</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, String identity, String clazz)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.identity = identity;</span><br><span class="line">        <span class="built_in">this</span>.clazz = clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心访问方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Visitor visitor)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义抽象核心方法，<code>abstract void accept(Visitor visitor)</code>，这个方法是为了让后续的用户具体实现者都能提供出一个访问方法，共外部使用。</li>
</ul>
<p>实现用户信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> <span class="keyword">extends</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Teacher</span><span class="params">(String name, String identity, String clazz)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, identity, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Visitor visitor)</span> &#123;</span><br><span class="line">        visitor.visit(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 升本率</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">entranceRatio</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BigDecimal.valueOf(Math.random() * <span class="number">100</span>).setScale(<span class="number">2</span>, BigDecimal.ROUND_HALF_UP).doubleValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, String identity, String clazz)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, identity, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Visitor visitor)</span> &#123;</span><br><span class="line">        visitor.visit(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">ranking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>) (Math.random() * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>accept</code>方法中，提供了本地对象的访问；<code>visitor.visit(this)</code>，这块需要加深理解。</li>
<li>老师和学生类又都单独提供了各自的特性方法；升本率(<code>entranceRatio</code>)、排名(<code>ranking</code>)，类似这样的方法可以按照业务需求进行扩展。</li>
</ul>
<p><strong>定义数据访问接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Visitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问学生信息</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(Student student)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问老师信息</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(Teacher teacher)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现数据访问接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Principal</span> <span class="keyword">implements</span> <span class="title class_">Visitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Principal.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;学生信息 姓名：&#123;&#125; 班级：&#123;&#125;&quot;</span>, student.name, student.clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(Teacher teacher)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;学生信息 姓名：&#123;&#125; 班级：&#123;&#125; 升学率：&#123;&#125;&quot;</span>, teacher.name, teacher.clazz, teacher.entranceRatio());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Parent</span> <span class="keyword">implements</span> <span class="title class_">Visitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Parent.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;学生信息 姓名：&#123;&#125; 班级：&#123;&#125; 排名：&#123;&#125;&quot;</span>, student.name, student.clazz, student.ranking());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(Teacher teacher)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;老师信息 姓名：&#123;&#125; 班级：&#123;&#125; 级别：&#123;&#125;&quot;</span>, teacher.name, teacher.clazz, teacher.identity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>数据看版</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataView</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; userList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;User&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DataView</span><span class="params">()</span> &#123;</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;谢飞机&quot;</span>, <span class="string">&quot;重点班&quot;</span>, <span class="string">&quot;一年一班&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;windy&quot;</span>, <span class="string">&quot;重点班&quot;</span>, <span class="string">&quot;一年一班&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;大毛&quot;</span>, <span class="string">&quot;普通班&quot;</span>, <span class="string">&quot;二年三班&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;Shing&quot;</span>, <span class="string">&quot;普通班&quot;</span>, <span class="string">&quot;三年四班&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Teacher</span>(<span class="string">&quot;BK&quot;</span>, <span class="string">&quot;特级教师&quot;</span>, <span class="string">&quot;一年一班&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Teacher</span>(<span class="string">&quot;娜娜Goddess&quot;</span>, <span class="string">&quot;特级教师&quot;</span>, <span class="string">&quot;一年一班&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Teacher</span>(<span class="string">&quot;dangdang&quot;</span>, <span class="string">&quot;普通教师&quot;</span>, <span class="string">&quot;二年三班&quot;</span>));</span><br><span class="line">        userList.add(<span class="keyword">new</span> <span class="title class_">Teacher</span>(<span class="string">&quot;泽东&quot;</span>, <span class="string">&quot;实习教师&quot;</span>, <span class="string">&quot;三年四班&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 展示</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">(Visitor visitor)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">            user.accept(visitor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">DataView</span> <span class="variable">dataView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataView</span>();      </span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;\r\n家长视角访问：&quot;</span>);</span><br><span class="line">    dataView.show(<span class="keyword">new</span> <span class="title class_">Parent</span>());     <span class="comment">// 家长</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;\r\n校长视角访问：&quot;</span>);</span><br><span class="line">    dataView.show(<span class="keyword">new</span> <span class="title class_">Principal</span>());  <span class="comment">// 校长</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p>在嵌入访问者模式后，可以让整个工程结构变得容易添加和修改。也就做到了系统服务之间的解耦，不至于为了不同类型信息的访问而增加很多多余的<code>if</code>判断或者类的强制转换。也就是通过这样的设计模式而让代码结构更加清晰。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.haungrd.top">Huang RD</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.haungrd.top/2023/02/20/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">http://www.haungrd.top/2023/02/20/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.haungrd.top" target="_blank">Huang Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a><a class="post-meta__tags" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></div><div class="post_share"><div class="social-share" data-image="https://www.huangrd.top/images/agentina/10.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/27/%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/13.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">面试题整理</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/17/JUC/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JUC</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/03/07/JavaSE%E5%A4%8D%E4%B9%A0%E6%8F%90%E5%8D%87/" title="JavaSE 复习提升"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/14.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-07</div><div class="title">JavaSE 复习提升</div></div></a></div><div><a href="/2023/02/13/java%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Java 集合源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-13</div><div class="title">Java 集合源码分析</div></div></a></div><div><a href="/2023/05/04/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%A4%8D%E4%B9%A0%E6%8F%90%E5%8D%87/" title="数据结构复习提升"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/14.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-04</div><div class="title">数据结构复习提升</div></div></a></div><div><a href="/2023/04/13/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AF%87-%E9%AB%98%E7%BA%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="数据结构篇-高级数据结构"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/12.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-13</div><div class="title">数据结构篇-高级数据结构</div></div></a></div><div><a href="/2023/04/10/%E7%AE%97%E6%B3%95%E7%AF%87-%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2/" title="算法篇-二分搜索"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-10</div><div class="title">算法篇-二分搜索</div></div></a></div><div><a href="/2023/04/11/%E7%AE%97%E6%B3%95%E7%AF%87-%E5%8F%8C%E6%8C%87%E9%92%88/" title="算法篇-双指针"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-11</div><div class="title">算法篇-双指针</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-text">Java 常见的设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%8E%9F%E5%88%99"><span class="toc-text">设计模式的原则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99-SRP"><span class="toc-text">1.单一职责原则 SRP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%BC%80%E6%94%BE-%E5%85%B3%E9%97%AD%E5%8E%9F%E5%88%99-OCP"><span class="toc-text">2.开放-关闭原则 OCP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99-LSP"><span class="toc-text">3.里氏替换原则 LSP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BE%9D%E8%B5%96%E5%80%92%E8%BD%AC%E5%8E%9F%E5%88%99-DIP"><span class="toc-text">4.依赖倒转原则 DIP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99-ISP"><span class="toc-text">5.接口隔离原则 ISP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E8%BF%AA%E7%B1%B3%E7%89%B9%E6%B3%95%E5%88%99-LOD"><span class="toc-text">6.迪米特法则 LOD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E7%BB%84%E5%90%88-x2F-%E8%81%9A%E5%90%88%E5%A4%8D%E7%94%A8%E5%8E%9F%E5%88%99-CRP"><span class="toc-text">7.组合&#x2F;聚合复用原则 CRP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F"><span class="toc-text">一、创建型模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="toc-text">1、单例模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#static-%E9%A5%BF%E6%B1%89%E5%BC%8F"><span class="toc-text">static 饿汉式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E9%A5%BF%E6%B1%89%E5%BC%8F"><span class="toc-text">枚举饿汉式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%87%92%E6%B1%89%E5%BC%8F"><span class="toc-text">懒汉式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E6%A3%80%E9%94%81%E6%87%92%E6%B1%89%E5%BC%8F"><span class="toc-text">双检锁懒汉式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%B1%BB%E6%87%92%E6%B1%89%E5%BC%8F"><span class="toc-text">内部类懒汉式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CAS-AtomicReference-%E6%87%92%E6%B1%89%E5%BC%8F"><span class="toc-text">CAS (AtomicReference)懒汉式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F"><span class="toc-text">2、工厂方法模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%B7%A5%E5%8E%82"><span class="toc-text">普通工厂</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82"><span class="toc-text">抽象工厂</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">3、建造者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F"><span class="toc-text">4、原型模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%BB%93%E6%9E%84%E6%80%A7%E6%A8%A1%E5%BC%8F"><span class="toc-text">二、结构性模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F"><span class="toc-text">1、适配器模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E9%80%82%E9%85%8D%E5%99%A8-amp-%E5%AF%B9%E8%B1%A1%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">类适配器&amp;对象适配器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">接口适配器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F"><span class="toc-text">2、桥接模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F"><span class="toc-text">3、组合模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F"><span class="toc-text">4、装饰器模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F"><span class="toc-text">5、外观模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="toc-text">6、享元模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-text">7、代理模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F"><span class="toc-text">三、行为型模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-text">1、责任链模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">2、命令模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F"><span class="toc-text">3、迭代器模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">4、中介者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F"><span class="toc-text">5、备忘录模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">6、观察者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="toc-text">7、状态模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-text">8、策略模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F"><span class="toc-text">9、模板模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">10、访问者模式</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Huang RD</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>数据库 | Huang Blog</title><meta name="author" content="Huang RD"><meta name="copyright" content="Huang RD"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="数据库总结整体概述  一、绪论（Introduction）  数据库系统 由 数据库、数据库管理系统、应用系统和数据库管理员组成 数据管理的三个阶段：  人工管理系统 文件系统阶段 数据库系统阶段  数据库结构特点：  数据结构化 数据共享性高、冗余度低且易拓展 数据独立性高 数据有数据库管理系统统一管理和控制  1、数据库基本概念数据库的四个基本概念：   数据 data 数据库 DataBas">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库">
<meta property="og:url" content="http://www.haungrd.top/2023/02/15/%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">
<meta property="og:site_name" content="Huang Blog">
<meta property="og:description" content="数据库总结整体概述  一、绪论（Introduction）  数据库系统 由 数据库、数据库管理系统、应用系统和数据库管理员组成 数据管理的三个阶段：  人工管理系统 文件系统阶段 数据库系统阶段  数据库结构特点：  数据结构化 数据共享性高、冗余度低且易拓展 数据独立性高 数据有数据库管理系统统一管理和控制  1、数据库基本概念数据库的四个基本概念：   数据 data 数据库 DataBas">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.huangrd.top/images/agentina/7.jpg">
<meta property="article:published_time" content="2023-02-15T08:12:57.000Z">
<meta property="article:modified_time" content="2023-02-20T12:07:39.145Z">
<meta property="article:author" content="Huang RD">
<meta property="article:tag" content="数据库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.huangrd.top/images/agentina/7.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.haungrd.top/2023/02/15/%E6%95%B0%E6%8D%AE%E5%BA%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '数据库',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-20 20:07:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://getwallpapers.com/wallpaper/full/a/1/8/1057222-free-download-cool-nature-backgrounds-1920x1200-windows-10.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">56</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://www.huangrd.top/images/agentina/7.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Huang Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">数据库</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-15T08:12:57.000Z" title="发表于 2023-02-15 16:12:57">2023-02-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-20T12:07:39.145Z" title="更新于 2023-02-20 20:07:39">2023-02-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>72分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="数据库"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="数据库总结"><a href="#数据库总结" class="headerlink" title="数据库总结"></a>数据库总结</h1><h2 id="整体概述"><a href="#整体概述" class="headerlink" title="整体概述"></a>整体概述</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230215182550687.png" alt="image-20230215182550687"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230215182527425.png" alt="image-20230215182527425"></p>
<h2 id="一、绪论（Introduction）"><a href="#一、绪论（Introduction）" class="headerlink" title="一、绪论（Introduction）"></a>一、绪论（Introduction）</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/1.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%A4%8D%E4%B9%A0%E8%AE%A1%E5%88%92.png" alt="复习计划"></p>
<p>数据库系统 由 数据库、数据库管理系统、应用系统和数据库管理员组成</p>
<p>数据管理的三个阶段：</p>
<ol>
<li>人工管理系统</li>
<li>文件系统阶段</li>
<li>数据库系统阶段</li>
</ol>
<p>数据库结构特点：</p>
<ul>
<li>数据结构化</li>
<li>数据共享性高、冗余度低且易拓展</li>
<li>数据独立性高</li>
<li>数据有数据库管理系统统一管理和控制</li>
</ul>
<h3 id="1、数据库基本概念"><a href="#1、数据库基本概念" class="headerlink" title="1、数据库基本概念"></a>1、数据库基本概念</h3><p>数据库的四个基本概念：</p>
<blockquote>
<ol>
<li>数据 data</li>
<li>数据库 DataBase DB </li>
<li>数据库管理系统 DataBase Management System DBMS</li>
<li>数据库系统 DataBase System DBS</li>
</ol>
</blockquote>
<p><strong>数据</strong></p>
<ul>
<li>描述事物的符号 （数据的定义）</li>
<li>数据库中存储的基本对象</li>
<li>数字、文字、图形、声音、语言等多种表现形式</li>
<li>数据符号 + 语义→→数据、</li>
</ul>
<p><strong>数据库</strong></p>
<ul>
<li>存储在计算机内、有组织、可共享的数据集合 </li>
<li>DB数据，按一定的数据模型组织、描述和存储 </li>
<li>数据冗余度小，数据独立性和扩展性高</li>
</ul>
<p><strong>DBS</strong></p>
<p>DBS 的组成部分：</p>
<ul>
<li>硬件：计算机（磁盘→ 数据库&#x2F;DB&#x2F;磁盘文件）</li>
<li>软件：数据库管理系统（DBMS）、数据库应用系统（DBAS）</li>
<li>个人：数据库管理员（DBA）、数据库用户</li>
</ul>
<p>DBS 的软件框架：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124164403423.png" alt="image-20221124164403423"></p>
<p><strong>DBS逻辑结构</strong>：</p>
<p><code>三级模式、两级映射</code></p>
<p>三级模式：用户模式（外模式 视图view）、逻辑模式（模式 表table）、存储模式（内模式 磁盘文件）、</p>
<ul>
<li>用户模式：外模式 –&gt; view</li>
<li>逻辑模式：模式 –&gt;table</li>
<li>物理模式：内模式 –&gt;disk file</li>
</ul>
<p>模式描述的是数据的全局逻辑结构，外模式描述的是数据的局部逻辑结构。</p>
<p>两级映射与数据独立性：</p>
<ul>
<li><p>外模式&#x2F;模式映射 1 ：n</p>
<p>模式改变，由DBA调整各外模式&#x2F;模式映像， 可使外模式不变，支撑应用程序不修改， 保证数据与程序的逻辑独立性。</p>
</li>
<li><p>模式&#x2F;内模式映射 1 ： 1</p>
<p>数据库的存储结构改变，由DBA调整模式&#x2F;内模式映像，可使模式不变， 且无需修改应用程序，保证数据与程序的物理独立性。</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124165236961.png" alt="image-20221124165236961"></p>
<p>系统结构：</p>
<ul>
<li><p>Centralization(集中式)结构 </p>
<ul>
<li>DB物理上，在一个局域网中</li>
</ul>
</li>
<li><p>Distribution(分布式)结构 </p>
<ul>
<li>DB物理上或逻辑上，分布在不同的网络中 <ul>
<li>Client&#x2F;Server 结构 </li>
<li>Browser&#x2F;Server 结构 </li>
<li>Parallel (并行)结构</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>如何构建数据库？</strong></p>
<p>数据模型：对现实世界的一种抽象。是数据库系统的核心和基础。</p>
<p>分类：</p>
<ol>
<li>概念模型</li>
<li>逻辑模型和物理模型</li>
</ol>
<p><strong>概念模型包括</strong>：实体、属性、键、实体型等。表示方法E-R图</p>
<p><strong>数据模型分类</strong>：</p>
<p>• Network data model &#x2F; 网状模型</p>
<p>• Hierarchical data model &#x2F; 层次模型 </p>
<p><strong>• Relational data model &#x2F; 关系模型</strong> </p>
<p>• Object-Relational data model &#x2F;对象关系模型</p>
<p>关系数据库系统对层次&#x2F;网状数据库系统的重大改进是：</p>
<ul>
<li>形成了较为完善的数据库理论</li>
<li>将逐一记录的操作改进为支持记录集合的操作</li>
<li>消除了由用户建立指针的弊端</li>
</ul>
<p><strong>数据模型Data Model</strong></p>
<p>Network data model &#x2F; 网状模型</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124170638360.png" alt="image-20221124170638360"></p>
<p>Hierarchical data model &#x2F; 层次模型</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124170722311.png" alt="image-20221124170722311"></p>
<p><strong>Relational data model &#x2F; 关系模型</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124170850121.png" alt="image-20221124170850121"></p>
<p>Object-Relational data model &#x2F;对象关系模型</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124170910372.png" alt="image-20221124170910372"></p>
<p><strong>DBMS</strong></p>
<p>数据管理系统，位于用户程序 与 操作系统之间 (专用)软件 。</p>
<p>功能：（四大主要方面） </p>
<ul>
<li>数据定义—建库、建表、创建用户等。用 DDL 表达 </li>
<li>数据操纵—插入数据、修改和删除数据等。用 DML 表达 </li>
<li>DB 运行管理—数据使用者及其使用权限管理等。用 DCL 表达 </li>
<li>DB 建立和维护—数据库备份、回复等</li>
</ul>
<p><strong>总结概念和属性</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124171203610.png" alt="image-20221124171203610"></p>
<blockquote>
<p>对于一个表：</p>
<ul>
<li>整个表称为表、实体、关系。</li>
<li>表中的每一行行称为行、记录、元组。</li>
<li>表中的每一列称为列、字段、属性。</li>
</ul>
</blockquote>
<p><strong>第一范式</strong>：</p>
<p>在关系模型中，表的列必须包含</p>
<ul>
<li>单个值</li>
<li>非结构化值</li>
</ul>
<p>不满足第一范式的案例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124171445138.png" alt="image-20221124171445138"></p>
<p><strong>一些结构</strong></p>
<p>数据模型的组件：</p>
<ul>
<li>数据结构</li>
<li>数据操作</li>
<li>数据的约束条件</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124171810521.png" alt="image-20221124171810521"></p>
<h3 id="2、数据库用户"><a href="#2、数据库用户" class="headerlink" title="2、数据库用户"></a>2、数据库用户</h3><ol>
<li><p>最终用户<br>➢ Naive Users (Use Menu interface 常规用户). </p>
<p>➢ Casual Users (Compose SQL 偶然用户).</p>
</li>
<li><p>应用程序程序员<br>➢ （编写菜单和应用程序）</p>
</li>
<li><p>数据库管理员<br>➢ （DBA——管理DBMS、DB和DBAS）。</p>
</li>
</ol>
<h3 id="3、关系数据库概览"><a href="#3、关系数据库概览" class="headerlink" title="3、关系数据库概览"></a>3、关系数据库概览</h3><p>CAP数据库（小型电商数据库）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124172138663.png" alt="image-20221124172138663"></p>
<p>用到的表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Customers (cid, cname, city, discnt)</span><br><span class="line">Agents (aid, aname, city, <span class="keyword">percent</span>)</span><br><span class="line">Products (pid, pname, city, quantity, price)</span><br><span class="line">Orders (ordno, <span class="keyword">month</span>, cid, aid, pid, qty, dollars)</span><br></pre></td></tr></table></figure>

<p>Nomenclature (terms,术语): </p>
<p>➢ Tables &#x2F; Relations 表&#x2F;关系</p>
<p>➢ Columns &#x2F; Fields &#x2F;Attributes 列&#x2F;字段&#x2F;属性</p>
<p>➢ Rows &#x2F; Tuples 行&#x2F;元组</p>
<p>Eg. In CAP database （案例）</p>
<p>◆ products (pid, pname, city, quantity, price) </p>
<p>​	➢ Product — Table &#x2F; Relation </p>
<p>​	➢ pid — column &#x2F; field &#x2F; attribute</p>
<p>​	 ➢ (p01, pencil, Xi’an, 100, 0.2) — rows &#x2F; records &#x2F; tuples</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221124172513928.png" alt="image-20221124172513928"></p>
<h2 id="二、关系数据库-（The-Relational-Model）"><a href="#二、关系数据库-（The-Relational-Model）" class="headerlink" title="二、关系数据库 （The Relational Model）"></a>二、关系数据库 （The Relational Model）</h2><blockquote>
<ul>
<li>关系概念</li>
<li>关系概述</li>
</ul>
</blockquote>
<h3 id="1、-CAP-实例数据库"><a href="#1、-CAP-实例数据库" class="headerlink" title="1、 CAP 实例数据库"></a>1、 CAP 实例数据库</h3><p>笛卡尔积：</p>
<p>▪ Cartesian Product : 设S1,···,Sn为集合,它们的笛卡尔积为 S1 × S2 × ··· × Sn &#x3D; { (e1, e2 , ···, en) | ei∈Si, i&#x3D;1,···,n } </p>
<p>​	➢ Element (e1,e2, ···,en) called a n-tuple (n元组) </p>
<p>​	➢ Value “ei” in the element called a 分量 </p>
<p>◼ Relation: S1×S2×···×Sn的子集，称为关系 记成 R &#x3D; S1×S2×···×Sn </p>
<p>◼ Example1: CP &#x3D; CID × CNAME × CITY × DISCNT 其中有 T1&#x3D;(c003, Allied, Dallas, 8.00) T2&#x3D;(c001,Basice, Oshkosh, 18.20) </p>
<p>◼ Example2: Family &#x3D; women × men × child not all the tuples consist of a real exist family</p>
<h3 id="2、数据库系统组成"><a href="#2、数据库系统组成" class="headerlink" title="2、数据库系统组成"></a>2、数据库系统组成</h3><p>Note: R &#x3D; S1 × S2 ×···×Sn </p>
<p>▪ R—关系名 </p>
<p>▪ n—关系的目或度(degree). n&#x3D;1 一元关系，n&#x3D;2 二元关系 </p>
<p>▪ 每列单独命名—Attribute&#x2F;Field&#x2F;Column，n元关系有n个列 </p>
<p>▪ 若某属性组的值能唯一标识关系R中的一个Tuple&#x2F;Record&#x2F;Row，则该属性组 为Candidate Key。 仅当R中所有列构成的属性组才是它的候选码时，称该码 为All-Key(全码)。 </p>
<p>▪ 若R有多个Candidate Key（候选键），选包含属性较少的做Primary Key(主码)，候选码中 的诸属性为Prime Attribute(主属性)。Non Key Attribute(非码属性)。</p>
<p>▪ Example : orders&#x3D;{ ordno, month, cid, aid, pid, qty, dollars }</p>
<h3 id="3、关系规则"><a href="#3、关系规则" class="headerlink" title="3、关系规则"></a>3、关系规则</h3><p>关系模型应该遵循怎样的标准？</p>
<p><strong>规则1.第一范式规则。</strong><br>◆ 在关系模型中，它不能</p>
<ol>
<li><p>多值字段和 </p>
</li>
<li><p>结构化字段</p>
</li>
</ol>
<p>◆ 示例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125170859025.png" alt="image-20221125170859025"></p>
<p>✓ 解决方案1：使用新列更新表以适应重复项在不同的列上<br>✓ 解决方案2：创建两个表并在以后的查询中连接它们</p>
<p><strong>规则2.仅按内容访问行。</strong><br>▪ 解释：不能说“从顶部往下第三排”。（行或列没有顺序）<br>▪ 行标识：不允许对行使用“指针或行ID”。（大多数RDBMS通过按RID获取行来打破这一规则）<br><strong>规则3.唯一行。</strong><br>▪ 2行不能在所有属性中都相同</p>
<h3 id="4、键、超键及空值"><a href="#4、键、超键及空值" class="headerlink" title="4、键、超键及空值"></a>4、键、超键及空值</h3><p>[1] table key 键<br>又称候选密钥唯一标识所在行的属性组</p>
<p>[2]super key 超级键<br>用于标识唯一元组的字段组的值。<br>如果不一定，最小字段组将变为超级键。</p>
<p>[4] 每个表T至少有一个键。</p>
<p>[5] <strong>primary key 主键</strong><br>表T的主键是由DBA唯一标识T中的行。<br>因此，表关键字&#x3D;&#x3D;候选关键字➔➔ 超级密钥&#x3D;&#x3D;主键</p>
<p>[6] Null值<br>当特定的值未知或尚未定义。</p>
<h3 id="5、关系代数"><a href="#5、关系代数" class="headerlink" title="5、关系代数"></a>5、关系代数</h3><p>Relational Algebra (关系代数)</p>
<p> ➢ 简写RA. 任何 RDBMS 上, 对数据查询的数学表达式 (一种代数语言). </p>
<p>一些概念（废话）</p>
<p> • 现实世界中的各种实体、实体间的各种联系均用关系模型表示</p>
<p> • 关系模型由“关系数据结构、关系操作集合、关系完整性约束”组成</p>
<p> • 借助于集合代数等数学概念和方法来处理数据库中的数据</p>
<p><strong>两种类型的RA操作</strong>: </p>
<p>▪ 集合论（Set Theoretic） (depend on fact that table is a set of rows) 4种 </p>
<p>​	◆ 交、并、差、笛卡尔积 intersection, union, difference, cardinality product </p>
<p>▪ 传统操作（Native operations ）(depend on structure of tables) 4种 </p>
<p>​	◆ 选择、投影、连接、除 selection, projection, join, division</p>
<h3 id="6、集合论操作"><a href="#6、集合论操作" class="headerlink" title="6、集合论操作"></a>6、集合论操作</h3><ol>
<li>Compatible Table (相容表) 如果两个表具有相同的模式，则称它们是兼容的。</li>
<li>Set Theoretic Operations: R &amp; S are two compatible tables</li>
</ol>
<p>​		➢ Intersection（交）：结果为n元关系，由属于R也属于S的元组组成 R ∩ S&#x3D;{ t | t∈R ∧ t∈S } </p>
<p>​		➢ Union（并）：结果为n元关系，由属于R或属于S的元组组成 R∪S&#x3D;{ t | t∈R ∨ t∈S } </p>
<p>​		➢ Difference（差）：结果为n元关系，由属于R而不属于S的元组组成 R - S &#x3D; { t | t∈R ∧ t ∉ S } </p>
<p>​		➢ Extended Cartesian Product (广义笛卡尔积): R 与 S 可不相容，结果为 m+n列关系，共有m × n个元组 R × S &#x3D; { tr~ts | tr∈R ∧ ts∈S }</p>
<p>案例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125173134521.png" alt="image-20221125173134521"></p>
<p>笛卡尔积是集合的合并。</p>
<ol start="3">
<li>Assignment（赋值） &amp; Alias（别名）</li>
</ol>
<p>▪ Assignment, Alias:  S(B1, . . ., Bn) :&#x3D; R(A1, . . ., An) 赋值</p>
<p>▪ Alias: want a different table names with same attributes S :&#x3D; R 别名</p>
<p>▪ Save intermediate results（可以用来保存中间结果） T :&#x3D; (R ∩ S) - (R ∞ S) or T1 :&#x3D; (R ∩ S) T2 :&#x3D; (R∞S) T :&#x3D; T1 - T2</p>
<h3 id="7、传统关系操作"><a href="#7、传统关系操作" class="headerlink" title="7、传统关系操作"></a>7、传统关系操作</h3><ol>
<li><strong>The Projection 投影</strong></li>
</ol>
<p>[1]Projection: Head(R) &#x3D; A1, . . . , An 	T :&#x3D; R[Aj, . . . , Ak] </p>
<p>▪ T是R的子集，是R的部分列。、</p>
<p>▪ 参考书：R中选出若干属性组成新关系，从“列”角度操作.</p>
<p>𝝅𝑨 (𝑹) &#x3D; {𝒕 [𝑨] 𝒕𝝐𝑹} </p>
<p>[2]案例: List all customer names from the customers.</p>
<p>​				CN :&#x3D; CUSTOMERS [CNAME] </p>
<ol start="2">
<li><strong>The Selection 选择</strong></li>
</ol>
<p>[1] Selection: Head(R) &#x3D; A1, . . . , An  	R where C 	</p>
<p>C 是一个逻辑条件，可以从单行 C 的值中确定。 </p>
<ul>
<li><p>Ai a Aj : where a is a constant with “ &lt;, &gt;, &#x3D;, &lt;&#x3D;, &gt;&#x3D;, &lt;&gt; ”</p>
</li>
<li><p>C also can be withed form : C and C’, C or C’, not C </p>
</li>
<li><p>字符数据比较：左边起第一个不相同字符的ASCII码比较。</p>
</li>
</ul>
<p>▪ 参考书：从R中选择满足给定条件的元组。 “行”角度的运算, F为选择条件式. 也称限制(Restriction). 𝝈𝑭 (𝑹) &#x3D; {𝒕|𝒕𝝐𝑹 ⋀ 𝑭(𝒕) &#x3D; 𝒕𝒓𝒖𝒆}</p>
<p>[2] 案例: Find all the products stored in Dallas that cost more than $0.50 </p>
<p>​				PRODUCTS where city &#x3D; ‘Dallas’ and price &gt;&#x3D; 0.5 </p>
<p>​				𝝈𝒄𝒊𝒕𝒚&#x3D; ′𝑫𝒂𝒍𝒍𝒂𝒔 ′ 𝒂𝒏𝒅 𝒑𝒓𝒊𝒄𝒆&gt;&#x3D;𝟎.𝟓 (𝑷𝒓𝒐𝒅𝒖𝒄𝒕)</p>
<ol start="3">
<li><strong>The Join</strong></li>
</ol>
<p>[1]Join: R×S 中,以“ R 关系在 A 属性组的值”与“ S 在 B 属性组的值”比较，挑出满足“ tr[A] θ ts[B]”的元组. </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125180415487.png" alt="image-20221125180415487"></p>
<p>特1: Equijoin 等值连接 , 选A、B属性组中值相等的元组构成新关系。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125180458011.png" alt="image-20221125180458011"></p>
<p>特2： Natural Join 自然连接, 等值连接的基础上把重复列去掉 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125180506122.png" alt="image-20221125180506122"></p>
<p>【综上有】： Cartesian Product ⊃ Join ⊃ Equijoin ⊃ Natural Join</p>
<p>[2]另一说法： Cardinality Product、Equijoin、Natural Join区别 </p>
<ol>
<li>自然连接 一定是等值连接，但等值连接不一定是自然连接。 </li>
<li>等值连接 分量值相等，不一定是公共属性；而自然连接 要求相等的 分量须是公共属性(相容).</li>
<li>自然连接 两个关系中做比较的分量须是相同的属性组，且连接结果 中要去掉重复的属性列。</li>
</ol>
<p>[3]案例：</p>
<p>Join与其它运算间的关系： R、S两个表没有公共列时 R∞S &#x3D; R×S R、S两个表的列完全一致时 R∞S &#x3D; R∩S</p>
<p>[4]案例： We wish to find the names of customers who have ordered product p01. </p>
<p>过程：</p>
<p>​								T1:&#x3D; CUSTOMER ∞ ORDER </p>
<p>​								T2:&#x3D; CUSTOMER ∞ (ORDER where pid &#x3D; ‘p01’ ) </p>
<p>​								CP01:&#x3D;T2[cname] </p>
<p>简化：</p>
<p>​								CP01 :&#x3D; ( CUSTOMER ∞ (ORDER where pid &#x3D; ‘p01’) ) [cname]</p>
<ol start="5">
<li><strong>关系运算的优先级</strong></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125181146970.png" alt="image-20221125181146970"></p>
<ol start="6">
<li><strong>The Division Operation 除</strong></li>
</ol>
<p>Division: </p>
<p>Consider two tables R and S<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125181427400.png" alt="image-20221125181427400"></p>
<p>▪ 象集WX (R)：关系R(X, Y)中当tr[X] &#x3D;x1时，x1在R中的象集为R[X]上 值为x1的诸元组, 在Y属性值的子集. </p>
<p>▪ S上的投影： 𝑾𝑿(𝑹) &#x3D; {𝒕𝒓 [𝒀] |𝒕𝒓 ∈ 𝑹, 𝒕𝒓 [𝑿] &#x3D; 𝒙𝟏} 𝝅𝒀(𝑺) &#x3D; 𝑺[𝒀]<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125182046169.png" alt="image-20221125182046169"></p>
<p>[3] 案例：We want to extract (select) the customers who have placed orders for all products that ordered by C006. 我们希望提取（选择）买了 C006 顾客订购的所有产品下订单的客</p>
<p>a) Products that ordered by customer C006        </p>
<p>​				PC6 :&#x3D; ( ORDERS where cid &#x3D; ‘C006’ ) [ pid ] (C006 买过的货物号 pid)</p>
<p>b) All Order Projection: 						      	</p>
<p>​				CP :&#x3D; ORDERS [cid, pid] (所有的订单的 cid，pid)</p>
<p>c) who have placed orders for all products that ordered by C006.     </p>
<p>​				T :&#x3D; CP ÷ PC6 →→ T[cid] </p>
<h3 id="8、关系操作实例"><a href="#8、关系操作实例" class="headerlink" title="8、关系操作实例"></a>8、关系操作实例</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221125183028244.png" alt="image-20221125183028244"></p>
<h2 id="三、关系数据库标准语言SQL（Basic-SQL-Query-Language）"><a href="#三、关系数据库标准语言SQL（Basic-SQL-Query-Language）" class="headerlink" title="三、关系数据库标准语言SQL（Basic SQL Query Language）"></a>三、关系数据库标准语言SQL（Basic SQL Query Language）</h2><p>CAP 数据库</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230216182350175.png" alt="image-20230216182350175"></p>
<p>习题：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 相关习题</span><br><span class="line"><span class="comment">-- 三者同城</span></span><br><span class="line"><span class="keyword">select</span> cid,aid,pid <span class="keyword">from</span> agents a,products p,customers c <span class="keyword">where</span> a.city <span class="operator">=</span> c.city <span class="keyword">and</span> c.city <span class="operator">=</span> p.city</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 三者不同城</span></span><br><span class="line"><span class="keyword">select</span> cid,aid,pid <span class="keyword">from</span> agents a,products p,customers <span class="keyword">where</span> (cid,aid,pid)<span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> cid,aid,pid <span class="keyword">from</span> agents a,products p,customers c <span class="keyword">where</span> a.city <span class="operator">=</span> c.city <span class="keyword">and</span> c.city <span class="operator">=</span> p.city</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 找购买了全部商品的用户 除法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders(`<span class="keyword">month</span>`,cid,aid,pid,qty,dollars)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">70</span>),(<span class="string">&#x27;3&#x27;</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2900</span>),(<span class="string">&#x27;4&#x27;</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">7000</span>),(<span class="string">&#x27;5&#x27;</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">7000000</span>),(<span class="string">&#x27;6&#x27;</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">1</span>,<span class="number">1000000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">	<span class="keyword">select</span> cid,pid <span class="keyword">from</span> orders <span class="keyword">where</span> c.id<span class="operator">=</span>o.cid <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">		<span class="keyword">select</span> pid <span class="keyword">from</span> products <span class="keyword">where</span> o.pid<span class="operator">=</span>p.pid</span><br><span class="line">	)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- a03卖过的产品a06没卖过</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> pid <span class="keyword">from</span> orders o <span class="keyword">where</span> o.aid <span class="operator">=</span> <span class="number">3</span> <span class="keyword">and</span> o.pid <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> pid <span class="keyword">from</span> orders o2 <span class="keyword">where</span> o2.aid <span class="operator">=</span> <span class="number">6</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 姓名以N开头，没买过newyork东西的 c.cid like &#x27;n%&#x27; and  </span></span><br><span class="line"><span class="keyword">select</span> c.cid <span class="keyword">from</span> orders o, customers c, products p </span><br><span class="line"><span class="keyword">where</span> c.cname <span class="keyword">like</span> <span class="string">&#x27;n%&#x27;</span> <span class="keyword">and</span>   o.pid <span class="operator">=</span> p.pid <span class="keyword">and</span> o.cid <span class="operator">=</span> c.cid <span class="keyword">and</span> p.city <span class="operator">!=</span> <span class="string">&#x27;newyork&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询未购物的顾客</span></span><br><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers <span class="keyword">where</span> cid <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> cid <span class="keyword">from</span> orders)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计每个顾客，购物最大订单数</span></span><br><span class="line"><span class="keyword">select</span> cid,<span class="built_in">max</span>(dollars) <span class="keyword">from</span> orders <span class="keyword">group</span> <span class="keyword">by</span> cid</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计购物顾客的最大订单额均值</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(maxspent) <span class="keyword">from</span> (<span class="keyword">select</span> cid,<span class="built_in">max</span>(dollars) <span class="keyword">as</span> maxspent <span class="keyword">from</span> orders <span class="keyword">group</span> <span class="keyword">by</span> cid) <span class="keyword">as</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计每个aid卖的pid的数量</span></span><br><span class="line"><span class="keyword">select</span> aid,pid,<span class="built_in">sum</span>(qty) <span class="keyword">from</span> orders <span class="keyword">group</span> <span class="keyword">by</span> aid,pid</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询cid，他购买的每种pid平均数都&gt;300</span></span><br><span class="line"><span class="keyword">select</span> aid <span class="keyword">from</span> orders </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> aid</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">avg</span>(qty) <span class="operator">&gt;</span> <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计cid,sum(qty),只在a04买东西</span></span><br><span class="line"><span class="keyword">select</span> cid,<span class="built_in">sum</span>(qty) <span class="keyword">from</span> orders <span class="keyword">where</span> cid <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> cid <span class="keyword">from</span> orders <span class="keyword">where</span> aid <span class="operator">!=</span> <span class="number">4</span>)</span><br></pre></td></tr></table></figure>



<p>主线：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127143130651.png" alt="image-20221127143130651"></p>
<p>⚫ 如何从关系模型中实现关系数据库？<br>⚫ 如何使用数据库中的数据？<br>⚫ 如何将关系代数转换为计算机可以执行的指令？</p>
<blockquote>
<p>使用 <strong>SQL</strong> (Structured Query Language): 结构化查询语言</p>
</blockquote>
<h3 id="1、SQL-语言概述"><a href="#1、SQL-语言概述" class="headerlink" title="1、SQL 语言概述"></a>1、SQL 语言概述</h3><h4 id="SQL的分类和功能："><a href="#SQL的分类和功能：" class="headerlink" title="SQL的分类和功能："></a>SQL的分类和功能：</h4><p>分类：</p>
<ul>
<li>DDL: Data Define Language （数据定义语言）</li>
<li>DML: Data Manipulate Language （数据操纵语言）</li>
<li>DCL: Data Control Language （数据控制语言）</li>
</ul>
<p>功能：</p>
<ol>
<li>综合统一</li>
<li>高度非过程化</li>
<li>面向集合的操作方式</li>
<li>SQL以同一种语法方式提供两种使用方式</li>
<li>语言简洁，易学易用</li>
</ol>
<h3 id="2、建立数据库"><a href="#2、建立数据库" class="headerlink" title="2、建立数据库"></a>2、建立数据库</h3><h4 id="预先知识："><a href="#预先知识：" class="headerlink" title="预先知识："></a>预先知识：</h4><p>[1]交互式SQL：启动Oracle &#x2F;SQL Plus 、启动MySQL &#x2F;Workbench 或第三方数据库管理工具 Navicat、SQL developer 登录DBMS ；界面下发出SQL指令。 </p>
<p>[2] Login with DBMS must have following things </p>
<ul>
<li>An account&#x2F;user_id on DBMS </li>
<li>A password</li>
</ul>
<p>[3] 创建数据库、连接数据库、创建数据表 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 创建数据库：</span><br><span class="line"><span class="keyword">CREATE</span> SCHEMA db_xauat ; </span><br><span class="line"># 连接数据库：</span><br><span class="line"><span class="keyword">CONNECT</span> <span class="keyword">TO</span> db_xauat ; </span><br><span class="line"># 创建数据表：</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> myui (</span><br><span class="line">    uid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    pass <span class="type">char</span>(<span class="number">8</span>), </span><br><span class="line">    <span class="keyword">primary</span> key (uid) </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p> [4] SQL语句 (ORACLE&#x2F;MySQL中的SQL句结束符为“;”) </p>
<ul>
<li>DDL: eg. Create scheme, Create table</li>
<li>DCL: eg. Grant, Revoke </li>
<li>DML: eg. Select, Insert, Update, Delete</li>
</ul>
<h4 id="CREATE-TABLE-语句"><a href="#CREATE-TABLE-语句" class="headerlink" title="CREATE TABLE 语句"></a>CREATE TABLE 语句</h4><p>➢ [] the optional term &#x2F; 可选 </p>
<p>➢ | select one term from many &#x2F; 多选一 </p>
<p>➢ {} the optional and repeat term &#x2F;可选且可复选 </p>
<p>➢ ALL the Default term</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tablename (</span><br><span class="line">    colname datatype [ <span class="keyword">not</span> <span class="keyword">null</span> ]</span><br><span class="line">	&#123; , colname datatype [ <span class="keyword">not</span> <span class="keyword">null</span> ] … &#125;</span><br><span class="line">	[ , <span class="keyword">PRIMARY</span> KEY ( colname &#123; , colname … &#125; ) ]</span><br><span class="line">)</span><br><span class="line">参考：<span class="keyword">create</span> <span class="keyword">table</span> <span class="operator">&lt;</span>表名<span class="operator">&gt;</span>(、</span><br><span class="line">     <span class="operator">&lt;</span>列名<span class="operator">&gt;</span><span class="operator">&lt;</span>数据类型<span class="operator">&gt;</span>[列级完整性约束]</span><br><span class="line">	 &#123;，<span class="operator">&lt;</span>列名<span class="operator">&gt;</span><span class="operator">&lt;</span>数据类型<span class="operator">&gt;</span>[列级完整性约束]…&#125;</span><br><span class="line">	 [，<span class="operator">&lt;</span>表级完整性约束<span class="operator">&gt;</span>]</span><br><span class="line">）；</span><br></pre></td></tr></table></figure>

<ul>
<li>若完整性约束条件涉及该表的多列，则须定义为表级约束 </li>
<li>Datatype 中需指明“类型、长度”，DBMS 产品支持的 Datatype 不完全相同</li>
</ul>
<p>Example 1: Create tables of Customers, Agents, Products and Orders for CAP DB</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> customers (</span><br><span class="line">	cid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">	cname <span class="type">varchar</span>(<span class="number">13</span>), </span><br><span class="line">	city <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">	discnt <span class="type">real</span>, </span><br><span class="line">	<span class="keyword">primary</span> key (cid)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> agents (</span><br><span class="line">	aid <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">	aname <span class="type">varchar</span>(<span class="number">13</span>), </span><br><span class="line">	city <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">	<span class="keyword">percent</span> <span class="type">smallint</span>, </span><br><span class="line">	<span class="keyword">primary</span> key (aid)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> products (</span><br><span class="line">	pid <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">	pname <span class="type">varchar</span>(<span class="number">13</span>), </span><br><span class="line">	city <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">	quantity <span class="type">integer</span>, </span><br><span class="line">	price <span class="type">double precision</span>, </span><br><span class="line">	<span class="keyword">primary</span> key (pid)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orders (</span><br><span class="line">	ordno <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">	<span class="keyword">month</span> <span class="type">char</span>(<span class="number">3</span>), </span><br><span class="line">	cid <span class="type">char</span>(<span class="number">4</span>),</span><br><span class="line">	aid <span class="type">char</span>(<span class="number">3</span>), </span><br><span class="line">	pid <span class="type">char</span>(<span class="number">3</span>), </span><br><span class="line">	qty <span class="type">integer</span>, </span><br><span class="line">	dollars <span class="type">double precision</span>,</span><br><span class="line">	<span class="keyword">primary</span> key (ordno), # 主键</span><br><span class="line">	<span class="keyword">foreign</span> key(aid) <span class="keyword">references</span> agents(aid), # 外键</span><br><span class="line">	<span class="keyword">foreign</span> key(cid) <span class="keyword">references</span> customers(cid),</span><br><span class="line">	<span class="keyword">foreign</span> key(pid) <span class="keyword">references</span> products(pid) </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="3、简单-Select-句"><a href="#3、简单-Select-句" class="headerlink" title="3、简单 Select 句"></a>3、简单 Select 句</h3><p>如何查询数据库中的数据？</p>
<h4 id="SELECT-语法"><a href="#SELECT-语法" class="headerlink" title="SELECT 语法"></a>SELECT 语法</h4><p>[1] 句式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> [ <span class="keyword">all</span>∣<span class="keyword">distinct</span> ] <span class="operator">&lt;</span>目标列表达式<span class="operator">&gt;</span> [<span class="operator">&lt;</span>目标列表达式<span class="operator">&gt;</span>]…</span><br><span class="line"><span class="keyword">From</span> <span class="operator">&lt;</span>表名或视图名<span class="operator">&gt;</span>[，<span class="operator">&lt;</span>表名或视图名<span class="operator">&gt;</span>]…</span><br><span class="line"><span class="keyword">Where</span> <span class="operator">&lt;</span>条件表达式<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">Group</span> <span class="keyword">by</span> <span class="operator">&lt;</span>列名<span class="number">1</span><span class="operator">&gt;</span> [ <span class="keyword">Having</span><span class="operator">&lt;</span>条件表达式<span class="operator">&gt;</span>]</span><br><span class="line"><span class="keyword">Order</span> <span class="keyword">by</span> <span class="operator">&lt;</span>列名<span class="number">2</span><span class="operator">&gt;</span> [ <span class="keyword">ASC</span>∣<span class="keyword">DESC</span> ]；</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>[2] Select含义(功能)： </p>
<ul>
<li>依 where 子句的表达式，从 from 子句指定的表&#x2F;视图中，找满足条件的元组；</li>
<li>按 Select 目标列选出元组中的属性，形成查询结果集；</li>
<li>结果集按 Group 指出的列，相同值分为一组；满足 Having 条件的结果组输出；</li>
<li>输出的结果组，按 Order 指定的列值排序显示；ASC 为升序，DESC 为降序。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127151431918.png" alt="image-20221127151431918"></p>
<p>[4] Select与Relational Algebra（关系表达式）的关系 </p>
<ul>
<li>from 子句 &lt;&#x3D;&#x3D;&#x3D;&gt; Rel. Alg.中的“Relation” </li>
<li>where 子句 &lt;&#x3D;&#x3D;&#x3D;&gt; Rel. Alg.中的“Selection”运算 </li>
<li>select 子句 &lt;&#x3D;&#x3D;&#x3D;&gt; Rel. Alg.中的“Projection”运算 </li>
<li>group 子句：查询结果集按“列 i ”值分组，值相同的元组排在一组 </li>
<li>group 子句带having短语：满足having条件的结果组才输出. </li>
<li>order by 子句，查询结果还应按“列 j ”值排序.</li>
</ul>
<h4 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h4><p>Example 1. We wish to find the aids and names of agents that are based in New York . （找到驻纽约的代理人的name和aid）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127151827663.png" alt="image-20221127151827663"></p>
<p>Example 2. Display all values in every row of the customer.(显示客户每行中的所有值)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127154001065.png" alt="image-20221127154001065"></p>
<p>Example 3. Select all pids for which orders are placed.(选择所有订单的pid)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127154140192.png" alt="image-20221127154140192"></p>
<p>Example 4. Retrieve all (cname, aname) pairs where the customer places an order through the agent.（检索客户通过代理下单的所有（cname、aname））</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127154251379.png" alt="image-20221127154251379"></p>
<p>Example 5. Retrieve a table based on orders, with columns ordno, cid, aid, pid, and profit on order. Where the “profit” is calculated from “quantity and price of the product sold(sell) by subtracting(except) 60% for whole sale cost, the discount for the customer and the percent commission for the agent.</p>
<p>（根据订单检索表，列为ordno、cid、，aid、pid和profit 。如果“利润”是根据“数量和销售产品的价格减去整个销售成本的60%，客户的折扣和代理商的佣金百分比）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127154612320.png" alt="image-20221127154612320"></p>
<p>Example 6.  List all pairs of cids based in the same city.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127154651181.png" alt="image-20221127154651181"></p>
<p>Example 7. Get cids who order a product for which an order is also placed by agent a06. (找cids，它们订购的产品，a06也卖给过别人)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127154729994.png" alt="image-20221127154729994"></p>
<h3 id="4、子查询、谓词"><a href="#4、子查询、谓词" class="headerlink" title="4、子查询、谓词"></a>4、子查询、谓词</h3><h4 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h4><ul>
<li>选择语句出现在另一个选择条件中。</li>
<li>使用带有TRUE或FALSE的谓词和逻辑条件。</li>
</ul>
<p>Example 1. Retrieve cids of customers who place orders with agents in Duluth or Dallas. （检索向Duluth或Dallas代理商下单的客户的cid。）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127155233563.png" alt="image-20221127155233563"></p>
<p>Example 2. Retrieve information of agents based in Duluth or Dallas（检索Duluth或Dallas代理商的信息）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127155508931.png" alt="image-20221127155508931"></p>
<p>注意<strong>in</strong>的使用：</p>
<p>in用来比较一个元素是不是在这个集合中。</p>
<hr>
<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>[1] Uncorrelated Subquery（不相关子查询）<br>可以预先计算内部SQL语句（内部子查询完全独立于外部子查询）</p>
<p>[2] Correlated Subquery（相关子查询）<br>无法预先计算内循环；因为子查询使用来自外部Select的数据。</p>
<p>Example 1. (Correlated Subquery) Find cnames who order product p05.（相关子查询）查找订购产品p05的cnames。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127160220512.png" alt="image-20221127160220512"></p>
<p>Example 2.  (Uncorrelated Subquery) Get cnames who order product p07 from agent a03.（不相关子查询）获取从代理a03订购产品p07的cnames。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127160402745.png" alt="image-20221127160402745"></p>
<p>Example 2.  Retrieve ordno for all orders placed by customers in Duluth through agents in New York.（检索Duluth客户通过纽约代理商下达的所有订单的订单号。）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127160654460.png" alt="image-20221127160654460"></p>
<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>[1] Select statement is nonprocedural </p>
<p>[2] in predicate: expr [NOT] in (Subquery) | expr [NOT] in (val1{ , val2…})</p>
<h4 id="Quantified-Comparison-Predicate-量化比较谓词"><a href="#Quantified-Comparison-Predicate-量化比较谓词" class="headerlink" title="Quantified Comparison Predicate 量化比较谓词"></a>Quantified Comparison Predicate 量化比较谓词</h4><p>[1] Comparison Predicates 比较位次</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127161147003.png" alt="image-20221127161147003"></p>
<p>that “some” and “any” mean same thing.</p>
<p>Example 1.  Find all customers who have the same discount as that of any of the customers in Dallas or Boston.查找与Dallas or Boston的任何客户享有相同折扣的所有客户。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127161734576.png" alt="image-20221127161734576"></p>
<p>Example 2. Get cid of customers with discnt smaller than discnt of any customer who lives in Duluth. 获取比居住在Duluth的任何客户的折扣率都小的顾客的cid。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127162312651.png" alt="image-20221127162312651"></p>
<h4 id="等效关系："><a href="#等效关系：" class="headerlink" title="等效关系："></a>等效关系：</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127162434199.png" alt="image-20221127162434199"></p>
<h4 id="EXISTS-谓词"><a href="#EXISTS-谓词" class="headerlink" title="EXISTS 谓词"></a>EXISTS 谓词</h4><p>[1] Exists predicate: [NOT] EXIST (Subquery) </p>
<p>EXIST(subquery) is true &lt;&#x3D;&#x3D;&gt; subquery is a non-empty set </p>
<p>NOT EXIST(subquery) is true &lt;&#x3D;&#x3D;&gt; subquery is an empty set </p>
<p>[2] Example 1. Find cnames who place an order through a05.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127162733332.png" alt="image-20221127162733332"></p>
<p>Example 2. Retrieve all customer names where the customer does not place an order through ‘a05’.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127163118003.png" alt="image-20221127163118003"></p>
<h3 id="5、UNION-操作及-ALL-条件"><a href="#5、UNION-操作及-ALL-条件" class="headerlink" title="5、UNION 操作及 ALL 条件"></a>5、UNION 操作及 ALL 条件</h3><h4 id="UNION运算符"><a href="#UNION运算符" class="headerlink" title="UNION运算符"></a>UNION运算符</h4><p>[1] Union syntax : Subquery UNION [ALL] Subquery</p>
<p>[2]Example 1. We wish to list of cities where either a customer or an agent, or both, is based. </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127163340478.png" alt="image-20221127163340478"></p>
<h4 id="Division除法"><a href="#Division除法" class="headerlink" title="Division除法"></a>Division除法</h4><p>SQL “for all…” Conditions(全称量词) </p>
<p>[1] Example 1. Find cids of customers who place orders with ALL agents based in New York. （找cids，他的订单全都是New York的agents销售的）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127163715452.png" alt="image-20221127163715452"></p>
<p>Example 2. Get the aids of agents in New York or Duluth who place orders for all products costing more than a dollar. (找New York或Duluth的aids，他们销售所有单价&gt;1美元的产品) </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127163951055.png" alt="image-20221127163951055"></p>
<h3 id="6、SQL-高级语法"><a href="#6、SQL-高级语法" class="headerlink" title="6、SQL 高级语法"></a>6、SQL 高级语法</h3><h4 id="UNION、INTERSECT、EXCEPT"><a href="#UNION、INTERSECT、EXCEPT" class="headerlink" title="UNION、INTERSECT、EXCEPT"></a>UNION、INTERSECT、EXCEPT</h4><p>[1] form subquery {UNION [ALL] | INTERSECT [ALL] | EXCEPT [ALL] subquery} </p>
<p>[2] Example 1. Find cids who order both products p01 and p07.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127164616343.png" alt="image-20221127164616343"></p>
<p>Example 2.  Retrieve all cnames where the customer don’t place any order through agent a05.（未通过代理a05下单的所有cname）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127164707768.png" alt="image-20221127164707768"></p>
<h4 id="JOIN-IN"><a href="#JOIN-IN" class="headerlink" title="JOIN IN"></a>JOIN IN</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127165438956.png" alt="image-20221127165438956"></p>
<p>Example 1. Retrieve all cnames where the customer places at least two orders for the same product. 检索客户至少为同一产品下两个订单的所有cname。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127165546819.png" alt="image-20221127165546819"></p>
<p>Example1. Retrieve all customers who has buy at least one product costing less than $0.50. </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127165751321.png" alt="image-20221127165751321"></p>
<h4 id="Outer-Join"><a href="#Outer-Join" class="headerlink" title="Outer Join"></a>Outer Join</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221127165923586.png" alt="image-20221127165923586"></p>
<h3 id="7、集函数"><a href="#7、集函数" class="headerlink" title="7、集函数"></a>7、集函数</h3><p>[1] Set Functions</p>
<p> ▪ Five types : count, max, min, sum, avg</p>
<p> ▪ Operate on sets of values, return a single value	对多组值进行操作，返回单个值</p>
<p>[2] sql语法</p>
<p>Select <code>SET_functionName</code> ([ ALL | DISTINCT ] colname) from….. </p>
<p>Select COUNT(*) from……</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221128183942856.png" alt="image-20221128183942856"></p>
<p>Example 1. Please to determine the total quantity of product p03 that has been ordered.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(qty) <span class="keyword">as</span> TOTAL <span class="keyword">from</span> orders <span class="keyword">where</span> pid <span class="operator">=</span> <span class="string">&#x27;p03‘;</span></span><br></pre></td></tr></table></figure>

<p>Example 2. Get number of cities where customers are based. select count (distinct city) from customers;</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span> (<span class="keyword">distinct</span> city) <span class="keyword">from</span> customers;</span><br></pre></td></tr></table></figure>

<p>Comparing: </p>
<p>select count(* ) from customers;      &#x2F;* all the numbers of rows  *&#x2F;</p>
<p>select count(cid) from customers;    &#x2F;* null values not counted *&#x2F; </p>
<p>​														  &#x2F;* cid not null in customers *&#x2F;</p>
<p>select count(city) from customers;  &#x2F;* only if no null city values*&#x2F;</p>
<p>[3]限制:规定集合函数不允许出现与WHERE子句不兼容的情况</p>
<p>Example 3. List the cids who have a discount less than maximum discount.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Invalid <span class="keyword">SQL</span>:错误</span><br><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers <span class="keyword">where</span> discnt <span class="operator">&lt;</span> <span class="built_in">max</span>(discnt);</span><br><span class="line">#Effective <span class="keyword">SQL</span>:正确</span><br><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers</span><br><span class="line"><span class="keyword">where</span> discnt <span class="operator">&lt;</span> (<span class="keyword">select</span> <span class="built_in">max</span>(discnt) <span class="keyword">from</span> customers);</span><br></pre></td></tr></table></figure>

<p>Example 4. Find products ordered by at least two customers.查找至少两个客户订购的产品。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pid <span class="keyword">from</span> products <span class="keyword">where</span> <span class="number">2</span> <span class="operator">&lt;=</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> cid)…)</span><br></pre></td></tr></table></figure>

<p>[4] 处理null</p>
<p>▪ null is a special constant(常数) </p>
<p>▪ meaningful a value that is UNKNOWN</p>
<p>Example 5.  After adding a row (c007, Windix, Dallas, null) to the customers table, Pose the query to retrieve this row.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">SQL</span> effective有效</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> customers <span class="keyword">where</span> discnt <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line">#won’t be retrieve非法</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> customers <span class="keyword">where</span> discnt<span class="operator">&lt;=</span><span class="number">10</span> <span class="keyword">and</span> discnt<span class="operator">&gt;</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>Example 6. After adding the row (c007,Windix,Dallas,null) to customers table. We wish to find the average discount of all customers.</p>
<p>a) the null is discarded（抛弃，排除） </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(discnt) <span class="keyword">from</span> customers; </span><br></pre></td></tr></table></figure>

<p>b) A set function acting on a empty set </p>
<p>▪ count() returns zero for a empty set. </p>
<p>▪ sum(), avg(), max() and min() return the null value.</p>
<h3 id="8、分组GROUP"><a href="#8、分组GROUP" class="headerlink" title="8、分组GROUP"></a>8、分组GROUP</h3><p>如何将数据分类到不同的组中？</p>
<h4 id="GROUP、HAVING语法"><a href="#GROUP、HAVING语法" class="headerlink" title="GROUP、HAVING语法"></a>GROUP、HAVING语法</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [<span class="keyword">ALL</span><span class="operator">|</span><span class="keyword">DISTINCT</span>] &#123;<span class="operator">*</span><span class="operator">|</span>expr [[<span class="keyword">AS</span>] c_alias]&#123;,expr [[<span class="keyword">AS</span>] c_alias]...&#125;&#125;</span><br><span class="line"><span class="keyword">FROM</span> tableref &#123;, tabletrf...&#125;</span><br><span class="line">[<span class="keyword">WHERE</span> search_condition]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">column</span> &#123;, column...&#125; ]</span><br><span class="line">[<span class="keyword">HAVING</span> search_condition]</span><br><span class="line"><span class="operator">|</span> subquery <span class="keyword">UNION</span> [<span class="keyword">ALL</span>] <span class="operator">|</span> <span class="keyword">INTERSECT</span> [<span class="keyword">ALL</span>] <span class="operator">|</span> <span class="keyword">EXCEPT</span> [<span class="keyword">ALL</span>]</span><br><span class="line">[<span class="keyword">CORRESPONDING</span> [<span class="keyword">BY</span>] (colname &#123;, colname . . .&#125;)] subquery</span><br></pre></td></tr></table></figure>

<p>Example 1. Let’s create a query to calculate the total product quantity ordered of each individual product by each individual customer. (查订单中每个(pid, cid)对的订货数 ).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pid, cid, <span class="built_in">sum</span>(qty) <span class="keyword">as</span> TOTAL <span class="keyword">from</span> orders <span class="keyword">group</span> <span class="keyword">by</span> pid, cid;</span><br></pre></td></tr></table></figure>

<p>Example 2. Print out the aname, aid, pname, pid together with the total quantity each agent supplies of that product to customers c002 and c003.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> aname, a.aid, pname, p.pid, <span class="built_in">sum</span>(qty) <span class="keyword">as</span> total_qty</span><br><span class="line"><span class="keyword">from</span> agent a, products p, orders x</span><br><span class="line"><span class="keyword">where</span> x.cid <span class="keyword">in</span> (‘c002’,’c003’) <span class="keyword">and</span> x.aid<span class="operator">=</span>a.aid <span class="keyword">and</span> x.pid<span class="operator">=</span>p.pid</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> aid, pid;</span><br></pre></td></tr></table></figure>

<p>Example 4. Provided pids purchased by (sell to) at least two customers.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pid <span class="keyword">from</span> orders <span class="keyword">group</span> <span class="keyword">by</span> pid <span class="keyword">having</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> cid) <span class="operator">&gt;=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>Example 4. Pose a query to find the average, over all agents, of the maximum dollar sales made by each agent.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(t.x) <span class="keyword">from</span> (<span class="keyword">select</span> aid, <span class="built_in">max</span>(dollars) <span class="keyword">as</span> x <span class="keyword">from</span> orders <span class="keyword">group</span> <span class="keyword">by</span> aid) t;</span><br></pre></td></tr></table></figure>

<h3 id="9、完整-Select-句"><a href="#9、完整-Select-句" class="headerlink" title="9、完整 Select 句"></a>9、完整 Select 句</h3><ol>
<li>做Select语句的实验<br>a） FROM子句中所有表的笛卡尔积都已形成。<br>b） 消除WHERE条件中不满足的行(消去&#x2F;限制).<br>c） 重排行按照GROUP BY分组。<br>d） 然后消除不满足HAVING子句的组。<br>e） 计算Select Clause目标列表的表达式。<br>f） 如果存在关键字DISTINCT，则消除重复的行。这个UNION、INTERSECT、EXCEPT在每个子查询之后执行。<br>g） 如果存在ORDER BY，则对所有选定行的集合进行排序。</li>
</ol>
<p>Example 1. List all customers, agents and the dollar sales for pairs of customers and agents, and order the result from largest to smallest sales totals. Retain only those pairs for which the dollar amount is at least 900.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c.cname, c.cid, a.aname, a.aid, <span class="built_in">sum</span>(o.dollars) <span class="keyword">as</span> casales</span><br><span class="line"><span class="keyword">from</span> customers c, orders o, agents a</span><br><span class="line"><span class="keyword">where</span> c.cid <span class="operator">=</span> o.cid <span class="keyword">and</span> o.aid <span class="operator">=</span> a.aid</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> (c.cname,) c.cid, (a.aname,) a.aid</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">sum</span>(o.dollars) <span class="operator">&gt;=</span> <span class="number">900.00</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">5</span> <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Expressions, Predicates, Search_condition</li>
</ol>
<p>[1] expressions form expr &#x3D; num-expr | strv-expr | date-xpr | intv-expr | con-dexpr</p>
<p>[2] Data Types </p>
<p>▪ numeric value expressions </p>
<p>▪ string value expression </p>
<p>▪ datetime expression </p>
<p>▪ interval value expression</p>
<p> ▪ conditional expression</p>
<p>[3] Mathematical functions</p>
<p> abs(n), mod(n,b), sqrt(n). 	NOT standardized in SQL-99. </p>
<p>[4] Char &amp; string functions</p>
<ul>
<li>CHAR_LENGTH (str) </li>
<li>SUBSTRING (str FROM start [FOR length]) </li>
<li>TRIM ([[LEADING|TRAILING|BOTH] [set] FROM] str) </li>
<li>POSITION (str1 IN str2) </li>
<li>UPPER(strval), LOWER(strval)</li>
</ul>
<p>[5] TRUTH VALUES </p>
<p>▪ TRUE, FALSE or UNKNOW (‘U’ is not equivalent to F)</p>
<p>[6] Predicates </p>
<p>a) Comparison predicate: expr1 { expr2 | expr1 (Subquery)} </p>
<p>b) Between predicate: c.discnt between 10 and 12 </p>
<p>c) In predicate: expr [not] in (subquery) </p>
<p>d) Quantified predicate: expr [all |any |some] (subquery) </p>
<p>e) Exists predicate: [not] exists (subquery) f) Is null predicate: columnname is [not] null </p>
<p>g) Like predicate: columnname [not] like ‘pattern’</p>
<ol start="4">
<li>Summary of Predicates 谓词总汇</li>
</ol>
<p>[1]Comparison predicate 比较谓词</p>
<p>expr1 | expr1 (Subquery){&#x3D;, &lt;&gt;, &gt;, &lt;,&gt;&#x3D;, &lt;&#x3D;} </p>
<hr>
<p>Example 1. Listed cids of all customers with a discount less than the maximum discount. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers <span class="keyword">where</span> discnt <span class="operator">&lt;</span> (<span class="keyword">select</span> <span class="built_in">max</span>(discnt) <span class="keyword">from</span> customers); </span><br><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers <span class="keyword">where</span> discnt <span class="operator">&lt;</span> <span class="keyword">any</span>(<span class="keyword">select</span> discnt <span class="keyword">from</span> customers); </span><br></pre></td></tr></table></figure>

<hr>
<p>Example: Retrieve orders made by customers whose city come after ‘M’ in the alphabetic. ( 选 ”M” 以后字母开头的city ) </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> orders o <span class="keyword">where</span> <span class="string">&#x27;M&#x27;</span><span class="operator">&lt;</span>(<span class="keyword">select</span> city <span class="keyword">from</span> customers c <span class="keyword">where</span> c.cid<span class="operator">=</span>o.cid);</span><br></pre></td></tr></table></figure>

<p>[7] Like predicate: 模糊查询谓词</p>
<p>columnname [NOT] LIKE ‘pattern’ </p>
<p>▪ 通配符 </p>
<p>Underscore (_) Any single character 代替一个字符</p>
<p>Percent (%) Zero or more characters of any form 代替一个或者多个字符</p>
<p>Escape character (\ ） Precedes quoted literal character 在引用的文字字符之前，加上表示原意</p>
<p>All other characters  Represent themselves</p>
<p>Example 1. Retrieve all data of customers whose begins with the letter ‘A’. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> customers <span class="keyword">where</span> cname <span class="keyword">like</span> ‘A<span class="operator">%</span>’ ;</span><br></pre></td></tr></table></figure>

<p>Example 2. Retrieve cids of customers whose cname begins ‘Tip_’ and arbitary(any) number of character . </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers <span class="keyword">where</span> cname <span class="keyword">like</span> ‘Tip\_<span class="operator">%</span>’ <span class="keyword">escape</span> ‘\’; 	</span><br></pre></td></tr></table></figure>

<p>Example 3.9.7 Retrieve cids of customers whose cname starts with the sequence ‘ab\’ . </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> cid <span class="keyword">from</span> customers <span class="keyword">where</span> cname <span class="keyword">like</span> ‘ab\\<span class="operator">%</span>’ <span class="keyword">escape</span> ‘\’;</span><br></pre></td></tr></table></figure>

<h3 id="10、Insert、Update-和-Delete-句"><a href="#10、Insert、Update-和-Delete-句" class="headerlink" title="10、Insert、Update 和 Delete 句"></a>10、Insert、Update 和 Delete 句</h3><h4 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a>INSERT</h4><p>[1] Form </p>
<p>➢ 标准式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tablename [(<span class="keyword">column</span> &#123;, <span class="keyword">column</span>…&#125;)] &#123;<span class="keyword">VALUES</span> (expr <span class="operator">|</span> <span class="keyword">null</span> &#123; , expr <span class="operator">|</span> <span class="keyword">null</span>…&#125;) <span class="operator">|</span> subquery&#125;</span><br></pre></td></tr></table></figure>

<p> ➢ 插入子查询结果集 :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tablename [ colname[, colname…]） Subquery</span><br></pre></td></tr></table></figure>

<p>Example 1. Add a row specified values to the orders table. (no qty or dollars, so on this new row they are null)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders (ordno, <span class="keyword">month</span>, cid, aid, pid) <span class="keyword">values</span>(<span class="string">&#x27;1107&#x27;</span>, <span class="string">&#x27;aug&#x27;</span>, <span class="string">&#x27;c006&#x27;</span>, <span class="string">&#x27;a04&#x27;</span>, <span class="string">&#x27;p01&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>Example 2. Create a new table Swcusts of customers, and insert into all customers from Dallas and Austin.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> swcusts (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> customers <span class="keyword">where</span> city <span class="keyword">in</span> (<span class="string">&#x27;Dallas&#x27;</span>, <span class="string">&#x27;Austin&#x27;</span>) );</span><br></pre></td></tr></table></figure>

<h4 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h4><p>Form: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> tablename <span class="keyword">SET</span> colname <span class="operator">=</span> &#123;expr <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">|</span> (subquery)&#125; &#123;, &#123;<span class="keyword">column</span> <span class="operator">=</span> expr <span class="operator">|</span><span class="keyword">null</span> <span class="operator">|</span>(subquery)…&#125;&#125; [<span class="keyword">WHERE</span> search_condition];</span><br></pre></td></tr></table></figure>

<p> Example 1. Give All agents in New York a 10% raise in the percent commission they earn on an order. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> agents <span class="keyword">SET</span> <span class="keyword">percent</span> <span class="operator">=</span> <span class="number">1.1</span><span class="operator">*</span><span class="keyword">percent</span> <span class="keyword">WHERE</span> city <span class="operator">=</span> <span class="string">&#x27;New York&#x27;</span>; </span><br></pre></td></tr></table></figure>

<p>Example 2. Update the discnt values in rows of the Swcusts table created in Example 2. with more up-to-date discnt values from the customers table. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> swcusts <span class="keyword">set</span> discnt<span class="operator">=</span>(<span class="keyword">select</span> discnt <span class="keyword">from</span> customers c <span class="keyword">where</span> c.cid <span class="operator">=</span> swcusts.cid );</span><br></pre></td></tr></table></figure>

<h4 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h4><p>[1] Form: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> tablename [<span class="keyword">WHERE</span> search_condition];</span><br></pre></td></tr></table></figure>

<p>Example 2. Delete all agents in New York. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> agents <span class="keyword">where</span> city <span class="operator">=</span> <span class="string">&#x27;New York&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>Example 3. Delete agents who have total orders of less than $600. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> agents <span class="keyword">where</span> aid <span class="keyword">in</span> ( <span class="keyword">select</span> aid <span class="keyword">from</span> orders <span class="keyword">group</span> <span class="keyword">by</span> aid <span class="keyword">having</span> <span class="built_in">sum</span>(dollars) <span class="operator">&lt;</span> <span class="number">600</span> );</span><br></pre></td></tr></table></figure>

<p>[4] Notice: Table Drop 删除表结构</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> agents;</span><br></pre></td></tr></table></figure>





<h2 id="四、数据库编程（Program-to-Access-a-Database）"><a href="#四、数据库编程（Program-to-Access-a-Database）" class="headerlink" title="四、数据库编程（Program to Access a Database）"></a>四、数据库编程（Program to Access a Database）</h2><h3 id="1、嵌入式-SQL-C语言-Embedded-SQL"><a href="#1、嵌入式-SQL-C语言-Embedded-SQL" class="headerlink" title="1、嵌入式 SQL(C语言)Embedded SQL"></a>1、嵌入式 SQL(C语言)Embedded SQL</h3><h4 id="如何通过程序访问数据库中的数据？"><a href="#如何通过程序访问数据库中的数据？" class="headerlink" title="如何通过程序访问数据库中的数据？"></a>如何通过程序访问数据库中的数据？</h4><ol>
<li><p>SQL ：两种用法“<code>终端交互式</code>、<code>嵌入式</code>” (SQL 语法近似，细节有差异) </p>
</li>
<li><p>嵌入式 SQL：将 SQL 语言嵌入到某种高级语言中，实现对DB的操作。 主语言(宿主语言)属于面向过程的语言，实现程序的流程控制。</p>
</li>
</ol>
<p>➢ 嵌入式 SQL 的一般形式： </p>
<ol>
<li>加前缀： EXEC SQL</li>
<li>结束标志，随主语言语句的不同而不同</li>
<li>嵌入式 SQL 句分两类: <ol>
<li>Declaration Statement &#x2F;说明性语句 </li>
<li>Executable Statement &#x2F;可执行语句(DDL, DML, DCL)</li>
</ol>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exec sql begin declare section;</span><br><span class="line">	<span class="type">char</span> c_id[<span class="number">5</span>] = <span class="string">&quot;c001&quot;</span>, c_name[<span class="number">14</span>];</span><br><span class="line">exec sql end declare section;</span><br><span class="line"></span><br><span class="line">exec sql </span><br><span class="line">    select cname, discnt into :c_name, :c_discnt from customers where cid = :c_id;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221129111233373.png" alt="image-20221129111233373"></p>
<ol start="3">
<li><p>A Simple Program</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exec sql begin declare section;</span><br><span class="line">	<span class="type">char</span> c_id[<span class="number">5</span>] = <span class="string">&quot;c001&quot;</span>, c_name[<span class="number">14</span>];</span><br><span class="line">	<span class="type">float</span> c_discnt;</span><br><span class="line">exec sql end declare section;</span><br><span class="line"></span><br><span class="line">c_id = <span class="string">&quot;c005&quot;</span>; <span class="comment">//或提示用户输入custid</span></span><br><span class="line"></span><br><span class="line">exec sql </span><br><span class="line">    select cname, discnt into :c_name, :c_discnt from customers where cid = :c_id;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Customer name is %s, discount is %s\n&quot;</span>, c_name, c_discnt);</span><br></pre></td></tr></table></figure>

<p>[1] 嵌入式SQL语句的信号 : exec sql </p>
<p>对嵌入式 SQL句，DBMS 采用两种方式编译： </p>
<p>①预编译（Pre-compiler 目前使用较多） ②修改和扩充主语言，使之能处理 SQL</p>
<p>[2] 主机变量Host Variable<br>◼ 必须由SQL声明部分声明<br>◼ 用于嵌入式SQL语句，格式为<code>：c_id</code><br>◼ 在宿主语言中使用，格式为<code>c_id</code></p>
<p>[3] 注意：不能使用字符串来包含语句的一部分</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 非法操作</span><br><span class="line"><span class="type">char</span> cond[ ] = <span class="string">&quot; cid = &#x27;c003&#x27; and city = &#x27;Boston&#x27; &quot;</span>;</span><br><span class="line">exec sql </span><br><span class="line">    select cname into :custname from customers where :cond;</span><br></pre></td></tr></table></figure>

<p>[4] SQL CONNECT and DISCONNECT to DBMS</p>
<p>Connect：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec sql CONNECT TO target_DBname [AS connect_name] [USER username];</span><br><span class="line">exec sql CONNECT TO DEFAULT;</span><br></pre></td></tr></table></figure>

<p>Disconnect：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec sql DISCONNECT connect_name;</span><br><span class="line">exec sql DISCONNECT current;</span><br></pre></td></tr></table></figure>



<p>[5] COMMIT提交 and ROLLBACK回滚 statement</p>
<p>◼ 使用COMMIT语句提交数据到数据库，在Disconnect语句之前<br>◼ 使用ROLLBACK语句撤消不成功的任务，在Disconnect语句之前</p>
<p>[6] Example 1. the program prompts a user repeately input a cid and replies by printing its cname and discount, halting when user input an empty string</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;prompt.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">exec sql include sqlca; <span class="comment">// 引入 sqlca</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> cid_prompt[]=<span class="string">&quot;Please input customer id: &quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    exec sql begin declare section; <span class="comment">// 定义主变量</span></span><br><span class="line">    <span class="type">char</span> cust_id[<span class="number">5</span>],cust_name[<span class="number">14</span>],user_name[<span class="number">20</span>],user_pwd[<span class="number">20</span>];</span><br><span class="line">    <span class="type">float</span> cust_discnt;</span><br><span class="line">    exec sql end declare section;</span><br><span class="line"></span><br><span class="line">    exec sql whenever sqlerror <span class="keyword">goto</span> report-error; <span class="comment">// 定义错误的跳转</span></span><br><span class="line">    exec sql whenever <span class="keyword">not</span> found <span class="keyword">goto</span> no-found;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(user_name, <span class="string">&quot;Scott&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(user_pwd, <span class="string">&quot;Tiger&quot;</span>); </span><br><span class="line"></span><br><span class="line">    exec sql content :user_name identified by :user_pwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">prompt</span>(cid_prompt,<span class="number">1</span>,cust_id,<span class="number">4</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        exec sql select cname,discnt into :cust_name,:cust_discnt from customers where cid=:cust_id; <span class="comment">// 执行 sql</span></span><br><span class="line">        exec sql commit work ; <span class="comment">//提交sql并释放行上的读取锁定</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;Customer name is %s, discount is %f\n&quot;</span>, cust_name, cust_discnt);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">not</span>-found: <span class="built_in">printf</span>(<span class="string">&quot;Can’t find customer %s&quot;</span>, cust_id);</span><br><span class="line">    &#125;</span><br><span class="line">    exec sql commit release; <span class="comment">//关闭连接</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    report-error: <span class="built_in">print_dberror</span>();</span><br><span class="line">    exec sql rollback release; <span class="comment">//回滚数据</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;<span class="comment">//返回错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[7] C和数据库的字符串类型可能不同</p>
<p> char(5) in C, always contain ‘\0’ as end flag. </p>
<p>in DB，分 两种类型 char(5) and varchar(5)</p>
<p> 故: 嵌入了 SQL 的 C 程序里，两种语言之间字符赋值，可能有变数</p>
</li>
</ol>
<h4 id="如何按程序使用数据？"><a href="#如何按程序使用数据？" class="headerlink" title="如何按程序使用数据？"></a>如何按程序使用数据？</h4><p>主语言和SQL的关系</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221129120401136.png" alt="image-20221129120401136"></p>
<p>◼ 向主语言传递 SQL 的执行状态，用 SQL Communication Area (SQLCA) 或 Indicator Variable 指示变量</p>
<p>◼ 主语言向 SQL 提供参数用Host Variable；而SQL将 对DB 的处理结果交给 主语言时用 Host Variable 和 Cursor游标</p>
<p>[1] SQLCA：“结构类型”， ORACLE 中定义如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sqlca</span> &#123; </span><br><span class="line">    <span class="type">char</span> sqlcacaid[<span class="number">8</span>];</span><br><span class="line">    <span class="type">long</span> sqlcabc;</span><br><span class="line">    <span class="type">long</span> sqlcode; <span class="comment">//sql执行的状态值</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sqlerrm</span> &#123;<span class="type">unsigned</span> <span class="type">short</span> sqlerrml; <span class="type">char</span> sqlerrmc[<span class="number">70</span>];&#125;; <span class="comment">//sql的错误代码</span></span><br><span class="line">    <span class="type">char</span> sqlerrp[<span class="number">8</span>];</span><br><span class="line">    <span class="type">long</span> sqlerrd[<span class="number">6</span>];<span class="comment">//sql进程的行数</span></span><br><span class="line">    <span class="type">char</span> sqlwarn[<span class="number">8</span>];</span><br><span class="line">    <span class="type">char</span> sqlext[<span class="number">8</span>]; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>◼ 使用前，先在主程序中声明SQL通信区的标识符： </p>
<p>​	 exec sql include sqlca; (sqlca 属DBMS已定义、默认的结构名) </p>
<p>◼ 要操作多个DB时，可声明新的SQL通信区标识符：</p>
<p>​	 struct sqlca sqlcb; (用sqlca 说明同结构的其它“通讯区标识”) exec sql include sqlcb;</p>
<p>◼ SQLCA结构中的常用域： </p>
<p>(1)Sqlca.sqlcode, 存放当前 SQL 句执行后的状况，有三种可能值： </p>
<p>​		➢ &#x3D;0: 代表Success，即sql 句执行成功，说明buffer中有数据可用 </p>
<p>​		➢ &gt;0: 代表not found ，即sql 句执行成功，但结果为 null </p>
<p>​		➢ &lt;0: 代表sqlwarning或error，即程序或系统故障，错误码的含义见子域 sqlca.sqlerrm. (2)Sqlca.sqlerrd[2]，当前 DML 语句执行后，处理的数据行数。</p>
<p>[3] Host variable (主变量) </p>
<p>① Definition in Host Language，there are Three Types of Host vars. </p>
<p>​		◼ Input host variable：由主语言对其赋值，在 SQL 句中引用。 </p>
<p>​		◼ Output host variable：由 SQL 语句对其赋值，在主语言中引用。 </p>
<p>​		◼ Indicator variable (指示变量)：整型变量，跟在(I&#x2F;O) Host Var之后，用 来“指示”主变量值的可用性。</p>
<p>②主变量、指示变量的说明： exec sql begin declare section; char cust_id; c_dis; exec sql end declare section; </p>
<p>③主变量、指示变量用法： </p>
<p>◆ 在SQL句中使用时，前面加冒号(:)作为标志，且指示变量应紧跟在主变量之后 </p>
<p>◆ 在 Host Language句中使用，不必加冒号。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exec sql begin declare section</span><br><span class="line"><span class="type">char</span> cust_id[], c_dis[];</span><br><span class="line"><span class="type">int</span> c_ind;</span><br><span class="line">exec sql end declare section</span><br><span class="line">    </span><br><span class="line">cust_id=‘c002’;</span><br><span class="line"></span><br><span class="line">exec sql </span><br><span class="line">    select discnt into :c_dis :c_ind from customers where cid=:cust_id;</span><br><span class="line"><span class="keyword">if</span> (c_ind==<span class="number">0</span>) <span class="built_in">printf</span>(“The discount of %s is %d !\n”, cust_id, c_dis);</span><br></pre></td></tr></table></figure>

<p>⑤ Indicator var 跟在某个Host-Varible之后，指示 SQL执行后，此HostVarible值的合法性，其自身值也有三种可能： </p>
<p>➢ &#x3D; 0， not null, the value is assigned to the host-varible. </p>
<p>➢ &gt; 0， a truncated value is assigned to the host-varible. </p>
<p>➢ &#x3D; -1，is null, the host-varible value is not a meaningful. </p>
<p>[4] Cursor(游标) </p>
<p>①Cursor：DBMS为用户开设的Data buffer，存放 SQL 的执行结果集， buffer中有一默认指针，供用户逐一访问 Data Record。 </p>
<p>②Function： <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221129121317645.png" alt="image-20221129121317645"></p>
<p>③Using Method：four steps </p>
<p>​	a)定义游标 (declare cursor) </p>
<p>​	b)打开游标 (open cursor) 循环体中→ </p>
<p>​	c)推进游标 (fetch cursor)，并将当前指向的buffer数据 放入主变量中 </p>
<p>​	d)关闭游标 (close cursor)</p>
<h3 id="2、常见的嵌入式SQL语句"><a href="#2、常见的嵌入式SQL语句" class="headerlink" title="2、常见的嵌入式SQL语句"></a>2、常见的嵌入式SQL语句</h3><ol>
<li><p>Declare Cursor 定义游标</p>
<p>exec sql declare  cursor for  [Read only | For updata of colname]; </p>
<p>Notice: </p>
<p>​	◼ FOR UPDATE: promising to Update&#x2F;Delete rows through cursor </p>
<p>​	◼ READ ONLY: not promising to Update&#x2F;Delete rows through cursor </p>
</li>
<li><p>Cursor Open, Fetch and Close 打开、使用、关闭游标</p>
<p>​	[1] Cursor open: exec sql OPEN ; </p>
<p>​	[2] Cursor fetch: exec sql FETCH &lt; cursor_name &gt; INTO  {,…}; </p>
<p>​	[3] Cursor close: exec sql CLOSE &lt; cursor_name &gt;;</p>
<p>​	[4] Example 1. a GROUP BY Select statement listing agent ID values and sum of dollar orders by these agents for any customer ID provided by the user. GROUP BY Select语句列出了代理商的ID值和这些代理商针对用户提供的任何客户ID的美元订单总和。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TRUE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> “prompt.h</span></span><br><span class="line">exec sql include sqlca;</span><br><span class="line"></span><br><span class="line">exec sql begin declare section;</span><br><span class="line"><span class="type">char</span> cust_id[<span class="number">5</span>], agent_id[<span class="number">4</span>];</span><br><span class="line"><span class="type">double</span> dollar_sum;</span><br><span class="line">exec sql end declare section;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> cid_prompt[]=”Please input customer id: ”;</span><br><span class="line">    exec sql declare agent_dollars cursor <span class="keyword">for</span> select aid,<span class="built_in">sum</span>(dollars) from orders where cid = :cust_id group by aid;<span class="comment">//定义游标</span></span><br><span class="line">    exec sql whenever sqlerror <span class="keyword">goto</span> report-error; </span><br><span class="line">    exec sql whenever <span class="keyword">not</span> found <span class="keyword">goto</span> finish;</span><br><span class="line">    exec sql connect to testdb;<span class="comment">//连接数据库</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">prompt</span>(cid_prompt,<span class="number">1</span>,cust_id,<span class="number">4</span>))&gt;<span class="number">0</span>)<span class="comment">//输入</span></span><br><span class="line">    &#123; </span><br><span class="line">        exex sql open agent_dollars;<span class="comment">//开启游标</span></span><br><span class="line">        <span class="keyword">while</span> (TRUE) &#123; </span><br><span class="line">            exec sql fetch agent_dollars into :agent_id, :dollar_sum;<span class="comment">//使用游标</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s %11.2f\n&quot;</span>, agent_id, dollar_dum); &#125;</span><br><span class="line">            finish: exec sql close agent_dollars ;<span class="comment">//关闭游标</span></span><br><span class="line">            exec sql commit work; </span><br><span class="line">        &#125; </span><br><span class="line">    exec sql disconnect current ; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    report-error : <span class="built_in">print_dberror</span>();</span><br><span class="line">    exec sql rollback work ;</span><br><span class="line">    exec sql disconnect current ;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[5] C与嵌入式SQL之间的方法概述</p>
<p>游标：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221129122045375.png" alt="image-20221129122045375"></p>
<p>主变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221129122056720.png" alt="image-20221129122056720"></p>
<p>使用完数据库后：</p>
<p>◼ RDBMS用户并发数有限 </p>
<p>◼ 应避免长期占用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221129122129710.png" alt="image-20221129122129710"></p>
</li>
</ol>
<h4 id="嵌入式查询"><a href="#嵌入式查询" class="headerlink" title="嵌入式查询"></a>嵌入式查询</h4><ol>
<li><p>语法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXEC SQL SELECT [ALL|DISTINCT] expression&#123;, expr…&#125;</span><br><span class="line">INTO host_variable &#123; , host_variable… &#125;</span><br><span class="line">FROM tableref [corr_name] &#123;, tableref[corr_name] …&#125;</span><br><span class="line">[WHERE search_condition ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意点：</p>
<p>◼ 嵌入式select只能检索一行，因此GROUP BY、HAVING、UNION和ORDER BY子句不包含在其中<br>◼ 如果可以在不使用光标的情况下在程序中执行Select语句，仅当要检索的行数不超过一行时（零行&#x2F;一行）。</p>
</li>
<li><p>例题</p>
<p>已知学生信息表 students，其结构如下: Students(sno, sname, ssex, sage, sdepartment). 编程查询某系全体学生的信息，系名由用户在程序运行时输入。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TRUE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> “prompt.h”</span></span><br><span class="line"></span><br><span class="line">exec sql include sqlca;<span class="comment">//游标</span></span><br><span class="line">exec sql begin declare section;<span class="comment">//主变量声明</span></span><br><span class="line"><span class="type">char</span> hdept[<span class="number">10</span>], hsno[<span class="number">4</span>], hname[<span class="number">10</span>], hsex[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> hage;</span><br><span class="line">exec sql end declare section;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> msg[]=” Please input the department name: ”;</span><br><span class="line">    exec sql declare c_student cursor <span class="keyword">for</span> select sno, sname, ssex, sage, sdepartment from students where sdepartment = :hdept read only; <span class="comment">//定义游标</span></span><br><span class="line">    exec sql whenever sqlerror <span class="keyword">goto</span> report-error; </span><br><span class="line">    exec sql whenever <span class="keyword">not</span> found <span class="keyword">goto</span> finish; </span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">prompt</span>(msg,<span class="number">1</span>, hdept,<span class="number">10</span>))&gt;<span class="number">0</span>) &#123; <span class="comment">//输入</span></span><br><span class="line">        exec sql connect to testdb;<span class="comment">//建立连接</span></span><br><span class="line">        exec open c_student;<span class="comment">//打开游标</span></span><br><span class="line">        <span class="keyword">while</span> (TRUE) &#123; </span><br><span class="line">            exec sql fetch c_student into :hsno, :hname, :hsex, :hage;<span class="comment">//使用游标</span></span><br><span class="line">            <span class="keyword">if</span> (sqlca.sqlcode==success)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s %s %s %d\n&quot;</span>, hsno, hname, hsex, hage);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">break</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        finish: exec sql close c_student ;<span class="comment">//关闭游标</span></span><br><span class="line">        exec sql commit work; <span class="comment">//提交事务</span></span><br><span class="line">    &#125; </span><br><span class="line">    exec sql disconnect current ; <span class="comment">//关闭连接</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">    report-error : <span class="built_in">print_dberror</span>(); </span><br><span class="line">    exec sql rollback work ;<span class="comment">//回滚</span></span><br><span class="line">    exec sql disconnect current ;<span class="comment">//关闭连接</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="嵌入式删除"><a href="#嵌入式删除" class="headerlink" title="嵌入式删除"></a>嵌入式删除</h4><p>Embedded Delete </p>
<ol>
<li><p>Two forms of Delete statement </p>
<p>● Searched Delete 搜索删除</p>
<p>● Positioned Delete 定位删除</p>
</li>
<li><p>Embedded Delete 语法</p>
<p>statement exec sql DELETE FROM tablename [corr_name] [WHERE search_condition | WHERE CURRENT OF cursor_name</p>
</li>
<li><p>注意点</p>
<p>在Searched Delete中，sqlca。sqlcode和sqca。sqlerrd[2]的含义<br>➢ 确定要处理的行数。<br>➢ 未找到，当不返回行时。<br>➢ 发生执行错误时出错</p>
</li>
<li><p>Example 1. Delete all customers from the customers table who live in Duluth and have made no orders</p>
<p>a) In aSearched Delete</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sql <span class="keyword">delete</span> from customers c where c.city = ‘Duluth’ <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">exists</span> (select * from orders o where o.cid =c.cid) ;</span><br></pre></td></tr></table></figure>

<p>b) In a Positioned Delete: Declare a cursor to delete current row</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exec sql declare delcust cursor <span class="keyword">for</span> select cid from customers c where c.city = ‘Duluth’ <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">exists</span> (select * from orders o where o.cid = c.cid) <span class="keyword">for</span> update of cid;</span><br><span class="line">exec sql whenever <span class="keyword">not</span> found <span class="keyword">goto</span> skip;</span><br><span class="line">exec sql open delcust;</span><br><span class="line"><span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">    exec sql fetch delcust into :cust_id;</span><br><span class="line">    exec sql <span class="keyword">delete</span> from customers where current of delcust;&#125;</span><br><span class="line">skip : ……</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="嵌入式更新"><a href="#嵌入式更新" class="headerlink" title="嵌入式更新"></a>嵌入式更新</h4><p>[1] Two forms of Update statement </p>
<p>● Searched Update 查询更新</p>
<p>● Positioned Update — using a cursor 位置更新</p>
<p>[2] Forms of Embedded Searched Update statement </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sql UPDATE tablename [corr_name] SET colname1 = expr &#123; , colname2 = expr… &#125;[WHERE search_condition]; Notes: In Searched Update, sqlca.sqlcode <span class="keyword">and</span> sqlca.sqlerrd</span><br></pre></td></tr></table></figure>

<p>[2] contains information of : </p>
<p>➢ 确定要更新的行数。</p>
<p>➢ 未找到，当不返回行时。</p>
<p>➢ 发生执行错误时出错。</p>
<p>[3] 嵌入式定位更新语句的格式</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sql UPDATE tablename SET columnname=expr &#123; , column=expr… &#125; WHERE CURRENT OF cursor_name ;</span><br></pre></td></tr></table></figure>

<p>[4] Example 1：已知 students表，编程查询某系全体学生的信息，系名由用户在 程序运行时输入，根据用户要求修改其中某些学生的年龄。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TRUE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> “prompt.h”</span></span><br><span class="line">exec sql include sqlca;</span><br><span class="line">exec sql begin declare section;</span><br><span class="line">	<span class="type">char</span> hdept[<span class="number">10</span>], hsno[<span class="number">4</span>], hname[<span class="number">10</span>], hsex[<span class="number">2</span>];</span><br><span class="line">	<span class="type">int</span> hage;</span><br><span class="line">exec sql end declare section;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> msg[]=”Please input the department name: ”;</span><br><span class="line">    exec sql declare p_student cursor <span class="keyword">for</span> select sno, sname, ssex, sage, sdepartment from students where sdepartment = :hdept <span class="keyword">for</span> update of sage;</span><br><span class="line">    exec sql whenever sqlerror <span class="keyword">goto</span> report_error; </span><br><span class="line">    exec sql whenever <span class="keyword">not</span> found <span class="keyword">goto</span> finish; </span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">prompt</span>(msg,<span class="number">1</span>, hdept,<span class="number">10</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    	exec sql connect to testdb;</span><br><span class="line">    	exec sql open p_student;</span><br><span class="line">    	<span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">            exec sql fetch p_studen into :hsno, :hname, :hsex, :hage ;</span><br><span class="line">            <span class="keyword">if</span> (sqlca.sqlcode == success) &#123; </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s %s %s %d\n&quot;</span>, hsno, hname, hsex, hage);</span><br><span class="line">                <span class="built_in">printf</span>(“ Update the age of <span class="keyword">this</span> record ? ”);</span><br><span class="line">                <span class="built_in">scanf</span>(“%c”, ans);</span><br><span class="line">                <span class="keyword">if</span> (ans == ’y’) &#123; </span><br><span class="line">                    <span class="built_in">printf</span>(“ Input the <span class="keyword">new</span> age : ”); </span><br><span class="line">                    <span class="built_in">scanf</span>(“%d”, hage);</span><br><span class="line">                    exec sql update student set sage = :hage where current of p_student;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">break</span>; </span><br><span class="line">        &#125; </span><br><span class="line">……</span><br><span class="line">	finish: exec sql close p_student ;</span><br><span class="line">	exec sql commit work; </span><br><span class="line">    &#125; </span><br><span class="line">    exec sql disconnect current ; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    report_error : <span class="built_in">print_dberror</span>();</span><br><span class="line">    exec sql rollback work ;</span><br><span class="line">    exec sql disconnect current ;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h4 id="嵌入式插入"><a href="#嵌入式插入" class="headerlink" title="嵌入式插入"></a>嵌入式插入</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sql INSERT INTO tablename [ (columnname &#123; , columnname…&#125; ) ] &#123;<span class="built_in">VALUES</span> (expr &#123; , expr &#125; ) | Subquery &#125; ;</span><br></pre></td></tr></table></figure>

<p>In Insert Statement, sqlca.sqlcode and sqlca.sqlerrd[2] contains information: </p>
<p>➢ Success, to determine number of rows be processed. </p>
<p>➢ Not found, If no rows insert. </p>
<p>➢ Error, when an executed error is occurred.</p>
<h4 id="其他嵌入式sql"><a href="#其他嵌入式sql" class="headerlink" title="其他嵌入式sql"></a>其他嵌入式sql</h4><p>[1] They are: </p>
<ul>
<li>exec sql create table, </li>
<li>exec sql drop table, </li>
<li>exec sql alter table, </li>
<li>exec sql create view etc.</li>
</ul>
<p>[2] All of other Embedded SQL Statement, see in Appendix C.</p>
<h3 id="3、条件处理"><a href="#3、条件处理" class="headerlink" title="3、条件处理"></a>3、条件处理</h3><h4 id="Whenever"><a href="#Whenever" class="headerlink" title="Whenever"></a>Whenever</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sql WHENEVER condition action ;</span><br></pre></td></tr></table></figure>

<p>[1] 功能：无论何时允许我们在遇到错误和情况时控制执行</p>
<p>exec sql whenever sqlerror goto report_error ;</p>
<p>注意：“sqlerror”是条件，“goto report_error”是操作。</p>
<p>[2]Condition:</p>
<p>➢ SQLERROR</p>
<p>➢ NOT FOUND</p>
<p>➢ SQLWARNING</p>
<p>[3] Action </p>
<p>● CONTINUE </p>
<p>● GOTO label </p>
<p>● STOP </p>
<p>● DO function</p>
<p>[4]Example 1. Find the errors in following statement fragment</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Main</span>()&#123; </span><br><span class="line">	exec sql whenever sqlerror stop; <span class="comment">/* First whenever statement*/</span></span><br><span class="line">    ……</span><br><span class="line">    <span class="keyword">goto</span> s1;</span><br><span class="line">    ……</span><br><span class="line">    exec sql whenever sqlerror <span class="keyword">continue</span>; <span class="comment">/*Overrides Fisrt whenever*/</span></span><br><span class="line">    s1: exec sql update agents set percent = percent + <span class="number">1</span>;</span><br><span class="line">…… &#125;</span><br></pre></td></tr></table></figure>

<p>[5] Example 2. Find errors in following sequence statement.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Main</span>()&#123; </span><br><span class="line">    exec sql whenever sqlerror <span class="keyword">goto</span> handle_error; <span class="comment">/* First whenever */</span></span><br><span class="line">    <span class="function">exec sql create table <span class="title">customers</span> <span class="params">(cid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> null, cname …)</span> </span>;</span><br><span class="line">    ……</span><br><span class="line">    handle_error : exec sql whenever sqlerror <span class="keyword">continue</span>; <span class="comment">/*当Create table失败转入*/</span></span><br><span class="line">    exec sql drop table customers; <span class="comment">/*Drop表出错，转回First whenever, 死循环*/</span></span><br><span class="line">    exec sql disconnect;</span><br><span class="line">    <span class="built_in">printf</span> (“Could <span class="keyword">not</span> create customers table\n”);</span><br><span class="line">    <span class="keyword">return</span> –<span class="number">1</span>;</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[6]Example 1. Explicating the error processing in ORACLE.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">exec sql begin declare section;</span><br><span class="line"><span class="type">char</span> sqlstate[<span class="number">5</span>]; <span class="comment">/*Store the SQL state*/</span></span><br><span class="line">exec sql end declare section;</span><br><span class="line"></span><br><span class="line"><span class="function">exec sql create table <span class="title">custs</span> <span class="params">(cid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> null, cname varchar(<span class="number">13</span>), …)</span> </span>;</span><br><span class="line">sqlstate = <span class="built_in">str</span>(sqlca.sqlcode); <span class="comment">/* 检查 SQL 的执行状态,作相应处理 */</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">strcmp</span>(sqlstate,’<span class="number">82100</span>’) == <span class="number">0</span> ) <span class="comment">/* ORACLE, out of disk space? */</span></span><br><span class="line">&lt;call procedure to handle <span class="keyword">this</span> condition&gt;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(sqlstate,’<span class="number">00000</span>’ ) != <span class="number">0</span> ) &#123; <span class="comment">/* ORACLE, Another error? */</span></span><br><span class="line"><span class="keyword">goto</span> handle_error;</span><br><span class="line">exec sql whenever sqlerror <span class="keyword">goto</span> handle_error;</span><br><span class="line">…… &#125;</span><br><span class="line">handle_error ：……</span><br></pre></td></tr></table></figure>

<h4 id="通过主变量检查错误"><a href="#通过主变量检查错误" class="headerlink" title="通过主变量检查错误"></a>通过主变量检查错误</h4><p>[1] Example : Find discount of cid. Assume cid has been input. </p>
<p>​				Host Vars —— cust_id; cust_discnt;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">S1) exec sql select discnt into :cust_discnt from customers where cid = :cust_id;</span><br><span class="line"></span><br><span class="line">S2) exec sql begin declare section;</span><br><span class="line"><span class="type">float</span> cust_discnt; <span class="type">int</span> cd_ind;</span><br><span class="line">exec sql end declare section;</span><br><span class="line">exec sql select discnt into :cust_discnt :cd_ind</span><br><span class="line">from customers where cid = :cust_id;</span><br><span class="line"><span class="keyword">if</span> (cd_ind==<span class="number">0</span>) <span class="built_in">printf</span>(“The discount of %s is %d ! \n”, cust_id, cust_discnt);</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>[2] Example : Update the null discount to the specify cid’s</p>
<p>Host Vars —— cust_id, cust_discnt, cd_ind</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(“%s”, cust_id);</span><br><span class="line"><span class="built_in">scanf</span>(“%d”, cust_discnt);</span><br><span class="line">cd_ind = <span class="number">-1</span>;</span><br><span class="line">exec sql update customers</span><br><span class="line">set discnt = :cust_discnt :cd_ind where cid = :cust_id;</span><br></pre></td></tr></table></figure>



<h3 id="4、事务编程Transactions"><a href="#4、事务编程Transactions" class="headerlink" title="4、事务编程Transactions"></a>4、事务编程Transactions</h3><h4 id="事务Transaction"><a href="#事务Transaction" class="headerlink" title="事务Transaction"></a>事务Transaction</h4><p>[1] 并发性Concurrency<br>◼ 需要一起执行一组SQL程序在同一时间才能访问上的数据库。它被称为并发访问或并发。<br>◼ 必须使用<code>transaction</code>和<code>lock</code>来控制并发访问。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221130143328906.png" alt="image-20221130143328906"></p>
<p>[2] 数据库事务<br>◼ Database Transaction——用户定义的一组 DB 操作序列。</p>
<ol>
<li>这些操作要么全部操作成功，并永久性更新data到DB中 </li>
<li>要么操作失败，放弃本次所有操作对DB的更新， DB恢复到未操作前状态</li>
</ol>
<p>◼ Database Transaction 一个不可分割的数据库运行单位 (SQL是程序的书写单位)</p>
<h4 id="如何指定事务"><a href="#如何指定事务" class="headerlink" title="如何指定事务"></a>如何指定事务</h4><p>[1] 事务属性property：称为“ACID”属性<br>➢ Atomicity：事务是 数据库的逻辑运行单位 (原子性)<br>➢ Consistency：事务执行效果使数据库从一致性稳态A.变到一致性稳态B级(一致性)<br>➢ Isolation：事务内部的操作及所用数据，对其他并发事物是隔离的, 不能互相干扰。 (隔离性)<br>➢ Durability：事务一旦提交，它对数据库中数据的更新是永久性的，后续操作或故障对其执行结果没有任何影响。 (持久性)</p>
<p>[2] ACID 特性遭破坏的可能因素： </p>
<p>✓ 多个Transaction并行时，不同事物交叉访问相同DB Data，需控制并发. </p>
<p>✓ Transaction 如在运行时被强行中止，应有DB恢复机制.</p>
<p>[3] Declaration Database Transaction(显式&#x2F;隐式定义事务）<br>➢ exec sql begin transaction；–显式说明数据库事务开始<br>➢ exec sql commit [work];–Transaction正常结束标志，提交Database Transaction 中对 Data 的更新，写入DB。<br>➢ exec sql rollback [work];–Database Transaction异常结束标志，将Undo所有对 Data 已完成的更新操作，DB回滚到Transaction开始的状态。即事务运行过程中 发生了某种异常，没有正常结束，不更新DB。<br>➢ Database Transaction 可显式定义，否则 DBMS 按系统的缺省规定自动划分事务。 如：两个相邻 commit、rollback 句之间视为一个 Database Transaction</p>
<p>[4] Transaction与program间的关系： </p>
<p>(1) Program含多个Transaction，每个Transaction包含多条SQL statements。 </p>
<p>(2) statements是程序的构成单位，Transaction是DB program的运行单位</p>
<p>[5] Example 5.4.1: Inconsistent View of Data.</p>
<p>处理进程：Process P1 wants to move $400.00 from account A1 to A2, to even out the balance. Process P2 is running to perform a credit check on this depositor, requiring a total at least $900.00 before the depositor will be allowed to take out a credit card.<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221130144231132.png" alt="image-20221130144231132"></p>
<p>没有加锁的情况下出现问题<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221130144317284.png" alt="image-20221130144317284"></p>
<p>改成串行化 Serializability让两个线程顺序执行。</p>
<p>[6] Example 5.4.1 Transfer money between two account</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> “prompt.h”</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">( )</span> </span>&#123; </span><br><span class="line">    exec sql begin declare section;<span class="comment">//变量声明</span></span><br><span class="line">    	<span class="type">char</span> acc_from[<span class="number">8</span>], acc_to[<span class="number">8</span>]; </span><br><span class="line">    	<span class="type">double</span> tdollar;</span><br><span class="line">    exec sql end declare section;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> dollarstr[<span class="number">8</span>]; ms[<span class="number">30</span>]=“Enter from &amp; to accounts, dollars <span class="keyword">for</span> transfer”;</span><br><span class="line">    </span><br><span class="line">    exec sql connect to <span class="keyword">default</span>;<span class="comment">//连接数据库</span></span><br><span class="line">    exec sql set transaction isolation level serializable;<span class="comment">//设置事务级别串行化</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123; </span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">prompt</span>(ms, <span class="number">1</span>, acc_from, <span class="number">8</span>, acc_to, <span class="number">8</span>, dollarstr, <span class="number">6</span>)) &gt; <span class="number">0</span>)|| ( <span class="built_in">scanf</span>(dollastr, “%<span class="number">1f</span>”, &amp;tdollar) = <span class="number">1</span>) ) &#123;</span><br><span class="line">    		<span class="built_in">printf</span>(“Invalid input, Input example: <span class="number">345633</span>, <span class="number">445623</span>, <span class="number">100.45</span>\n”); </span><br><span class="line">        &#125;</span><br><span class="line">        exec sql whenever sqlerror <span class="keyword">goto</span> do_rollback;<span class="comment">//错误回滚</span></span><br><span class="line">        <span class="comment">/* --------Transaction start here --------- */</span></span><br><span class="line">        exec sql update accounts set balance=balance - :tdollar where acct=:acc_from;</span><br><span class="line">        exec sql update accounts set balance=balance + :tdollar where acct=:acc_to;</span><br><span class="line">        exec sql commit work;<span class="comment">//提交事务</span></span><br><span class="line">        <span class="comment">/* --------Transaction end here --------- */</span></span><br><span class="line">        <span class="built_in">printf</span>(“Transfer complete ! \n”);</span><br><span class="line">        loop;</span><br><span class="line">        do_rollback : exec sql rollback work ;</span><br><span class="line">        <span class="built_in">printf</span>(“Transfer failed ! \n”);</span><br><span class="line">	&#125; <span class="comment">/* end of while (1) */</span></span><br><span class="line">	exec sql disconnect current ; <span class="comment">//关闭连接</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Transaction-Isolation-and-Locking-事务隔离和锁"><a href="#Transaction-Isolation-and-Locking-事务隔离和锁" class="headerlink" title="Transaction Isolation and Locking 事务隔离和锁"></a>Transaction Isolation and Locking 事务隔离和锁</h4><p>[1] 如何保证事务的隔离<br>➢ 事务的行为就像它们以串行顺序发生一样  serializability<br>➢ 为了实现隔离，DBMS采用数据库锁定来控制一致性<br>[2] 锁的分类<br>✓ 读取访问锁（ R lock &#x2F; share lock）。<br>✓ 更新或写入锁定（W lock &#x2F; exclusive lock）。<br>[3] 锁的执行规则 （P295，图5.14）<br>➢ 事务访问数据时，需对它加排它锁，只到事务结束才释放锁<br>➢ 数据被锁住期间，其它事务的访问请求需等待</p>
<p>使用锁机制解决转账问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221130145628280.png" alt="image-20221130145628280"></p>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><p>[1] 死锁：两个或多个事务正在等待相同的资源。（两个线程拿了对方执行所需要的资源）</p>
<p>[2] Example Transaction deadlock.<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221130145854190.png" alt="image-20221130145854190"></p>
<p>[4] Example 1 死锁检测。通过Searched Update编写一个包含多行更改的事务，并在出现死锁时重试该事务。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEADABORT -60;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    exec sql whenever sqlerror <span class="keyword">continue</span>;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span> ;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )&#123; </span><br><span class="line">        exec sql update customers set discnt = <span class="number">1.1</span>*discnt where city = ‘New York’;</span><br><span class="line">        <span class="keyword">if</span> (sqlca.sqlcode == DEADABORT ) &#123; </span><br><span class="line">            count++; <span class="comment">/*count deadlock aborts*/</span></span><br><span class="line">            <span class="keyword">if</span> (count &lt; <span class="number">4</span>) &#123; </span><br><span class="line">                exec sql rollback work;</span><br><span class="line">                …… <span class="comment">/*operating system to wait for a second*/</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlca.sqlcode &lt;<span class="number">0</span> ) <span class="keyword">break</span>; <span class="comment">/*Error, but non-deadlock*/</span></span><br><span class="line">    &#125; <span class="comment">/* end while */</span></span><br><span class="line">    <span class="keyword">if</span> (sqlca.sqlcode &lt; <span class="number">0</span> ) &#123; <span class="comment">/*over-retried deadlock or other error */</span></span><br><span class="line">        <span class="built_in">print_dberror</span>( ); <span class="comment">/* print error message */</span></span><br><span class="line">        exec sql rollback work;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line">    &#125; <span class="comment">/* return error */</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* return success */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[5] 注意：如果发生死锁，需要考虑两件事。<br>➢ 使用ROLLBACK对DB数据进行所有更改，以回滚到程序逻辑首次找到它的位置。<br>➢ 内存中的程序变量不受DB控制。</p>
<h3 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 声明主变量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql begin declare section;</span><br><span class="line"><span class="comment">//主变量......</span></span><br><span class="line">exec sql end declare section;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 引入sqlca</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql include sqlca;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 声明错误跳转</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql whenever xxx <span class="keyword">goto</span> xxx;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接数据库</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql content :user_name indentified by password;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关闭数据库连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql disconnect current;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提交事务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql commit work;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 回滚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> exec sql rollback relase;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql select xxx,xxx into :xxx,:xxx from 表 where xxx=:xxx;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义游标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql declare 游标名 cursor <span class="keyword">for</span> 增删改查;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开游标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql open 游标名;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用游标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql fetch 游标名 into 对应查询结果的主变量</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关闭游标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exec sql close 游标名;</span><br></pre></td></tr></table></figure>

<p>习题：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230220105831487.png" alt="image-20230220105831487"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;prompt.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">exec sql include sqlca;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> notice[]=<span class="string">&quot;please input cid and pid:&quot;</span>;</span><br><span class="line">    exec sql begin declare section; <span class="comment">// 定义主变量</span></span><br><span class="line">        <span class="type">char</span> c_cid[<span class="number">4</span>],c_pid[<span class="number">4</span>],cc_cid[<span class="number">4</span>],cc_pid[<span class="number">4</span>],cc_aid[<span class="number">4</span>],user[<span class="number">4</span>],pwd[<span class="number">6</span>];</span><br><span class="line">        <span class="type">int</span> qty;</span><br><span class="line">    exec sql end declare section; </span><br><span class="line"></span><br><span class="line">    <span class="function">exec sql sel_cursor cursor <span class="title">for</span> <span class="params">( <span class="comment">// 定义游标</span></span></span></span><br><span class="line"><span class="params"><span class="function">        select cid,pid,aid,sum(qty) from order where cid=:c_cid <span class="keyword">and</span> pid=:c_pid group by cid</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    exec sql whenever sqlerror <span class="keyword">goto</span> report-err</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(user,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(pwd,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">    exec sql connect :user indentfied by :pwd; <span class="comment">// 连接数据库</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">prompt</span>(notice,<span class="number">1</span>,c_cid,<span class="number">4</span>,c_pid,<span class="number">4</span>) &gt; <span class="number">0</span>) &#123; <span class="comment">// 输入值</span></span><br><span class="line">        <span class="comment">// 查cid是否存在</span></span><br><span class="line">        exec select cid into:cc_id from customer where cid=:c_cid;</span><br><span class="line">        <span class="keyword">if</span>(sqlca.sqlcode==<span class="keyword">not</span> found) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s is not exit&quot;</span>, c_cid);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查pid是否存在</span></span><br><span class="line">        exec select pid into:cc_pid from product where pid=:c_pid;</span><br><span class="line">        <span class="keyword">if</span>(sqlca.sqlcode==<span class="keyword">not</span> found) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s is not exit&quot;</span>, c_pid);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        exec sql open sel_cursor;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            exec fetch sel_cursor into :cc_cid,:cc_pid,:cc_aid,:qty;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;agent %s sale %s to % s total %d&quot;</span>, cc_aid, cc_pid, cc_aid, qty);</span><br><span class="line">        &#125;</span><br><span class="line">        exec sql close sel_cursor;</span><br><span class="line">        exec sql commit work;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    report-err:</span><br><span class="line">    <span class="built_in">print_dberror</span>();</span><br><span class="line">    exec sql rollback release;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="五、数据库设计（Database-Design）"><a href="#五、数据库设计（Database-Design）" class="headerlink" title="五、数据库设计（Database Design）"></a>五、数据库设计（Database Design）</h2><h3 id="补充：数据库设计的基本步骤"><a href="#补充：数据库设计的基本步骤" class="headerlink" title="补充：数据库设计的基本步骤"></a>补充：数据库设计的基本步骤</h3><p>[1] 改进的“奥尔良法” , 将DB设计分成六个阶段： </p>
<ul>
<li>需求分析 </li>
<li>物理结构设计 </li>
<li>概念结构设计 </li>
<li>数据库实施 </li>
<li>逻辑结构设计 </li>
<li>数据库运行维护</li>
</ul>
<p>[2] DB设计人员（五种角色） </p>
<p>乙方：</p>
<p>√ System analyst √ Database Designer √ Programmer</p>
<p>甲方：</p>
<p>√ User √ Database Administrators</p>
<p>[3]若DBAS较复杂，应考虑使用数据库辅助设计工具(CASE)，提高DB设计速度、质量</p>
<p><code>数据库应用系统设计流程图</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201163230672.png" alt="image-20221201163230672"></p>
<p>设计步骤：</p>
<p>[1] DB设计阶段</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201163329613.png" alt="image-20221201163329613"></p>
<p>[2] DB设计内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201163417966.png" alt="image-20221201163417966"></p>
<p>[3] DB设计时各种模式的产生</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201163546815.png" alt="image-20221201163546815"></p>
<h3 id="1、E-R图"><a href="#1、E-R图" class="headerlink" title="1、E-R图"></a>1、E-R图</h3><h4 id="实体、属性、E-R图（Entities-Attributes-E-R-Diagrams）"><a href="#实体、属性、E-R图（Entities-Attributes-E-R-Diagrams）" class="headerlink" title="实体、属性、E-R图（Entities,Attributes,E-R Diagrams）"></a>实体、属性、E-R图（Entities,Attributes,E-R Diagrams）</h4><p>[1] 实体Entity<br>实体是可区分的集合(可区别的) 具有共同特性的真实世界对象。</p>
<p>实体间的关系：</p>
<ul>
<li>一对一</li>
<li>一对多</li>
<li>多对多</li>
</ul>
<p>[2] 实体实例Entity Instance<br>一个实体（如“客户”）通常映射到一个实际的表，表的每一行都对应于一个可区分的真实世界对象，该行称为“实体实例”(实体实例)”<br>例如：学生、讲师、课程。<br>[3] 实体集Entity Set </p>
<p>[4] 属性Attribute<br>属性——描述实体或关系的属性。<br>在学生实体中，（sid，student_name）</p>
<p>[5] 特殊概念</p>
<p>➢ Candidate key—每个实体都有一个标识符，它是一组唯一的属性标识实体实例。eg:客户的“cid”。<br>➢ A descriptor—是一个非键属性。eg:订单的“qty”。<br>➢ A composite attribute eg:“cname”可以有三个部分，如“fname，lname，midname”<br>➢ A multi-valued attribute：可以接受实体实例的多个值。eg:员工的“爱好”。<br>➢ <code>主键</code>&#x2F;主标识符Primary key &#x2F; primary identifier<br>主键是DBA为该表中的唯一行选择的候选键。<br>eg:“cid”代表客户，“pid”代表产品，“aid”代表代理商</p>
<p>[6] Entity-Relation Approach 概念模型表示法<br>1976年P.P.S.Chen 提出, E-R 图提供了表示实体型、属性和联系的方法。<br>➢ Entity ： 矩形框，内写实体名<br>➢ Attribute： 椭圆形，内写属性名<br>➢ Relationship： 菱形框，内写联系名<br>➢ No Direction Line：连接实体与属性，线上注明联系的比例<br>或 在实体与实体之间建立连接，线上注明实体间联系的比例关系<br>Notice：E-R 图是各种数据模型的共同基础，与DBMS支持的数据模型无关</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201183743655.png" alt="image-20221201183743655"></p>
<h4 id="将实体和属性转换为关系"><a href="#将实体和属性转换为关系" class="headerlink" title="将实体和属性转换为关系"></a>将实体和属性转换为关系</h4><p>[1] 转换规则1。<br>•实体映射到单个表。<br>•实体的单值属性映射到列。复合属性映射到多个列。<br>•实体实例成为表的行。<br>[参考] 一个实体型转换为一个关系模式，实体属性构成关系属性，实体码成为关系码</p>
<p>[3] 转换规则2。<br>➢ 原始表变为“muster table”(主表).<br>➢ 表的多值属性必须映射到其自己的表，称为“dependent table”(从表).</p>
<h4 id="实体之间的关系"><a href="#实体之间的关系" class="headerlink" title="实体之间的关系"></a>实体之间的关系</h4><p>[1] 定义Relationship<br>➢ 给定具有E1、E2、…、Em的m个实体，关系R定义了这些实体的实例之间的对应规则。<br>➢ 示例：<br>讲师讲授课程_部分<br>员工在项目上工作（属性，百分比（时间））<br>员工管理员工（环形&#x2F;递归关系）</p>
<p>➢ E_R设计转换：关系有时转换为表，有时不转换。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201184150760.png" alt="image-20221201184150760"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201184257272.png" alt="image-20221201184257272"></p>
<h3 id="2、E-R建模的进一步细节"><a href="#2、E-R建模的进一步细节" class="headerlink" title="2、E-R建模的进一步细节"></a>2、E-R建模的进一步细节</h3><h4 id="实体的基数-关系的基数"><a href="#实体的基数-关系的基数" class="headerlink" title="实体的基数(关系的基数)"></a>实体的基数(关系的基数)</h4><p>[1] 最小和最大基数<br>➢ 在E-R图中，点表示实体（E或F）。R代表关系，并且使用线连接点之间。<br>   调用点是实体实例，调用线是关系实例。<br>➢ 最大基数(最大基) E和R之间(最多实例关联线数)<br>（1）max-card(E, R) &#x3D; 1. 如果E中的所有点最多有一行出来。<br>（2）max-card(E, R）&#x3D; N。如果可能有多条线路输出。<br>➢ 最小基数(最小基) E和R之间(最少实例关联线数)<br>（1） min-card(E, R) &#x3D; 1。如果E中的所有点至少有一条线出来。<br>（2） max-card(E, R) &#x3D; 0。如果一些点可能没有一条线出来。</p>
<p>➢ 即：将R看成 域E和F之间的映射（relationship），则<br>(1) max-card(E,R) 为 “实体E经R关系映射到实体F”的最大关联数。<br>(2) min-card(E,R) 为 “实体E经R关系映射到实体F”的最小关联数。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201185421510.png" alt="image-20221201185421510"></p>
<p>[2] 定义<br>➢ 当实体E参与关系R时， min-card（E，R）&#x3D;x，max-card（E、R）&#x3D;y<br>➢ 在E_R模型中，E和R之间的连接线可以标记为“（x，y）”</p>
<p>eg:<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201185619037.png" alt="image-20221201185619037"></p>
<h4 id="1-1、N-N、1-N-Relationships"><a href="#1-1、N-N、1-N-Relationships" class="headerlink" title="1-1、N-N、1-N Relationships"></a>1-1、N-N、1-N Relationships</h4><p>[1] Def: single-valued&#x2F;multi-valued participation </p>
<p>➢ If max-card(E, R)&#x3D;1, E have single-valued participation in R. </p>
<p>➢ If max-card(E, R)&#x3D;N, E have multi-valued participation in R</p>
<p>[2] Classify of relationship 关系的分类</p>
<p> ➢ R is <strong>N-N</strong> relationship, If entities E and F are multi-valued in the relationship R [ max-card(E, R) &#x3D; N ; max-card(F, R) &#x3D; N ]. </p>
<p>➢ R is <strong>1-1</strong> relationship, If entities E and F are single-valued in the relationship R [ max-card(E, R) &#x3D; 1 ; max-card(F, R) &#x3D; 1 ]. </p>
<p>➢ R is <strong>1-N</strong> relationship, If E is single-valued, and F is multi-valued</p>
<p>✓E [max-card(E, R)&#x3D;1] is “<code>Many side</code>” </p>
<p>✓F [max-card(F, R)&#x3D;N] is “<code>One side</code>”</p>
<h4 id="将二元关系转换为关系-六条转换规则"><a href="#将二元关系转换为关系-六条转换规则" class="headerlink" title="将二元关系转换为关系(六条转换规则)"></a>将二元关系转换为关系(六条转换规则)</h4><p>[总结] “E-R模型”向“RDB” 转换的规则 </p>
<p>(1) 一个实体E转换为一个关系 Table，实体属性成为关系属性，实体码就是关系的码 </p>
<p>(2) 一个1-1联系可转换为一个独立Table；也可以与任一实体合并。 </p>
<p>(3) 一个1-n联系可转换为一个独立Table；也可与n端对应的实体合并。 </p>
<p>(4) 一个m-n联系可转换为一个独立Table；与该联系相连的各实体码以及联系本身的 属性均转换为Table的属性；且该Table的码为各实体码的组合。 </p>
<p>(5) 三个或三个以上实体间的多元联系R，可以转换为一个关系Table ；与多元联系R 相连的各实体码，均需加入为Table的属性；Table的码为各实体码的组合。 </p>
<p>(6) 具有相同码的关系Table可合并。</p>
<h3 id="3、范式"><a href="#3、范式" class="headerlink" title="3、范式"></a>3、范式</h3><p>1)定理：<br>– 每个函数依赖集F &lt;–&gt;一个最小函数依赖集Fm。<br>– 每个F的最小函数依赖集Fm不唯一，它与处理F中每个FD的顺序有关。</p>
<p>(2)推理：<br>– 若要求关系模式的分解保持函数依赖，那么分解可以达到3NF（非主属性与“码”不存在传递函数依赖），但不一定能达到BCNF（每一个FD中的决定因素均包含于码）。<br>– 若要求关系模式的分解具有无损连接性，那么分解总可以达到4NF。</p>
<p>(3)范式：<br>– 共有六种，范式之间的关系：<br>– 一个低级范式的关系模式，通过“模式分解”可以转换为若干个高级范<br>式的关系模式集合，这种过程称为规范化。<br>5NF  4NF  BCNF  3NF  2NF 1NF</p>
<p>(4)2NF：若R∈1NF，且每一个非主属性完全函数依赖于码，则R∈2NF。 该模式会产生的问题：插入异常、删除异常、修改复杂 </p>
<p>(5)3NF： 若R∈3NF，则每一个非主属性，既不部分依赖于码，也不传递依赖于码。它会产生与2NF类似的问题，分解模式消除传递函数依赖。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221201201916141.png" alt="image-20221201201916141"></p>
<h2 id="六、数据库的完整性、安全性、视图（Integrity-Views-Security）"><a href="#六、数据库的完整性、安全性、视图（Integrity-Views-Security）" class="headerlink" title="六、数据库的完整性、安全性、视图（Integrity,Views, Security）"></a>六、数据库的完整性、安全性、视图（Integrity,Views, Security）</h2><h3 id="1、完整性约束"><a href="#1、完整性约束" class="headerlink" title="1、完整性约束"></a>1、完整性约束</h3><h4 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h4><p>[1] Definition </p>
<p>➢表创建时定义“完整性约束” </p>
<p>➢按作用对象分： 表级完整性、列级完整性 </p>
<p>➢按类型分： 实体完整性、参照完整性、用户自定义完整性</p>
<p>[2] Function 数据库做 Updates 操作时需检查、遵守这些完整性约束。</p>
<p>[3] 实施机制 </p>
<p>➢<code>实体完整性</code>—-实施措施：<strong>主键</strong>、唯一索引、非空+唯一 </p>
<p>➢<code>参照完整性</code>—-实施措施：<strong>外键</strong>、触发器、存储过程 </p>
<p>➢用户自定义完整性–实施措施：非空、缺省值、取值约束等</p>
<h4 id="Create-Table语句中的完整性约束"><a href="#Create-Table语句中的完整性约束" class="headerlink" title="Create Table语句中的完整性约束"></a>Create Table语句中的完整性约束</h4><p>[1] Definition  Create Table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [schema.]tablename</span><br><span class="line">    ( colname datatype [<span class="keyword">DEFAULT</span> &#123;default_constant <span class="operator">|</span> <span class="keyword">NULL</span>&#125;]</span><br><span class="line">    [col_constr &#123;col_constr. . .&#125;] <span class="operator">|</span> table_constr</span><br><span class="line">    &#123; , &#123;colname datatype [<span class="keyword">DEFAULT</span> &#123;default_constant <span class="operator">|</span> <span class="keyword">NULL</span>&#125;]</span><br><span class="line">    [col_constr &#123;col_constr. . .&#125;] <span class="operator">|</span> table_constr&#125; . . . &#125; );</span><br></pre></td></tr></table></figure>

<p>➢ 每列必须定义为： 列名 + 数据类型</p>
<p>➢ 每列还允许有：可选的 DEFAULT 子句 、 由 col_constr 表示的列约束列表</p>
<p>[2] Example: Create Table statement for “products”.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> products (</span><br><span class="line">    pid <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    pname <span class="type">varchar</span>(<span class="number">13</span>), city <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    quantity <span class="type">integer</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    price <span class="type">double precision</span> <span class="keyword">default</span> <span class="number">0.0</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (pid) # 主键</span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<p>[3] Example: Create Table statement for “customers”. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> customers (</span><br><span class="line">    cid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">unique</span>, # 非空 <span class="operator">+</span> 唯一 <span class="operator">=</span> <span class="keyword">primary</span> key</span><br><span class="line">    cname <span class="type">varchar</span>(<span class="number">13</span>), city <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    discnt <span class="type">real</span> <span class="keyword">constraint</span> discnt_max <span class="keyword">check</span> (discnt<span class="operator">&lt;=</span><span class="number">15.0</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>[4] Column Constraints 列级约束</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="operator">|</span> [<span class="keyword">CONSTRAINT</span> constraint_name]</span><br><span class="line"><span class="keyword">UNIQUE</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span> KEY <span class="operator">|</span> <span class="keyword">CHECK</span> (search_cond)</span><br><span class="line"><span class="operator">|</span> <span class="keyword">REFERENCES</span> tablename [(colname) ] [<span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE]&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>CONSTRAINT 每个约束的名称</li>
<li>UNIQUE 约束表中所有非空列值都是唯一的</li>
<li>PRIMARY KEY指定列作为主键</li>
</ul>
<p>NOT NULL+UNIQUE &#x3D; PRIMARY KEY</p>
<p>PRIMARY KEY 和 NOT NULL可以一起使用，但 UNIQUE 和 PRIMARY KEY 不能同时用于列。</p>
<p>➢ CHECK允许行在“search_cond”中包含约束值。<br>➢ 如果使用 REFERENCES tablename [columnname] 定义的列</p>
<ul>
<li>列中的每个值必须为 null 或 值。</li>
<li>引用表的一列(被参照表&#x2F;主表) 是主键或可选列中指定的列。</li>
</ul>
<p>➢ 可选的ON DELETE CASCADE(级联删除)<br>如果正在删除引用表中的行，那么(参照表&#x2F;从表)的行也已删除</p>
<p>[5] Table Constraints. 表级约束</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">CONSTRAINT</span> constraint_name] &#123;<span class="keyword">UNIQUE</span> (colname&#123;, colname…&#125;)</span><br><span class="line"><span class="operator">|</span> <span class="keyword">PRIMARY</span> KEY (colname &#123;, colname……&#125;)</span><br><span class="line"><span class="operator">|</span> <span class="keyword">CHECK</span> (search_condition)</span><br><span class="line"><span class="operator">|</span> <span class="keyword">FOREIGN</span> KEY (colname &#123;, colname……&#125;)</span><br><span class="line"><span class="keyword">REFERENCES</span> tablename [(colname &#123;, colname……&#125;)]</span><br><span class="line">[<span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE]&#125;</span><br></pre></td></tr></table></figure>

<p>➢ UNIQUE是一种将多列指定为表的候选关键字的方法，如果这两个关键字都声明为NULL。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221202102248275.png" alt="image-20221202102248275"></p>
<p>➢ FOREIGN KEY…REFERENCES…[ON DELETE…]</p>
<p>✓ FOREIGN KEY columnname 将一组列作为 FK 列出。它们被约束为 等于主表的PK。<br>✓ 如果主表中的行被删除，则从表中引用主表的行也会被删除。</p>
<p>[6] Example Create tables of CAP DataBase.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> customer ( </span><br><span class="line">    cid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span>, # 主表</span><br><span class="line">    cname <span class="type">varchar</span>(<span class="number">13</span>), city <span class="type">char</span>(<span class="number">20</span>),</span><br><span class="line">    discnt <span class="type">real</span> <span class="keyword">constraint</span> discnt_max <span class="keyword">check</span> (discnt <span class="operator">&lt;=</span> <span class="number">15.0</span>),</span><br><span class="line">    <span class="keyword">primary</span> key ( cid ) </span><br><span class="line">) ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orders ( # 从表</span><br><span class="line">    ordno <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    <span class="keyword">month</span> <span class="type">char</span>(<span class="number">3</span>), </span><br><span class="line">    cid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    aid <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    pid <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    qty <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">check</span>(qty <span class="operator">&gt;=</span> <span class="number">0</span>) ,</span><br><span class="line">    dollars <span class="type">float</span> <span class="keyword">default</span> <span class="number">0.0</span> <span class="keyword">check</span>(dollars <span class="operator">&gt;=</span> <span class="number">0.0</span>) ,</span><br><span class="line">    <span class="keyword">primary</span> key (ordno) ,</span><br><span class="line">    <span class="keyword">foreign</span> key (cid) <span class="keyword">references</span> customers, # 外键</span><br><span class="line">    <span class="keyword">foreign</span> key (aid) <span class="keyword">references</span> agents,</span><br><span class="line">    <span class="keyword">foreign</span> key (pid) <span class="keyword">references</span> products </span><br><span class="line">) ;</span><br></pre></td></tr></table></figure>

<h4 id="Primary-Keys-Foreign-Keys-Referent"><a href="#Primary-Keys-Foreign-Keys-Referent" class="headerlink" title="Primary-Keys, Foreign-Keys, Referent"></a>Primary-Keys, Foreign-Keys, Referent</h4><p>主键、外键和引用</p>
<p>[1] 定义：外键、引用完整性。<br>➢ T1 引用引用表(参照表&#x2F;从表), 并且表 T1 中的一组列F被定义为外键。<br>➢ T2 参考参考表(被参照表&#x2F;主表), 并且表 T2 中的一组列P被定义为主键或候选键。<br>➢ 如果 T1 的任何行中的F列必须 ①具有空值（或列为空） ② 其值等于 T2 的某行上的 PK 的值相同。<br>➢ 注意：表的外键可能会出现在同一表中的候选键或主键中。</p>
<p>[2] Example Use Referential Integrity（参照完整性 to define an Enumerated (枚举) Domain of “city” in table “cities”.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> cities ( # 主表</span><br><span class="line">    city <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    <span class="keyword">primary</span> key (city) </span><br><span class="line">);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> customers ( # 从表</span><br><span class="line">    cid <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    cname <span class="type">varchar</span>(<span class="number">13</span>),</span><br><span class="line">    city <span class="type">varchar</span>(<span class="number">20</span>), </span><br><span class="line">    discnt <span class="type">real</span>, </span><br><span class="line">    <span class="keyword">primary</span> key (cid),</span><br><span class="line">    <span class="keyword">foreign</span> key city <span class="keyword">references</span> cities</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>[3] 完整性约束的测试矩阵</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221202110445083.png" alt="image-20221202110445083"></p>
<h4 id="Alter-Table-Statement-更改表声明"><a href="#Alter-Table-Statement-更改表声明" class="headerlink" title="Alter Table Statement 更改表声明"></a>Alter Table Statement 更改表声明</h4><p>[1] 功能：更改现有表的结构。<br>前提：（1）表已经存在（2）的所有者具有Alter权限</p>
<p>[2] Alter Table statement </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename</span><br><span class="line">    [<span class="keyword">ADD</span> (&#123;colname datatype [<span class="keyword">DEFAULT</span> &#123;default_constant<span class="operator">|</span> <span class="keyword">NULL</span>&#125;]</span><br><span class="line">    [col_constr &#123;col_constr...&#125;] <span class="operator">|</span> table_constr&#125; &#123;, ...&#125;)]</span><br><span class="line">    [<span class="keyword">DROP</span> &#123;<span class="keyword">COLUMN</span> columnname <span class="operator">|</span> (columnname &#123;, columnname…&#125;)&#125;]</span><br><span class="line">    [MODIFY (columnname data<span class="operator">-</span>type</span><br><span class="line">    [<span class="keyword">DEFAULT</span> &#123;default_const<span class="operator">|</span><span class="keyword">NULL</span>&#125;] [[<span class="keyword">NOT</span>] <span class="keyword">NULL</span>] &#123;, ...&#125;)]</span><br><span class="line">    [<span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> constr_name]</span><br><span class="line">    [<span class="keyword">DROP</span> <span class="keyword">PRIMARY</span> KEY]</span><br><span class="line">    [ENABLE <span class="keyword">and</span> DISABLE clauses <span class="keyword">for</span> constraints];</span><br></pre></td></tr></table></figure>

<p>[3] Example：修改orders表中的month为日期类型、将ordno字段改为实型. </p>
<p>思路：(1) 创建日期型字段order_date, 再取出原month值拼上“年、日”回填； (2) 修改ordno字段的类型</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> orders </span><br><span class="line">	<span class="keyword">DROP</span> <span class="keyword">PRIMARY</span> KEY (ordno),</span><br><span class="line">	<span class="keyword">ADD</span> order_date <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">default</span> “<span class="number">2018</span><span class="operator">/</span><span class="number">01</span><span class="operator">/</span><span class="number">01</span>”,</span><br><span class="line">	MODIFY ordno <span class="type">real</span>;</span><br><span class="line">	<span class="keyword">UPDATE</span> orders <span class="keyword">set</span> order_date<span class="operator">=</span> ……(<span class="keyword">month</span>) ;</span><br><span class="line">	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> orders <span class="keyword">DROP</span> <span class="keyword">month</span> ;</span><br></pre></td></tr></table></figure>

<h4 id="Non-Procedural-x2F-Procedural-Integrity-Constraints-非程序-x2F-程序完整性约束"><a href="#Non-Procedural-x2F-Procedural-Integrity-Constraints-非程序-x2F-程序完整性约束" class="headerlink" title="Non-Procedural &#x2F; Procedural Integrity Constraints 非程序&#x2F;程序完整性约束"></a>Non-Procedural &#x2F; Procedural Integrity Constraints 非程序&#x2F;程序完整性约束</h4><p>[1] The non-procedural constraints: Using “foreign key” </p>
<p>Eg: Student ( sno, sname, sdept) SC (cno, sno, score) </p>
<p>如果删除Student行，则删除SC行关于SC.sno&#x3D;Student.sno的行必须级联删除。</p>
<p>[2] 程序约束：Triggers（触发器）或 Procedures（程序）<br>•灵活性<br>•用户在DBMS中的定义</p>
<h4 id="触发器Triggers"><a href="#触发器Triggers" class="headerlink" title="触发器Triggers"></a>触发器Triggers</h4><ul>
<li>呈现DBMS的反应行为</li>
<li>规则-类似于过程，但执行是自动的</li>
<li>大多数商业DBMS通过“触发器”提供此功能（触发器关联一个表，由激活表事件)</li>
<li>DBMS通过“触发器”提供此功能基于事件条件操作范例：Event-Condition-Action</li>
<li>事件event：通过SQL  insert, delete or update</li>
<li>条件 Condition:SQL 谓词</li>
<li>操作 Action:SQL 语句序列（或扩展SQL，如Oracle中的PL&#x2F;SQL）</li>
<li>关系模型中的触发器可以在两个级别上工作<ul>
<li>行级别：针对操作中的每个元组发生</li>
<li>语句级别：每个SQL只发生一次</li>
</ul>
</li>
<li>触发器可以有两种类型的功能<ul>
<li>立即：在事件之前或之后立即完成</li>
<li>延迟：在提交命令后完成</li>
</ul>
</li>
</ul>
<p>[3] Create Trigger语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name &#123; BEFORE <span class="operator">|</span> AFTER &#125;</span><br><span class="line">    &#123; <span class="keyword">INSERT</span> <span class="operator">|</span> <span class="keyword">DELETE</span> <span class="operator">|</span> <span class="keyword">UPDATE</span> [<span class="keyword">OF</span> columnname &#123;,columnname…&#125;]&#125;</span><br><span class="line">    <span class="keyword">ON</span> tablename [<span class="keyword">REFERENCING</span> corr_name_def &#123;,corr_name<span class="operator">-</span>def…&#125;]</span><br><span class="line">    [<span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="operator">|</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> STATEMENT]</span><br><span class="line">    [<span class="keyword">WHEN</span> (<span class="keyword">search</span><span class="operator">-</span><span class="keyword">condition</span>)]</span><br><span class="line">    statement <span class="comment">-- (single action)</span></span><br><span class="line">    <span class="operator">|</span> <span class="keyword">BEGIN</span> statement; &#123;statement;…&#125; <span class="keyword">END</span> <span class="comment">-- (multiple actions)</span></span><br></pre></td></tr></table></figure>

<p>[6] Example  Use an ORACLE trigger to check the DISCNT value of a new customers does not exceed 15.0 (使用ORACLE触发器检查新客户的DISCNT值是否超过15.0)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> discnt_max AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> customers</span><br><span class="line">    <span class="keyword">REFERENCING</span> <span class="keyword">new</span> <span class="keyword">as</span> x <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line">    <span class="keyword">WHEN</span> (x.discnt <span class="operator">&gt;</span> <span class="number">15.0</span>)</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">    raise_error(<span class="number">-20003</span>, “ invalid discount <span class="keyword">on</span> <span class="keyword">insert</span> ” );</span><br><span class="line">    <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>[4] Drop Trigger 删除触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> trigger_name;</span><br></pre></td></tr></table></figure>

<p>[5] Trigger executed 触发器的执行时间：在以下操作的之前或者之后</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="keyword">INSERT</span> <span class="operator">|</span> <span class="keyword">DELETE</span> <span class="operator">|</span> <span class="keyword">UPDATE</span> [<span class="keyword">of</span> colname &#123;, colname . . .&#125;]&#125; </span><br></pre></td></tr></table></figure>

<p>[7] Example： use trigger to implement a referential integrity policy “on delete, set null in the customers-orders foreign key” 使用触发器实现引用完整性策略，删除时，在客户订单外键中设置null”</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> foreign_cid AFTER <span class="keyword">DELETE</span> <span class="keyword">on</span> customers</span><br><span class="line">    <span class="keyword">REFERENCING</span> <span class="keyword">old</span> <span class="keyword">as</span> ocust <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">update</span> orders <span class="keyword">set</span> cid <span class="operator">=</span> <span class="keyword">null</span> <span class="keyword">where</span> cid <span class="operator">=</span> ocust.cid;</span><br><span class="line">    <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>[8] Example:（保证事务一致性）这里将实现一个“line_items”表，通过触发器  对每个订单进行计数。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221202113713851.png" alt="image-20221202113713851"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">trigger</span> incordern_items after <span class="keyword">insert</span> <span class="keyword">on</span> Orders</span><br><span class="line">    <span class="keyword">referencing</span> <span class="keyword">new</span> <span class="keyword">as</span> nil <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">update</span> Line_items <span class="keyword">set</span> lineno <span class="operator">=</span> lineno<span class="operator">+</span><span class="number">1</span></span><br><span class="line">    <span class="keyword">where</span> ordno <span class="operator">=</span> nli.ordno;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">trigger</span> decordern_items after <span class="keyword">delete</span> <span class="keyword">on</span> Orders</span><br><span class="line">    <span class="keyword">referencing</span> <span class="keyword">old</span> <span class="keyword">as</span> oldli <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">update</span> Line_items <span class="keyword">set</span> lineno <span class="operator">=</span> lineno<span class="number">-1</span></span><br><span class="line">    <span class="keyword">where</span> ordno <span class="operator">=</span> :ldli.ordno;</span><br><span class="line">    <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>[8] Example: Consider two tables </p>
<p>表 Warehouse (Part, QtyAvbl, QtyLimit, QtyReOrd)产品库存(零件号，库存量，库存下限，采购单号) </p>
<p>表 PendingOrders (Part, QtyReOrd, OrderDate) 采购订单(零件号，采购单号，订单日期)</p>
<p>◼ event: update of QtyAvbl in Warehouse </p>
<p>◼ condition: new available quantity is less than the (new) quantity new.QtyAvbl &lt; old.QtyLimit (低于库存下限) </p>
<p>◼ action: if there is no pending order for the part, issue a new order </p>
<p>insert into PendingOrders values (new.part, new.QtyReOrd, sysdate) (为补库存，自动生成采购单)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">trigger</span> Reorder</span><br><span class="line">    after <span class="keyword">update</span> <span class="keyword">of</span> QtyAvbl <span class="keyword">on</span> Warehouse <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line">    <span class="keyword">when</span> (new.QtyAvbl <span class="operator">&lt;</span> old.QtyLimit)</span><br><span class="line">    <span class="keyword">declare</span> X <span class="type">integer</span>;</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">into</span> X <span class="keyword">from</span> PendingOrders <span class="keyword">where</span> Part <span class="operator">=</span> new.Part;</span><br><span class="line">    if X <span class="operator">=</span> <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> PendingOrders <span class="keyword">values</span> (new.Part, new.QtyReOrd, sysdate);</span><br><span class="line">    <span class="keyword">end</span> if;</span><br></pre></td></tr></table></figure>



<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><ol>
<li><p>Three types of Integrity Constrains 三种完整性</p>
<p>(1) Integrity of Entity (实体完整性) </p>
<p>(2) Referential Integrity between Entities (实体间的参照完整性) </p>
<p>(3) Integrity definition by User (用户自定义完整性) </p>
</li>
<li><p>Two ways to realize the Referential Integrity 两种方法实现参照物完整性</p>
<p>(1) Using a Foreign Key 外键</p>
<p>(2) Using a Trigger 触发器</p>
</li>
<li><p>SQL Procedure “Storage Procedure”（存储器过程） Can realize a PROCEDURE（程序） or FUNCTION（功能）</p>
</li>
</ol>
<h3 id="2、视图-View"><a href="#2、视图-View" class="headerlink" title="2、视图 View"></a>2、视图 View</h3><h4 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h4><p>[1] 基本表</p>
<ol>
<li>由Create Table创建	</li>
<li>存储在磁盘上</li>
</ol>
<p>[2] 视图（虚表）</p>
<ol>
<li>视图是子查询的结果 ，它是一个虚拟表，其中没有数据存储。</li>
<li>视图有自己的名称，可以将其视为基表。</li>
</ol>
<p>[3] Create View 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> <span class="operator">&lt;</span>视图名<span class="operator">&gt;</span> [(<span class="operator">&lt;</span>列名<span class="operator">&gt;</span> &#123;,<span class="operator">&lt;</span>列名<span class="operator">&gt;</span>…&#125;)]</span><br><span class="line">	<span class="keyword">AS</span> <span class="operator">&lt;</span>子查询<span class="operator">&gt;</span> [<span class="keyword">WITH</span> <span class="keyword">CHECK</span> OPTION];</span><br></pre></td></tr></table></figure>

<p>WITH CHECK OPTION将不允许按视图进行update or insert</p>
<p>子查询 is defined as Select, allow UNION, not allow ORDER BY</p>
<p>[4] Example 1. Create a view “agentorders” that extends the rows of “orders” table to include all information about the agent taking the order.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/../images/%E6%95%B0%E6%8D%AE%E5%BA%93/image-20221202114943580.png" alt="image-20221202114943580"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">view</span> agentorders (ordno, <span class="keyword">month</span>, cid, aid, pid, qty, charge,aname, acity, <span class="keyword">percent</span>) </span><br><span class="line">    <span class="keyword">as</span> <span class="keyword">select</span> o.ordno, o.month, o.cid, o.aid, o.pid, o.qty, o.dollars,a.aname, a.city, a.percent 	 <span class="keyword">from</span> orders o, agents a</span><br><span class="line">    <span class="keyword">where</span> o.aid <span class="operator">=</span> a.aid;</span><br></pre></td></tr></table></figure>

<p>[5] Example 2. Create a view “acorders” that gives all order information and names of the agent and customers involved in order</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> acorders (ordno, <span class="keyword">month</span>, cid, aid, pid, qty, dollars, aname, cname)</span><br><span class="line">    <span class="keyword">as</span> <span class="keyword">select</span> ordno, <span class="keyword">month</span>, ao.cid <span class="keyword">as</span> cid, aid, pid, qty, charge, aname, cname</span><br><span class="line">    <span class="keyword">from</span> agentorders ao, customers c </span><br><span class="line">    <span class="keyword">where</span> ao.cid <span class="operator">=</span> c.cid;</span><br></pre></td></tr></table></figure>

<p>[6] Example 3. Create a view “cacties” that lists all pairs of cities from “customers” and “agents” tables, where the agent places an order for the customer.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> cacties (ccity, acity) </span><br><span class="line">    <span class="keyword">as</span> <span class="keyword">select</span> c.city, a.city <span class="keyword">from</span> customer c, orders o, agents a</span><br><span class="line">    <span class="keyword">where</span> c.cid <span class="operator">=</span> o.cid <span class="keyword">and</span> o.aid <span class="operator">=</span> a.aid;</span><br></pre></td></tr></table></figure>

<p>[7] Dropping Tables and Views 删除表和视图</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> &#123;<span class="keyword">TABLE</span> 表名 <span class="operator">|</span> <span class="keyword">VIEW</span> 视图名&#125; &#123;CASCADE <span class="operator">|</span> RESTRICT&#125;;</span><br></pre></td></tr></table></figure>

<p>如果该视图还道出了其他试图，则使用CASCADE级联删除把该视图和由他导出的视图一起删除。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> t1</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> v1 </span><br><span class="line"># 如果有从v1导出的视图 则级联删除</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> v1 CASCADE</span><br></pre></td></tr></table></figure>

<p>Only “Table or View Owner” can authorized(有权或授权) to drop it </p>
<h4 id="可更新视图和只读视图"><a href="#可更新视图和只读视图" class="headerlink" title="可更新视图和只读视图"></a>可更新视图和只读视图</h4><ol>
<li><p>基本表中的数据都是可更新的。</p>
</li>
<li><p>某些视图中的数据无法更新。因为不清楚如何转换为基表的唯一更新。</p>
</li>
<li><p>要使视图可更新，视图定义中必须有以下限制</p>
<ol>
<li>FROM子句必须有一个表（如果是视图，则可更新）。</li>
<li>GROUP BY或HAVING子句都不存在。</li>
<li>未指定DISTINCT关键字。</li>
<li>WHERE子句没有引用FROM子句中的表的子查询。</li>
<li>结果列很简单：没有表达式，没有列名。</li>
</ol>
</li>
</ol>
<p><strong>对视图的更新最终都要转到对基本表的更新</strong></p>
<h4 id="视图的功能"><a href="#视图的功能" class="headerlink" title="视图的功能"></a>视图的功能</h4><ol>
<li>视图为普通用户提供了一种简化查询的方法。</li>
<li>可以通过其视图限制用户访问基表的特定列。这将为基表添加安全性。</li>
<li>视图保持陈旧过时(作废的) 引用它们的表和程序将继续工作。</li>
</ol>
<h3 id="3、安全性"><a href="#3、安全性" class="headerlink" title="3、安全性"></a>3、安全性</h3><h4 id="概念-3"><a href="#概念-3" class="headerlink" title="概念"></a>概念</h4><ol>
<li><p>数据库的安全性是保护数据库防止不合法使用所造成的数据泄露、更改和破坏。</p>
</li>
<li><p>数据库的不安全因素</p>
<ol>
<li>非授权用户对数据库的恶意存取和破坏</li>
<li>数据库中重要或敏感的数据被泄露</li>
<li>安全环境的脆弱性</li>
</ol>
</li>
</ol>
<p>[3] 用户身份的鉴别</p>
<ol>
<li>静态口令鉴别（密码）</li>
<li>动态口令的鉴别（验证码）</li>
<li>生物特征鉴别</li>
<li>智能卡鉴别</li>
</ol>
<h4 id="数据库的安全性控制"><a href="#数据库的安全性控制" class="headerlink" title="数据库的安全性控制"></a>数据库的安全性控制</h4><p>[1] The GRANT 语法</p>
<blockquote>
<p>作用：由表&#x2F;视图表的所有者发布，以向其他用户授权多种访问权限</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> &#123; <span class="keyword">ALL</span> PRIVILEGES <span class="operator">|</span> <span class="operator">&lt;</span>权限<span class="operator">&gt;</span> &#123;, <span class="operator">&lt;</span>权限<span class="operator">&gt;</span>…&#125;&#125;</span><br><span class="line"><span class="keyword">ON</span> [<span class="keyword">TABLE</span>] tablename <span class="operator">|</span> viewname</span><br><span class="line"><span class="keyword">TO</span> &#123;PUBLIC <span class="operator">|</span> <span class="keyword">user</span><span class="operator">-</span>name &#123;,<span class="keyword">user</span><span class="operator">-</span>name…&#125;&#125; [<span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION]</span><br></pre></td></tr></table></figure>

<p>➢ WITH GRANT OPTION——用户可以授予其他用户相同的权限<br>➢ 表的所有者自动拥有所有权限，并且不能被撤销</p>
<p>[2] 所有类型的访问权限</p>
<p>SELECT, DELETE, INSERT, UPDATE [(colname {, colname})], </p>
<p>REFERENCES [(colname {, colname})] (this privilege grants the right to reference the specified columns from a foreign key)</p>
<p>[3] Example1. Grant select, update, insert , but not to delete to “tom” on table orders. Then give “tom” authorization for all operations on products.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">select</span>, <span class="keyword">update</span>, <span class="keyword">insert</span> <span class="keyword">ON</span> orders <span class="keyword">to</span> tom;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">all</span> privileges <span class="keyword">ON</span> products <span class="keyword">to</span> tom;</span><br></pre></td></tr></table></figure>

<p>[4] Example2. Grant permission to user “tom” on customers table to insert, delete any row, update only the “cname” and “city” columns, and select all columns other than the “distinct” column.</p>
<p>(1) The owner first creates a view. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> cview <span class="keyword">as</span> <span class="keyword">select</span> cid, cname ,city <span class="keyword">from</span> customers;</span><br></pre></td></tr></table></figure>

<p>(2) Then the owner provides the necessary authorization:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>, <span class="keyword">delete</span>, <span class="keyword">insert</span>, <span class="keyword">update</span> (cname, city) <span class="keyword">on</span> cview <span class="keyword">to</span> tom;</span><br></pre></td></tr></table></figure>

<p>[5] Example3. Grant permission to user “tom” to perform all accesses on agents with percent greater than 5.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">view</span> agentv <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> agents <span class="keyword">where</span> <span class="keyword">percent</span> <span class="operator">&gt;</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> agentv <span class="keyword">to</span> tom;</span><br></pre></td></tr></table></figure>

<p>[6] REVOKE 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> &#123;<span class="keyword">ALL</span> PRIVILEGES <span class="operator">|</span> priv &#123;, priv…&#125;&#125; <span class="keyword">on</span> tablename <span class="operator">|</span> viewname</span><br><span class="line"><span class="keyword">FROM</span> &#123; PUBLIC <span class="operator">|</span> <span class="keyword">user</span> &#123;, <span class="keyword">user</span>…&#125; &#125; [CASCADE <span class="operator">|</span>RESTRICT];</span><br></pre></td></tr></table></figure>

<p>➢ CASCADE——-用户授予的特权和权限都将被删除。<br>➢ RESTRICT——用户的特权被删除，他授予其他用户的特权不被删除。</p>
<p>Example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> agent <span class="keyword">from</span> tom restrict;</span><br></pre></td></tr></table></figure>



<h2 id="七、索引（Indexing）"><a href="#七、索引（Indexing）" class="headerlink" title="七、索引（Indexing）"></a>七、索引（Indexing）</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> testalter_tbl <span class="keyword">ADD</span> INDEX (c);</span><br><span class="line"># 删除索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> testalter_tbl <span class="keyword">DROP</span> INDEX (c);</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.haungrd.top">Huang RD</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.haungrd.top/2023/02/15/%E6%95%B0%E6%8D%AE%E5%BA%93/">http://www.haungrd.top/2023/02/15/%E6%95%B0%E6%8D%AE%E5%BA%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.haungrd.top" target="_blank">Huang Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><div class="post_share"><div class="social-share" data-image="https://www.huangrd.top/images/agentina/7.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/17/JUC/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JUC</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/13/java%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/7.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Java 集合源码分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/11/20/MySQL/" title="Mysql"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/13.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-20</div><div class="title">Mysql</div></div></a></div><div><a href="/2023/02/06/Mysql%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%93/" title="MYSQL刷题总结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/12.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-06</div><div class="title">MYSQL刷题总结</div></div></a></div><div><a href="/2023/03/17/MySQL%E5%A4%8D%E4%B9%A0%E6%8F%90%E5%8D%87/" title="Mysql 复习提升"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-17</div><div class="title">Mysql 复习提升</div></div></a></div><div><a href="/2023/03/03/Redis%E5%A4%8D%E4%B9%A0%E6%8F%90%E5%8D%87/" title="Redis 复习提升"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-03</div><div class="title">Redis 复习提升</div></div></a></div><div><a href="/2023/02/11/mysql45%E8%AE%B2%E7%AC%94%E8%AE%B0/" title="Mysql 45讲笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-11</div><div class="title">Mysql 45讲笔记</div></div></a></div><div><a href="/2023/02/27/%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/" title="面试题整理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/13.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-27</div><div class="title">面试题整理</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%BB%E7%BB%93"><span class="toc-text">数据库总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A6%82%E8%BF%B0"><span class="toc-text">整体概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%BB%AA%E8%AE%BA%EF%BC%88Introduction%EF%BC%89"><span class="toc-text">一、绪论（Introduction）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">1、数据库基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7"><span class="toc-text">2、数据库用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E8%A7%88"><span class="toc-text">3、关系数据库概览</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93-%EF%BC%88The-Relational-Model%EF%BC%89"><span class="toc-text">二、关系数据库 （The Relational Model）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81-CAP-%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">1、 CAP 实例数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90"><span class="toc-text">2、数据库系统组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%85%B3%E7%B3%BB%E8%A7%84%E5%88%99"><span class="toc-text">3、关系规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E9%94%AE%E3%80%81%E8%B6%85%E9%94%AE%E5%8F%8A%E7%A9%BA%E5%80%BC"><span class="toc-text">4、键、超键及空值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%85%B3%E7%B3%BB%E4%BB%A3%E6%95%B0"><span class="toc-text">5、关系代数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E9%9B%86%E5%90%88%E8%AE%BA%E6%93%8D%E4%BD%9C"><span class="toc-text">6、集合论操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E4%BC%A0%E7%BB%9F%E5%85%B3%E7%B3%BB%E6%93%8D%E4%BD%9C"><span class="toc-text">7、传统关系操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E5%85%B3%E7%B3%BB%E6%93%8D%E4%BD%9C%E5%AE%9E%E4%BE%8B"><span class="toc-text">8、关系操作实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%87%E5%87%86%E8%AF%AD%E8%A8%80SQL%EF%BC%88Basic-SQL-Query-Language%EF%BC%89"><span class="toc-text">三、关系数据库标准语言SQL（Basic SQL Query Language）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81SQL-%E8%AF%AD%E8%A8%80%E6%A6%82%E8%BF%B0"><span class="toc-text">1、SQL 语言概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL%E7%9A%84%E5%88%86%E7%B1%BB%E5%92%8C%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="toc-text">SQL的分类和功能：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">2、建立数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E5%85%88%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-text">预先知识：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CREATE-TABLE-%E8%AF%AD%E5%8F%A5"><span class="toc-text">CREATE TABLE 语句</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%AE%80%E5%8D%95-Select-%E5%8F%A5"><span class="toc-text">3、简单 Select 句</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SELECT-%E8%AF%AD%E6%B3%95"><span class="toc-text">SELECT 语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A"><span class="toc-text">例题：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%AD%90%E6%9F%A5%E8%AF%A2%E3%80%81%E8%B0%93%E8%AF%8D"><span class="toc-text">4、子查询、谓词</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-text">子查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Summary"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Quantified-Comparison-Predicate-%E9%87%8F%E5%8C%96%E6%AF%94%E8%BE%83%E8%B0%93%E8%AF%8D"><span class="toc-text">Quantified Comparison Predicate 量化比较谓词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%89%E6%95%88%E5%85%B3%E7%B3%BB%EF%BC%9A"><span class="toc-text">等效关系：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXISTS-%E8%B0%93%E8%AF%8D"><span class="toc-text">EXISTS 谓词</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81UNION-%E6%93%8D%E4%BD%9C%E5%8F%8A-ALL-%E6%9D%A1%E4%BB%B6"><span class="toc-text">5、UNION 操作及 ALL 条件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UNION%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">UNION运算符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Division%E9%99%A4%E6%B3%95"><span class="toc-text">Division除法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81SQL-%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95"><span class="toc-text">6、SQL 高级语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UNION%E3%80%81INTERSECT%E3%80%81EXCEPT"><span class="toc-text">UNION、INTERSECT、EXCEPT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JOIN-IN"><span class="toc-text">JOIN IN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Outer-Join"><span class="toc-text">Outer Join</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E9%9B%86%E5%87%BD%E6%95%B0"><span class="toc-text">7、集函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E5%88%86%E7%BB%84GROUP"><span class="toc-text">8、分组GROUP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GROUP%E3%80%81HAVING%E8%AF%AD%E6%B3%95"><span class="toc-text">GROUP、HAVING语法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E5%AE%8C%E6%95%B4-Select-%E5%8F%A5"><span class="toc-text">9、完整 Select 句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81Insert%E3%80%81Update-%E5%92%8C-Delete-%E5%8F%A5"><span class="toc-text">10、Insert、Update 和 Delete 句</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#INSERT"><span class="toc-text">INSERT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UPDATE"><span class="toc-text">UPDATE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DELETE"><span class="toc-text">DELETE</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B%EF%BC%88Program-to-Access-a-Database%EF%BC%89"><span class="toc-text">四、数据库编程（Program to Access a Database）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%B5%8C%E5%85%A5%E5%BC%8F-SQL-C%E8%AF%AD%E8%A8%80-Embedded-SQL"><span class="toc-text">1、嵌入式 SQL(C语言)Embedded SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87%E7%A8%8B%E5%BA%8F%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%9F"><span class="toc-text">如何通过程序访问数据库中的数据？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8C%89%E7%A8%8B%E5%BA%8F%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%EF%BC%9F"><span class="toc-text">如何按程序使用数据？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B8%B8%E8%A7%81%E7%9A%84%E5%B5%8C%E5%85%A5%E5%BC%8FSQL%E8%AF%AD%E5%8F%A5"><span class="toc-text">2、常见的嵌入式SQL语句</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-text">嵌入式查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%88%A0%E9%99%A4"><span class="toc-text">嵌入式删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E6%9B%B4%E6%96%B0"><span class="toc-text">嵌入式更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E6%8F%92%E5%85%A5"><span class="toc-text">嵌入式插入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B5%8C%E5%85%A5%E5%BC%8Fsql"><span class="toc-text">其他嵌入式sql</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%9D%A1%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-text">3、条件处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Whenever"><span class="toc-text">Whenever</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%B8%BB%E5%8F%98%E9%87%8F%E6%A3%80%E6%9F%A5%E9%94%99%E8%AF%AF"><span class="toc-text">通过主变量检查错误</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%BA%8B%E5%8A%A1%E7%BC%96%E7%A8%8BTransactions"><span class="toc-text">4、事务编程Transactions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1Transaction"><span class="toc-text">事务Transaction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8C%87%E5%AE%9A%E4%BA%8B%E5%8A%A1"><span class="toc-text">如何指定事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transaction-Isolation-and-Locking-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E5%92%8C%E9%94%81"><span class="toc-text">Transaction Isolation and Locking 事务隔离和锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-text">死锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">5、总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%EF%BC%88Database-Design%EF%BC%89"><span class="toc-text">五、数据库设计（Database Design）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4"><span class="toc-text">补充：数据库设计的基本步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81E-R%E5%9B%BE"><span class="toc-text">1、E-R图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E3%80%81%E5%B1%9E%E6%80%A7%E3%80%81E-R%E5%9B%BE%EF%BC%88Entities-Attributes-E-R-Diagrams%EF%BC%89"><span class="toc-text">实体、属性、E-R图（Entities,Attributes,E-R Diagrams）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%AE%9E%E4%BD%93%E5%92%8C%E5%B1%9E%E6%80%A7%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%85%B3%E7%B3%BB"><span class="toc-text">将实体和属性转换为关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">实体之间的关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81E-R%E5%BB%BA%E6%A8%A1%E7%9A%84%E8%BF%9B%E4%B8%80%E6%AD%A5%E7%BB%86%E8%8A%82"><span class="toc-text">2、E-R建模的进一步细节</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E7%9A%84%E5%9F%BA%E6%95%B0-%E5%85%B3%E7%B3%BB%E7%9A%84%E5%9F%BA%E6%95%B0"><span class="toc-text">实体的基数(关系的基数)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81N-N%E3%80%811-N-Relationships"><span class="toc-text">1-1、N-N、1-N Relationships</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E4%BA%8C%E5%85%83%E5%85%B3%E7%B3%BB%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%85%B3%E7%B3%BB-%E5%85%AD%E6%9D%A1%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99"><span class="toc-text">将二元关系转换为关系(六条转换规则)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%8C%83%E5%BC%8F"><span class="toc-text">3、范式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%8C%E6%95%B4%E6%80%A7%E3%80%81%E5%AE%89%E5%85%A8%E6%80%A7%E3%80%81%E8%A7%86%E5%9B%BE%EF%BC%88Integrity-Views-Security%EF%BC%89"><span class="toc-text">六、数据库的完整性、安全性、视图（Integrity,Views, Security）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A6%E6%9D%9F"><span class="toc-text">1、完整性约束</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Create-Table%E8%AF%AD%E5%8F%A5%E4%B8%AD%E7%9A%84%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A6%E6%9D%9F"><span class="toc-text">Create Table语句中的完整性约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Primary-Keys-Foreign-Keys-Referent"><span class="toc-text">Primary-Keys, Foreign-Keys, Referent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Alter-Table-Statement-%E6%9B%B4%E6%94%B9%E8%A1%A8%E5%A3%B0%E6%98%8E"><span class="toc-text">Alter Table Statement 更改表声明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Non-Procedural-x2F-Procedural-Integrity-Constraints-%E9%9D%9E%E7%A8%8B%E5%BA%8F-x2F-%E7%A8%8B%E5%BA%8F%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A6%E6%9D%9F"><span class="toc-text">Non-Procedural &#x2F; Procedural Integrity Constraints 非程序&#x2F;程序完整性约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8Triggers"><span class="toc-text">触发器Triggers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">总结：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%A7%86%E5%9B%BE-View"><span class="toc-text">2、视图 View</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2"><span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%9B%B4%E6%96%B0%E8%A7%86%E5%9B%BE%E5%92%8C%E5%8F%AA%E8%AF%BB%E8%A7%86%E5%9B%BE"><span class="toc-text">可更新视图和只读视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">视图的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-text">3、安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3"><span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E6%8E%A7%E5%88%B6"><span class="toc-text">数据库的安全性控制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E7%B4%A2%E5%BC%95%EF%BC%88Indexing%EF%BC%89"><span class="toc-text">七、索引（Indexing）</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Huang RD</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Rabbit MQ | Huang Blog</title><meta name="author" content="Huang RD"><meta name="copyright" content="Huang RD"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Rabbit MQMQ基本概念MQ概述MQ全称 Message Queue（消息队列），是在消息的传输过程中保存消息的容器。多用于分布式系统之间进行通信。 直接调用：  改进为： 借助第三方完成通信   MQ，消息队列，存储消息的中间件 分布式系统通信两种方式：直接远程调用 和 借助第三方 完成间接通信 发送方称为生产者，接收方称为消费者  MQ的优劣 MQ的优势应用解耦 对于修改相关连的子系统，">
<meta property="og:type" content="article">
<meta property="og:title" content="Rabbit MQ">
<meta property="og:url" content="http://www.haungrd.top/2022/11/20/RabbitMQ/index.html">
<meta property="og:site_name" content="Huang Blog">
<meta property="og:description" content="Rabbit MQMQ基本概念MQ概述MQ全称 Message Queue（消息队列），是在消息的传输过程中保存消息的容器。多用于分布式系统之间进行通信。 直接调用：  改进为： 借助第三方完成通信   MQ，消息队列，存储消息的中间件 分布式系统通信两种方式：直接远程调用 和 借助第三方 完成间接通信 发送方称为生产者，接收方称为消费者  MQ的优劣 MQ的优势应用解耦 对于修改相关连的子系统，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.huangrd.top/images/agentina/8.jpg">
<meta property="article:published_time" content="2022-11-20T04:12:57.000Z">
<meta property="article:modified_time" content="2022-11-21T15:26:01.262Z">
<meta property="article:author" content="Huang RD">
<meta property="article:tag" content="消息队列">
<meta property="article:tag" content="Rabbit MQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.huangrd.top/images/agentina/8.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.haungrd.top/2022/11/20/RabbitMQ/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Rabbit MQ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-21 23:26:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://getwallpapers.com/wallpaper/full/a/1/8/1057222-free-download-cool-nature-backgrounds-1920x1200-windows-10.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://www.huangrd.top/images/agentina/8.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Huang Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Rabbit MQ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-20T04:12:57.000Z" title="发表于 2022-11-20 12:12:57">2022-11-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-21T15:26:01.262Z" title="更新于 2022-11-21 23:26:01">2022-11-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>56分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Rabbit MQ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Rabbit-MQ"><a href="#Rabbit-MQ" class="headerlink" title="Rabbit MQ"></a>Rabbit MQ</h1><h2 id="MQ基本概念"><a href="#MQ基本概念" class="headerlink" title="MQ基本概念"></a>MQ基本概念</h2><h3 id="MQ概述"><a href="#MQ概述" class="headerlink" title="MQ概述"></a>MQ概述</h3><p>MQ全称 Message Queue（消息队列），是在<code>消息的传输过程中保存消息的容器</code>。多用于<code>分布式系统之间进行通信</code>。</p>
<p>直接调用：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171023027.png" alt="image-20221017102354985"></p>
<p>改进为：</p>
<p>借助第三方完成通信</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171024464.png" alt="image-20221017102411430"></p>
<ul>
<li>MQ，消息队列，存储消息的中间件</li>
<li>分布式系统通信两种方式：直接远程调用 和 借助第三方 完成间接通信</li>
<li>发送方称为生产者，接收方称为消费者</li>
</ul>
<h3 id="MQ的优劣"><a href="#MQ的优劣" class="headerlink" title="MQ的优劣"></a>MQ的优劣</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171026966.png" alt="image-20221017102603930"></p>
<h4 id="MQ的优势"><a href="#MQ的优势" class="headerlink" title="MQ的优势"></a>MQ的优势</h4><h5 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171026208.png" alt="image-20221017102635168"></p>
<p>对于修改相关连的子系统，需要对整个系统进行修改。系统耦合度高。</p>
<p><strong>系统的耦合性越高，容错性就越低，可维护性就越低</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171027077.png" alt="image-20221017102753030"></p>
<p>使用MQ，订单系统的信息直接存入MQ，后续的相关业务系统通过访问MQ来获取信息。</p>
<p><strong>使用 MQ 使得应用间解耦，提升容错性和可维护性。</strong></p>
<h5 id="异步提速"><a href="#异步提速" class="headerlink" title="异步提速"></a>异步提速</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171029229.png" alt="image-20221017102929182"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171029493.png" alt="image-20221017102951445"></p>
<p>利用MQ，用户输入信息后，先存在MQ，直接对用户进行相应，降低延迟。后续业务可以利用多线程完成。</p>
<h5 id="削峰填谷"><a href="#削峰填谷" class="headerlink" title="削峰填谷"></a>削峰填谷</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171031679.png" alt="image-20221017103158632"></p>
<p>如果系统可接受的请求数量小于发送的请求数量，系统就会直接崩掉。利用MQ来缓存请求信息，可以保证服务器的稳定，保证其正常运行。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171033114.png" alt="image-20221017103321069"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171033709.png" alt="image-20221017103337658"></p>
<ul>
<li>应用解耦：提高系统容错性和可维护性</li>
<li>异步提速：提升用户体验和系统吞吐量</li>
<li>削峰填谷：提高系统稳定性</li>
</ul>
<h4 id="MQ的劣势"><a href="#MQ的劣势" class="headerlink" title="MQ的劣势"></a>MQ的劣势</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171035406.png" alt="image-20221017103519369"></p>
<h5 id="系统可用性降低"><a href="#系统可用性降低" class="headerlink" title="系统可用性降低"></a>系统可用性降低</h5><p>系统引入的外部依赖越多，系统稳定性越差。一旦 MQ 宕机，就会对业务造成影响。如何保证MQ的高可用？</p>
<h5 id="系统复杂度降低"><a href="#系统复杂度降低" class="headerlink" title="系统复杂度降低"></a>系统复杂度降低</h5><p>MQ 的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过 MQ 进行异步调用。如何保证消息没有被重复消费？怎么处理消息丢失情况？那么保证消息传递的顺序性？</p>
<h5 id="一致性问题"><a href="#一致性问题" class="headerlink" title="一致性问题"></a>一致性问题</h5><p>A 系统处理完业务，通过 MQ 给B、C、D三个系统发消息数据，如果 B 系统、C 系统处理成功，D 系统处理失败。如何保证消息数据处理的一致性？</p>
<hr>
<p>对于MQ的优劣，MQ 需要满足什么条件：</p>
<p>① 生产者不需要从消费者处获得反馈。引入消息队列之前的直接调用，其接口的返回值应该为空，这才让明</p>
<p>明下层的动作还没做，上层却当成动作做完了继续往后走，即所谓异步成为了可能。</p>
<p>② 容许短暂的不一致性。</p>
<p>③ 确实是用了有效果。即解耦、提速、削峰这些方面的收益，超过加入MQ，管理MQ这些成本</p>
<h3 id="常见的MQ产品"><a href="#常见的MQ产品" class="headerlink" title="常见的MQ产品"></a>常见的MQ产品</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171039420.png" alt="image-20221017103935360"></p>
<h3 id="Rabbit-MQ简介"><a href="#Rabbit-MQ简介" class="headerlink" title="Rabbit MQ简介"></a>Rabbit MQ简介</h3><p><strong>AMQP</strong>，即 Advanced Message Queuing Protocol（<code>高级消息队列协议</code>），是一个网络协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端&#x2F;中间件不同产品，不同的开发语言等条件的限制。2006年，AMQP 规范发布。类比HTTP。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171040287.png" alt="image-20221017104038246"></p>
<p>2007年，Rabbit 技术公司基于 AMQP 标准开发的 RabbitMQ 1.0 发布。RabbitMQ 采用 Erlang 语言开发。</p>
<p>Erlang 语言由 Ericson 设计，专门为开发<code>高并发和分布式系统</code>的一种语言，在电信领域使用广泛。</p>
<p>RabbitMQ 基础架构如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171041216.png" alt="image-20221017104125171"></p>
<hr>
<p>RabbitMQ 中的相关概念：</p>
<ul>
<li><p>Broker：接收和分发消息的应用，RabbitMQ Server就是 Message Broker</p>
</li>
<li><p>Virtual host（虚拟机）：出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个vhost，每个用户在自己的 vhost 创建 exchange／queue 等</p>
</li>
<li><p>Connection：publisher／consumer 和 broker 之间的 TCP 连接</p>
</li>
<li><p>Channel：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection的开销将是巨大的，效率也较低。Channel 是在 <code>connection 内部建立的逻辑连接</code>，如果应用程序支持多线程，通常每个thread创建单独的 channel 进行通讯，AMQP method 包含了channel id 帮助客户端和message broker 识别 channel，所以 channel 之间是完全隔离的。<strong>Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销</strong></p>
</li>
<li><p>Exchange(交换机)：message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到queue 中去。常用的类型有：direct (point-to-point), topic (publish-subscribe) and fanout (multicast)</p>
</li>
<li><p>Queue（队列）：消息最终被送到这里等待 consumer 取走</p>
</li>
<li><p>Binding（绑定）：exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key。Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据</p>
</li>
</ul>
<hr>
<p>RabbitMQ 提供了 6 种<strong>工作模式</strong>：简单模式、work queues、Publish&#x2F;Subscribe 发布与订阅模式、Routing路由式、Topics 主题模式、RPC 远程调用模式（远程调用，不太算 MQ；暂不作介绍）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171046024.png" alt="image-20221017104656973"></p>
<h3 id="JMS"><a href="#JMS" class="headerlink" title="JMS"></a>JMS</h3><ul>
<li><p>JMS 即 Java 消息服务（JavaMessage Service）应用程序接口，是一个 Java 平台中关于面向消息中间件的API</p>
</li>
<li><p>JMS 是 JavaEE 规范中的一种，类比JDBC</p>
</li>
<li><p>很多消息中间件都实现了JMS规范，例如：ActiveMQ。RabbitMQ 官方没有提供 JMS 的实现包，但是开源社区有</p>
</li>
</ul>
<p><strong>小结</strong></p>
<ol>
<li><p>RabbitMQ 是基于 AMQP 协议使用 Erlang 语言开发的一款消息队列产品。</p>
</li>
<li><p>RabbitMQ提供了6种工作模式，我们学习5种。这是今天的重点。</p>
</li>
<li><p>AMQP 是协议，类比HTTP。</p>
</li>
<li><p>JMS 是 API 规范接口，类比 JDBC。</p>
</li>
</ol>
<h2 id="MQ快速入门"><a href="#MQ快速入门" class="headerlink" title="MQ快速入门"></a>MQ快速入门</h2><p>需求：使用简单模式完成消息传递</p>
<p>步骤：</p>
<p>① 创建工程（生成者、消费者）</p>
<p>② 分别添加依赖</p>
<p>③ 编写生产者发送消息</p>
<p>④ 编写消费者接收消息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171050480.png" alt="image-20221017105000425"></p>
<p>和JDBC操作数据库类似</p>
<p>生产者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">        * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">        * 3.exclusive：</span></span><br><span class="line"><span class="comment">        *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">        *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">        * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">        * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;hello_world&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.发送消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body)</span></span><br><span class="line"><span class="comment">        * 1.exchange： 交换机的名称。简单模式交换机会使用默认的。</span></span><br><span class="line"><span class="comment">        * 2.routingKey： 路由名称</span></span><br><span class="line"><span class="comment">        * 3.props： 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 发送消息数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;hello rabbit_mq!!!&quot;</span>;</span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;hello_world&quot;</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7.释放资源</span></span><br><span class="line">    channel.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">         * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">         * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">         * 3.exclusive：</span></span><br><span class="line"><span class="comment">         *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">         *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">         * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">         * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;hello_world&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">        * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">        * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">        * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">            *</span></span><br><span class="line"><span class="comment">            * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">            * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">            * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">            * 4.body： 数据</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;consumerTag：&quot;</span> + consumerTag);</span><br><span class="line">            System.out.println(<span class="string">&quot;Exchange：&quot;</span> + envelope.getExchange());</span><br><span class="line">            System.out.println(<span class="string">&quot;RoutingKey：&quot;</span> + envelope.getRoutingKey());</span><br><span class="line">            System.out.println(<span class="string">&quot;properties：&quot;</span> + properties);</span><br><span class="line">            System.out.println(<span class="string">&quot;body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(<span class="string">&quot;hello_world&quot;</span>, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MQ的工作模式"><a href="#MQ的工作模式" class="headerlink" title="MQ的工作模式"></a>MQ的工作模式</h2><h3 id="Work-Queue工作队列模式"><a href="#Work-Queue工作队列模式" class="headerlink" title="Work Queue工作队列模式"></a>Work Queue工作队列模式</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171052332.png" alt="image-20221017105234298"></p>
<ul>
<li><p><strong>Work Queues：</strong>与入门程序的简单模式相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的息。</p>
</li>
<li><p><strong>应用场景</strong>：对于任务过重或任务较多情况使用工作队列可以提高任务处理的速度</p>
</li>
</ul>
<p>生产者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">    * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">    * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">    * 3.exclusive：</span></span><br><span class="line"><span class="comment">    *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">    *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">    * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">    * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.发送消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body)</span></span><br><span class="line"><span class="comment">    * 1.exchange： 交换机的名称。简单模式交换机会使用默认的。</span></span><br><span class="line"><span class="comment">    * 2.routingKey： 路由名称</span></span><br><span class="line"><span class="comment">    * 3.props： 配置信息</span></span><br><span class="line"><span class="comment">    * 4.body： 发送消息数据</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> i + <span class="string">&quot;hello rabbit_mq!!!&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;work_queues&quot;</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.释放资源</span></span><br><span class="line">    channel.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结</strong></p>
<ol>
<li><p>在一个队列中如果有多个消费者，那么消费者之间对于同一个消息的关系是<strong>竞争</strong>的关系。</p>
</li>
<li><p><strong>Work Queues</strong> 对于任务过重或任务较多情况使用工作队列可以提高任务处理的速度。例如：短信服务部署多个，只需要有一个节点成功发送即。</p>
</li>
</ol>
<h3 id="Pub-x2F-Sub-订阅模式"><a href="#Pub-x2F-Sub-订阅模式" class="headerlink" title="Pub&#x2F;Sub 订阅模式"></a>Pub&#x2F;Sub 订阅模式</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171055713.png" alt="image-20221017105524673"></p>
<p>多了一台交换机</p>
<p>在订阅模型中，多了一个 Exchange 角色，而且过程略有变化：</p>
<ul>
<li><p>P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</p>
</li>
<li><p>C：消费者，消息的接收者，会一直等待消息到来</p>
</li>
<li><p>Queue：消息队列，接收消息、缓存消息</p>
</li>
<li><p>Exchange：交换机（X）。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有常见以下3种型：</p>
</li>
</ul>
<p>➢ Fanout：广播，将消息交给所有绑定到交换机的队列</p>
<p>➢ Direct：定向，把消息交给符合指定routing key 的队列</p>
<p>➢ Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</p>
<p><strong>Exchange</strong>（交换机）只负责转发消息，不具备存储消息的能力，因此如果没有任何队列与 Exchange 绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<p>生产者:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建交换机</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">    * 1.exchange:交换机名称</span></span><br><span class="line"><span class="comment">    * 2.type：交换机类型</span></span><br><span class="line"><span class="comment">    *   DIRECT(&quot;direct&quot;),定向</span></span><br><span class="line"><span class="comment">        FANOUT(&quot;fanout&quot;),扇形（广播），发送消息到每一个与之绑定的队列</span></span><br><span class="line"><span class="comment">        TOPIC(&quot;topic&quot;),通配符的方式</span></span><br><span class="line"><span class="comment">        HEADERS(&quot;headers&quot;);参数匹配</span></span><br><span class="line"><span class="comment">     3.durable：是否持久化</span></span><br><span class="line"><span class="comment">     4.autoDelete：是否自动删除</span></span><br><span class="line"><span class="comment">     5.internal：内部使用。一般false</span></span><br><span class="line"><span class="comment">     6.arguments:参数</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_fanout&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName, BuiltinExchangeType.FANOUT, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//6.创建队列</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line">    channel.queueDeclare(queue1Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    channel.queueDeclare(queue2Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//7.绑定队列和交换机</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">    * 1.queue：队列名称</span></span><br><span class="line"><span class="comment">    * 2.exchange：交换机名称</span></span><br><span class="line"><span class="comment">    * 3.routingKey：路由键，绑定规则     如果交换机的类型为fanout,routingKey设置为&quot;&quot;</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    channel.queueBind(queue1Name, exchangeName, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name, exchangeName, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">//8.发送消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;日志信息：张三调用了finaAll方法...日志级别：info...&quot;</span>;</span><br><span class="line">    channel.basicPublish(exchangeName, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">    <span class="comment">//9.释放资源</span></span><br><span class="line">    channel.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            System.out.println(<span class="string">&quot;将日志信息打印到控制台....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(queue1Name, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            System.out.println(<span class="string">&quot;将日志信息保存数据库....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(queue2Name, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <strong>小结</strong></p>
<ol>
<li><p>交换机需要与队列进行绑定，绑定之后；一个消息可以被多个消费者都收到。</p>
</li>
<li><p>发布订阅模式与工作队列模式的区别：</p>
<ul>
<li><p>工作队列模式不用定义交换机，而发布&#x2F;订阅模式需要定义交换机</p>
</li>
<li><p>发布&#x2F;订阅模式的生产方是面向交换机发送消息，工作队列模式的生产方是面向队列发送消息(底层使用默认交换机)</p>
</li>
<li><p>发布&#x2F;订阅模式需要设置队列和交换机的绑定，工作队列模式不需要设置，实际上工作队列模式会将队列绑定到默认的交换机</p>
</li>
</ul>
</li>
</ol>
<h3 id="Routing路由模式"><a href="#Routing路由模式" class="headerlink" title="Routing路由模式"></a>Routing路由模式</h3><ul>
<li><p>队列与交换机的绑定，不能是任意绑定了，而是要指定一个 RoutingKey（路由key）</p>
</li>
<li><p>消息的发送方在向 Exchange 发送消息时，也必须指定消息的 RoutingKey</p>
</li>
<li><p>Exchange 不再把消息交给每一个绑定的队列，而是根据消息的 Routing Key 进行判断，<code>只有队列的Routingkey 与消息的 Routing key 完全一致</code>，才会接收到消息</p>
</li>
</ul>
<p>图解：<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171101955.png" alt="image-20221017110151906"></p>
<ul>
<li><p>P：生产者，向 Exchange 发送消息，发送消息时，会指定一个routing key</p>
</li>
<li><p>X：Exchange（交换机），接收生产者的消息，然后把消息递交给与 routing key 完全匹配的队列</p>
</li>
<li><p>C1：消费者，其所在队列指定了需要 routing key 为 error 的消息</p>
</li>
<li><p>C2：消费者，其所在队列指定了需要 routing key 为 info、error、warning 的消息</p>
</li>
</ul>
<p>生产者:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建交换机</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">    * 1.exchange:交换机名称</span></span><br><span class="line"><span class="comment">    * 2.type：交换机类型</span></span><br><span class="line"><span class="comment">    *   DIRECT(&quot;direct&quot;),定向</span></span><br><span class="line"><span class="comment">        FANOUT(&quot;fanout&quot;),扇形（广播），发送消息到每一个与之绑定的队列</span></span><br><span class="line"><span class="comment">        TOPIC(&quot;topic&quot;),通配符的方式</span></span><br><span class="line"><span class="comment">        HEADERS(&quot;headers&quot;);参数匹配</span></span><br><span class="line"><span class="comment">     3.durable：是否持久化</span></span><br><span class="line"><span class="comment">     4.autoDelete：是否自动删除</span></span><br><span class="line"><span class="comment">     5.internal：内部使用。一般false</span></span><br><span class="line"><span class="comment">     6.arguments:参数</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_direct&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName, BuiltinExchangeType.DIRECT, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//6.创建队列</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line">    channel.queueDeclare(queue1Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    channel.queueDeclare(queue2Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//7.绑定队列和交换机</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">    * 1.queue：队列名称</span></span><br><span class="line"><span class="comment">    * 2.exchange：交换机名称</span></span><br><span class="line"><span class="comment">    * 3.routingKey：路由键，绑定规则     如果交换机的类型为fanout,routingKey设置为&quot;&quot;</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="comment">//队列1的绑定error</span></span><br><span class="line">    channel.queueBind(queue1Name, exchangeName, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    <span class="comment">//队列2的绑定info error warning</span></span><br><span class="line">    channel.queueBind(queue2Name, exchangeName, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name, exchangeName, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name, exchangeName, <span class="string">&quot;warning&quot;</span>);</span><br><span class="line">    <span class="comment">//8.发送消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;日志信息：张三调用了delete方法...出错了...日志级别：error...&quot;</span>;</span><br><span class="line">    channel.basicPublish(exchangeName, <span class="string">&quot;error&quot;</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">    <span class="comment">//9.释放资源</span></span><br><span class="line">    channel.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            System.out.println(<span class="string">&quot;将日志信息存储在数据库....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(queue1Name, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            System.out.println(<span class="string">&quot;将日志信息打印到控制台....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(queue2Name, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Routing</strong> 模式要求队列在绑定交换机时要指定 <strong>routing key</strong>，消息会转发到符合 routing key 的队列。</p>
<h3 id="Topics通配符模式"><a href="#Topics通配符模式" class="headerlink" title="Topics通配符模式"></a>Topics通配符模式</h3><ul>
<li><p>Topic 类型与 Direct 相比，都是可以根据 RoutingKey 把消息路由到不同的队列。只不过 Topic 类型Exchange 可以让队列在绑定 Routing key 的时候使用<strong>通配符</strong>！</p>
</li>
<li><p>Routingkey 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： item.insert </p>
</li>
<li><p>通配符规则：# 匹配一个或多个词，* 匹配不多不少恰好1个词，例如：item.# 能够匹配 item.insert.abc 或者 item.insert，item.* 只能匹配 item.insert</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171106259.png" alt="image-20221017110625191"></p>
<ul>
<li><p>红色 Queue：绑定的是 usa.# ，因此凡是以 usa. 开头的 routing key 都会被匹配到</p>
</li>
<li><p>黄色 Queue：绑定的是 #.news ，因此凡是以 .news 结尾的 routing key 都会被匹配</p>
</li>
</ul>
<p>生产者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建交换机</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">    * 1.exchange:交换机名称</span></span><br><span class="line"><span class="comment">    * 2.type：交换机类型</span></span><br><span class="line"><span class="comment">    *   DIRECT(&quot;direct&quot;),定向</span></span><br><span class="line"><span class="comment">        FANOUT(&quot;fanout&quot;),扇形（广播），发送消息到每一个与之绑定的队列</span></span><br><span class="line"><span class="comment">        TOPIC(&quot;topic&quot;),通配符的方式</span></span><br><span class="line"><span class="comment">        HEADERS(&quot;headers&quot;);参数匹配</span></span><br><span class="line"><span class="comment">     3.durable：是否持久化</span></span><br><span class="line"><span class="comment">     4.autoDelete：是否自动删除</span></span><br><span class="line"><span class="comment">     5.internal：内部使用。一般false</span></span><br><span class="line"><span class="comment">     6.arguments:参数</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_topic&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName, BuiltinExchangeType.TOPIC, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//6.创建队列</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue2&quot;</span>;</span><br><span class="line">    channel.queueDeclare(queue1Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    channel.queueDeclare(queue2Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//7.绑定队列和交换机</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">    * 1.queue：队列名称</span></span><br><span class="line"><span class="comment">    * 2.exchange：交换机名称</span></span><br><span class="line"><span class="comment">    * 3.routingKey：路由键，绑定规则     如果交换机的类型为fanout,routingKey设置为&quot;&quot;</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="comment">//routing key 系统的名称 日志的级别</span></span><br><span class="line">    <span class="comment">//需求：所有error级别的日志存在数据库，所有order系统的日志存在数据库</span></span><br><span class="line">    channel.queueBind(queue1Name, exchangeName, <span class="string">&quot;#.error&quot;</span>);</span><br><span class="line">    channel.queueBind(queue1Name, exchangeName, <span class="string">&quot;order.*&quot;</span>);</span><br><span class="line">    channel.queueBind(queue2Name, exchangeName, <span class="string">&quot;*.*&quot;</span>);</span><br><span class="line">    <span class="comment">//8.发送消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;日志信息：张三调用了finaAll方法...日志级别：info...&quot;</span>;</span><br><span class="line">    channel.basicPublish(exchangeName, <span class="string">&quot;.error&quot;</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">    <span class="comment">//9.释放资源</span></span><br><span class="line">    channel.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            System.out.println(<span class="string">&quot;将日志信息存入数据库....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(queue1Name, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">//1.创建连接工厂</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">//2.设置参数</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;192.168.184.100&quot;</span>);<span class="comment">//ip 默认值 localhost</span></span><br><span class="line">    factory.setPort(<span class="number">5672</span>);<span class="comment">//端口 默认值5672</span></span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/itcast&quot;</span>);<span class="comment">//虚拟机 默认值/</span></span><br><span class="line">    factory.setUsername(<span class="string">&quot;dong&quot;</span>);<span class="comment">//用户名 默认 guest</span></span><br><span class="line">    factory.setPassword(<span class="string">&quot;dong&quot;</span>);<span class="comment">//密码 默认 guest</span></span><br><span class="line">    <span class="comment">//3.创建连接 Connection</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">//4.创建Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.创建队列Queue</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">     * 1.queue： 队列名称</span></span><br><span class="line"><span class="comment">     * 2.durable： 是否持久化，当mq重启后，还在</span></span><br><span class="line"><span class="comment">     * 3.exclusive：</span></span><br><span class="line"><span class="comment">     *   是否独占，只有一个消费者能够监听这个队列</span></span><br><span class="line"><span class="comment">     *   当Connection关闭时，是否删除队列</span></span><br><span class="line"><span class="comment">     * 4.autoDelete： 是否自动删除。当没有Consumer时，自动删除掉</span></span><br><span class="line"><span class="comment">     * 5.arguments： 参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="comment">//如果没有一个叫hello_world的队列，则创建该队列，如果有该队列，则不创建</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">    * 1.queue: 队列名称</span></span><br><span class="line"><span class="comment">    * 2.autoAck： 是否自动确认</span></span><br><span class="line"><span class="comment">    * 3.callback： 回调对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 回调方法，当收到消息后，会自动执行该方法</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 1.consumerTag： 标识</span></span><br><span class="line"><span class="comment">        * 2.envelope： 获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">        * 3.properties: 配置信息</span></span><br><span class="line"><span class="comment">        * 4.body： 数据</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*System.out.println(&quot;consumerTag：&quot; + consumerTag);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;Exchange：&quot; + envelope.getExchange());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;RoutingKey：&quot; + envelope.getRoutingKey());</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;properties：&quot; + properties);*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;body:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            System.out.println(<span class="string">&quot;将日志信息打印控制台....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel.basicConsume(queue2Name, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源？消费者是监听程序，不需要关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结</strong></p>
<p>Topic 主题模式可以实现 Pub&#x2F;Sub 发布与订阅模式和 Routing 路由模式的功能，只是 Topic 在配置routing key 的时候可以使用通配符，显得更加灵活。</p>
<h3 id="工作模式总结"><a href="#工作模式总结" class="headerlink" title="工作模式总结"></a>工作模式总结</h3><ol>
<li>简单模式 HelloWorld</li>
</ol>
<p>一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）。</p>
<ol start="2">
<li>工作队列模式 Work Queue</li>
</ol>
<p>一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）。</p>
<ol start="3">
<li>发布订阅模式 Publish&#x2F;subscribe</li>
</ol>
<p>需要设置类型为 fanout 的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列。</p>
<ol start="4">
<li>路由模式 Routing</li>
</ol>
<p>需要设置类型为 direct 的交换机，交换机和队列进行绑定，并且指定 routing key，当发送消息到交换机</p>
<p>后，交换机会根据 routing key 将消息发送到对应的队列。</p>
<ol start="5">
<li>通配符模式 Topic</li>
</ol>
<p>需要设置类型为 topic 的交换机，交换机和队列进行绑定，并且指定通配符方式的 routing key，当发送</p>
<p>消息到交换机后，交换机会根据 routing key 将消息发送到对应的队列。</p>
<h2 id="Spring-Boot整合Rabbit-MQ"><a href="#Spring-Boot整合Rabbit-MQ" class="headerlink" title="Spring Boot整合Rabbit MQ"></a>Spring Boot整合Rabbit MQ</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210171110248.png" alt="image-20221017111012195"></p>
<h3 id="创建Boot工程"><a href="#创建Boot工程" class="headerlink" title="创建Boot工程"></a>创建Boot工程</h3><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>需要的依赖是springboot整合rabbitmq, spring-boot-starter-amqp是springboot整合rabbitmq的包。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置Rabbit-MQ的基本信息"><a href="#配置Rabbit-MQ的基本信息" class="headerlink" title="配置Rabbit MQ的基本信息"></a>配置Rabbit MQ的基本信息</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/itcast</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br></pre></td></tr></table></figure>

<h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><p>生产者编写代码发送信息。</p>
<p>生产者编写Rabbit MQ的配置信息。配置交换机、队列以及队列和交换机的绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;boot_topic_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;boot_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">bootExchange</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.队列交换机绑定关系 Binding</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 1.知道那个队列</span></span><br><span class="line"><span class="comment">    * 2.知道那个交换机</span></span><br><span class="line"><span class="comment">    * 3.routing key</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchange</span><span class="params">(<span class="meta">@Qualifier(&quot;bootQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;bootExchange&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;boot.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者利用<code>RabbitTemplate</code>来发送信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.注入RabbitTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSend</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME, <span class="string">&quot;boot.haha&quot;</span>, <span class="string">&quot;boot mq hello!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者编写消息监听器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ListenerQueue</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        <span class="comment">//System.out.println(message);</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：</p>
<ul>
<li><p>使用 Spring 整合 RabbitMQ 将组件全部使用配置方式实现，简化编码</p>
</li>
<li><p>Spring 提供 RabbitTemplate 简化发送消息 API</p>
</li>
<li><p>使用监听机制简化消费者编码</p>
</li>
</ul>
<h2 id="Rabbit-MQ高级特性"><a href="#Rabbit-MQ高级特性" class="headerlink" title="Rabbit MQ高级特性"></a>Rabbit MQ高级特性</h2><h3 id="消息的可靠投递"><a href="#消息的可靠投递" class="headerlink" title="消息的可靠投递"></a>消息的可靠投递</h3><p>在使用 RabbitMQ 的时候，作为消息发送方希望杜绝任何消息丢失或者投递失败场景。RabbitMQ 为我们提供了两种方式用来控制消息的投递可靠性模式。</p>
<ul>
<li><p>confirm 确认模式</p>
</li>
<li><p>return 退回模式</p>
</li>
</ul>
<p>rabbitmq 整个消息投递的路径为：</p>
<p>producer—&gt;rabbitmq broker—&gt;exchange—&gt;queue—&gt;consumer</p>
<ul>
<li><p>消息从 producer 到 exchange 则会返回一个 confirmCallback(confirm 确认模式) 。</p>
</li>
<li><p>消息从 exchange–&gt;queue 投递失败则会返回一个 returnCallback(return 退回模式) 。</p>
</li>
</ul>
<p>我们将利用这两个 callback 控制消息的可靠性投递</p>
<p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;test_exchange_confirm&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;test_queue_confirm&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">confirmExchange</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ExchangeBuilder.directExchange(EXCHANGE_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">confirmQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.队列交换机绑定关系 Binding</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 1.知道那个队列</span></span><br><span class="line"><span class="comment">    * 2.知道那个交换机</span></span><br><span class="line"><span class="comment">    * 3.routing key</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchange</span><span class="params">(<span class="meta">@Qualifier(&quot;confirmQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;confirmExchange&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;confirm&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置RabbitMQ的基本信息 ip端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/itcast</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="comment"># 确认模式开启</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span></span><br><span class="line">    <span class="comment"># 回退模式开启</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="confirm确认模式"><a href="#confirm确认模式" class="headerlink" title="confirm确认模式"></a>confirm确认模式</h4><p>确认模式：</p>
<ul>
<li>步骤：<ul>
<li><ol>
<li>确认模式开启：publisher-confirm-type: correlated</li>
</ol>
</li>
<li><ol start="2">
<li>在rabbitTemplate定义confirmCallBack回调函数</li>
</ol>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认模式：</span></span><br><span class="line"><span class="comment">     *  步骤：</span></span><br><span class="line"><span class="comment">     *      1. 确认模式开启：publisher-confirm-type: correlated</span></span><br><span class="line"><span class="comment">     *      2. 在rabbitTemplate定义confirmCallBack回调函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConfirm</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 定义回调</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback()&#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> correlationData 相关的配置信息</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> ack exchange交换机 是否成功收到了消息。true 成功， false 失败</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> cause 失败原因</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;confirm running...&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">                    <span class="comment">//接收成功</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;accepting success:&quot;</span> + cause);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//接收失败</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;accepting fail:&quot;</span> + cause);</span><br><span class="line">                    <span class="comment">//做一些处理，让消息再次发送</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="return退回模式"><a href="#return退回模式" class="headerlink" title="return退回模式"></a>return退回模式</h4><p>回退模式： 当消息发送给 Exchange 后，Exchange 路由到 Queue 失败后才会执行 ReturnCallBack</p>
<ul>
<li>步骤：<ol>
<li>开启回退模式 publisher-returns: true</li>
<li>设置ReturnCallBack</li>
<li>设置Exchange处理消息的模式：<ol>
<li>如果消息没有路由到Queue,则丢弃消息（默认）</li>
<li>如果消息没有路由到Queue,返回给消息发送方ReturnCallBack</li>
</ol>
</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回退模式： 当消息发送给 Exchange 后，Exchange 路由到 Queue 失败后才会执行 ReturnCallBack</span></span><br><span class="line"><span class="comment">     *  步骤：</span></span><br><span class="line"><span class="comment">     *      1. 开启回退模式 publisher-returns: true</span></span><br><span class="line"><span class="comment">     *      2. 设置ReturnCallBack</span></span><br><span class="line"><span class="comment">     *      3. 设置Exchange处理消息的模式：</span></span><br><span class="line"><span class="comment">     *         3.1 如果消息没有路由到Queue,则丢弃消息（默认）</span></span><br><span class="line"><span class="comment">     *         3.2 如果消息没有路由到Queue,返回给消息发送方ReturnCallBack</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReturn</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置交换机处理失败消息的模式</span></span><br><span class="line">    rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 设置ReturnCallBack</span></span><br><span class="line">    rabbitTemplate.setReturnCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnCallback()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> message 消息对象</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> replyCode 错误码</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> replyText 错误信息</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> routingKey 路由器</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;return running...&quot;</span>);</span><br><span class="line">            System.out.println(message);</span><br><span class="line">            System.out.println(replyCode);</span><br><span class="line">            System.out.println(replyText);</span><br><span class="line">            System.out.println(exchange);</span><br><span class="line">            System.out.println(routingKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm2&quot;</span>, <span class="string">&quot;message confirm&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消息的可靠投递小结"><a href="#消息的可靠投递小结" class="headerlink" title="消息的可靠投递小结"></a>消息的可靠投递小结</h4><p>➢ 配置application.yml的publisher-confirm-type: correlated 开启确认模式。</p>
<p>➢ 使用rabbitTemplate.setConfirmCallback设置回调函数。当消息发送到exchange后回调confirm方法。在方法中判断ack，如果为true，则发送成功，如果为false，则发送失败，需要处理。</p>
<p>➢ 配置application.yml的publisher-returns: true开启 退回模式。</p>
<p>➢ 使用rabbitTemplate.setReturnCallback设置退回函数，当消息从exchange路由到queue失败后，如果设置了rabbitTemplate.setMandatory(true)参数，则会将消息退回给producer。并执行回调函数returnedMessage。</p>
<p>➢ 在RabbitMQ中也提供了事务机制，但是性能较差，此处不做讲解。</p>
<p>使用channel下列方法，完成事务控制：</p>
<p>txSelect(), 用于将当前channel设置成transaction模式</p>
<p>txCommit()，用于提交事务</p>
<p>txRollback(),用于回滚事务</p>
<h3 id="Consumer-Ack"><a href="#Consumer-Ack" class="headerlink" title="Consumer Ack"></a>Consumer Ack</h3><p>ack指Acknowledge，确认。 表示消费端收到消息后的确认方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">类比confirm</span><br><span class="line">confirm是consumer到broker</span><br><span class="line">ack是broker到consumer</span><br></pre></td></tr></table></figure>

<p>有三种确认方式：</p>
<ul>
<li><p>自动确认：acknowledge&#x3D;”none”</p>
</li>
<li><p>手动确认：acknowledge&#x3D;”manual”</p>
</li>
<li><p>根据异常情况确认：acknowledge&#x3D;”auto”（这种方式使用麻烦，不作讲解）</p>
</li>
</ul>
<p>其中自动确认是指，当消息一旦被Consumer接收到，则自动确认收到，并将相应 message 从 RabbitMQ 的消息缓存中移除。但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该消息就会丢失。</p>
<p>如果设置了手动确认方式，则需要在业务处理成功后，调用channel.basicAck()，手动签收。</p>
<p>如果出现异常，则调用channel.basicNack()方法，让其自动重新发送消息。</p>
<h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * Consumer ACK机制：</span></span><br><span class="line"><span class="comment"> *   1. 设置手动签收 acknowledge-mode: manual</span></span><br><span class="line"><span class="comment"> *   2. 让监听器实现 ChannelAwareMessageListener</span></span><br><span class="line"><span class="comment"> *   3. 如果消息成功处理，则调用channel的basicAck()签收</span></span><br><span class="line"><span class="comment"> *   4. 如果消息处理失败，则调用channel的basicNck()拒绝签收，broker重新发给consumer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AckListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;test_queue_confirm&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. 接受转换消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">&quot;handle business logic&quot;</span>);</span><br><span class="line">            <span class="comment">//int i = 3 / 0;</span></span><br><span class="line">            <span class="comment">//3. 手动签收</span></span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">true</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//4. 拒绝签收</span></span><br><span class="line">            <span class="comment">/***</span></span><br><span class="line"><span class="comment">             * 第三个参数requeue：重回队列。如果设置为true,则重回queue，broker会重新发送该消息给消费端</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicNack(deliveryTag, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//channel.basicReject(deliveryTag, true);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置RabbitMQ的基本信息 ip端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/itcast</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">direct:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure>

<h4 id="Consumer-Ack-小结"><a href="#Consumer-Ack-小结" class="headerlink" title="Consumer Ack 小结"></a>Consumer Ack 小结</h4><p>➢ 在appliacation.yml标签中设置acknowledge-mode属性，设置ack方式 none：自动确认，manual：手动确认</p>
<p>➢ 如果在消费端没有出现异常，则调用channel.basicAck(deliveryTag,false);方法确认签收消息</p>
<p>➢ 如果出现异常，则在catch中调用 basicNack或 basicReject，拒绝消息，让MQ重新发送消息。</p>
<h3 id="消费端限流"><a href="#消费端限流" class="headerlink" title="消费端限流"></a>消费端限流</h3><p>请求瞬间增多，每秒5000个请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210180831992.png" alt="image-20221018083146873"></p>
<h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * Consumer 限流机制：</span></span><br><span class="line"><span class="comment"> * 1. 确保ack机制为手动确认。</span></span><br><span class="line"><span class="comment"> * 2. 配置属性</span></span><br><span class="line"><span class="comment"> *  perfetch = 1，表示消费端每次从mq拉取一天消息来消费，直到手动确认消费完毕后，才会继续拉取下一条消息。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QosListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;test_queue_confirm&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//1. 获取消息</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 签收</span></span><br><span class="line">        <span class="comment">//channel.basicAck(message.getMessageProperties().getDeliveryTag(), true);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置RabbitMQ的基本信息 ip端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">dong</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/itcast</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="消费端限流小结"><a href="#消费端限流小结" class="headerlink" title="消费端限流小结"></a>消费端限流小结</h4><p>➢ 在alllication.yml 中配置 prefetch属性设置消费端一次拉取多少消息</p>
<p>➢ 消费端的确认模式一定为手动确认。acknowledge&#x3D;”manual”</p>
<h3 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>➢ TTL 全称 Time To Live（存活时间&#x2F;过期时间）。</p>
<p>➢ 当消息到达存活时间后，还没有被消费，会被自动清除。</p>
<p>➢ RabbitMQ可以对消息设置过期时间，也可以对整个队列（Queue）设置过期时间。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210181832870.png" alt="image-20221018183210610"></p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfigTTL</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;test_exchange_ttl&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;test_queue_ttl&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">ttlExchange</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="comment">// 设置queue的过期时间</span></span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">ttlQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).ttl(<span class="number">10000</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.队列交换机绑定关系 Binding</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 1.知道那个队列</span></span><br><span class="line"><span class="comment">    * 2.知道那个交换机</span></span><br><span class="line"><span class="comment">    * 3.routing key</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchange</span><span class="params">(<span class="meta">@Qualifier(&quot;ttlQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;ttlExchange&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;ttl.*&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<ol>
<li><p>队列的统一过期时间</p>
</li>
<li><p>消息单独过期</p>
</li>
</ol>
<ul>
<li>如果设置了消息的过期时间，也设置了队列的过期时间，以时间短的为准。</li>
<li>队列过期后，会将队列所有信息全部移除。</li>
<li>消息过期后，只有消息在队列顶端，才会判断其是否过期了（移除掉）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TTL:过期时间</span></span><br><span class="line"><span class="comment"> * 1. 队列的统一过期时间</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2. 消息单独过期</span></span><br><span class="line"><span class="comment"> * 如果设置了消息的过期时间，也设置了队列的过期时间，以时间短的为准。</span></span><br><span class="line"><span class="comment"> * 队列过期后，会将队列所有信息全部移除。</span></span><br><span class="line"><span class="comment"> * 消息过期后，只有消息在队列顶端，才会判断其是否过期了（移除掉）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTtl</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/*// 队列的统一过期时间</span></span><br><span class="line"><span class="comment">    for (int i = 0; i &lt; 10; i++) &#123;</span></span><br><span class="line"><span class="comment">        //发送消息</span></span><br><span class="line"><span class="comment">        rabbitTemplate.convertAndSend(&quot;test_exchange_ttl&quot;, &quot;ttl.haha&quot;, &quot;message ttl....&quot;);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息单独过期</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息的后处理对象，设置一些信息的参数信息</span></span><br><span class="line">    <span class="type">MessagePostProcessor</span> <span class="variable">messagePostProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            <span class="comment">//1. 设置message的信息</span></span><br><span class="line">            message.getMessageProperties().setExpiration(<span class="string">&quot;5000&quot;</span>);<span class="comment">//消息过期时间</span></span><br><span class="line">            <span class="comment">//2. 返回该消息</span></span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//rabbitTemplate.convertAndSend(&quot;test_exchange_ttl&quot;, &quot;ttl.haha&quot;, &quot;message ttl....&quot;, messagePostProcessor);</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="comment">//消息单独过期</span></span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_ttl&quot;</span>, <span class="string">&quot;ttl.haha&quot;</span>, <span class="string">&quot;message ttl....&quot;</span>, messagePostProcessor);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//不过期的消息</span></span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_ttl&quot;</span>, <span class="string">&quot;ttl.haha&quot;</span>, <span class="string">&quot;message ttl....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TTL-小结"><a href="#TTL-小结" class="headerlink" title="TTL 小结"></a>TTL 小结</h4><p>➢ 设置队列过期时间使用参数：x-message-ttl，单位：ms(毫秒)，会对整个队列消息统一过期。</p>
<p>➢ 设置消息过期时间使用参数：expiration。单位：ms(毫秒)，当该消息在队列头部时（消费时），会单独判断这一消息是否过期。</p>
<p>➢ 如果两者都进行了设置，以时间短的为准。</p>
<h3 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a><strong>死信队列</strong></h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><p>死信队列，英文缩写：DLX 。Dead Letter Exchange（死信交换机），当消息成为Dead message后，可以被重新发送到另一个交换机，这个交换机就是DLX。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210181917671.png" alt="image-20221018191726586"></p>
<h4 id="消息成为死信的三种情况"><a href="#消息成为死信的三种情况" class="headerlink" title="消息成为死信的三种情况"></a>消息成为死信的三种情况</h4><ol>
<li><p>队列消息长度到达限制；</p>
</li>
<li><p>消费者拒接消费消息，basicNack&#x2F;basicReject,并且不把消息重新放入原目标队列,requeue&#x3D;false；</p>
</li>
<li><p>原队列存在消息过期设置，消息到达超时时间未被消费；</p>
</li>
</ol>
<h4 id="队列绑定死信交换机"><a href="#队列绑定死信交换机" class="headerlink" title="队列绑定死信交换机"></a>队列绑定死信交换机</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210181920148.png" alt="image-20221018192015082"></p>
<p>给队列设置参数： x-dead-letter-exchange 和 x-dead-letter-routing-key</p>
<h4 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h4><p>配置类配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//死信交换机和死信队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_DLX_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue_dlx&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DLX_NAME</span> <span class="operator">=</span> <span class="string">&quot;exchange_dlx&quot;</span>;</span><br><span class="line">    <span class="comment">//正常交换机和正常队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NORMAL_NAME</span> <span class="operator">=</span> <span class="string">&quot;the_queue_dlx&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NORMAL_NAME</span> <span class="operator">=</span> <span class="string">&quot;the_exchange_dlx&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;normalExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">normalExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NORMAL_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//死信交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;dlxExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">dlxExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_DLX_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;normalQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">normalQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">        <span class="comment">//x-dead-letter-exchange    这里声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, EXCHANGE_DLX_NAME);</span><br><span class="line">        <span class="comment">//x-dead-letter-routing-key  这里声明当前队列的死信路由key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;dlx.hehe&quot;</span>);</span><br><span class="line">        <span class="comment">//过期时间</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>,<span class="number">10000</span>);</span><br><span class="line">        <span class="comment">//最大长度</span></span><br><span class="line">        args.put(<span class="string">&quot;x-max-length&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NORMAL_NAME).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//死信队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;dlxQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">dlxQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_DLX_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.正常队列交换机绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchangeNormal</span><span class="params">(<span class="meta">@Qualifier(&quot;normalQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;normalExchange&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;the.dlx.*&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.死信队列交换机绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchangeDlx</span><span class="params">(<span class="meta">@Qualifier(&quot;dlxQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;dlxExchange&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;dlx.*&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.正常队列绑定死信交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchangeDlxNormal</span><span class="params">(<span class="meta">@Qualifier(&quot;dlxQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;normalExchange&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;dlx.hehe&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 发送测试死信消息：</span></span><br><span class="line"><span class="comment">     * 1.过期时间</span></span><br><span class="line"><span class="comment">     * 2.长度限制</span></span><br><span class="line"><span class="comment">     * 3.消息拒收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDlx</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//1. 测试过期时间，死信消息</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;the_exchange_dlx&quot;, &quot;the.dlx.haha&quot;, &quot;message dlx??....&quot;);</span></span><br><span class="line">        <span class="comment">//2. 测试长度限制，消息死信</span></span><br><span class="line"><span class="comment">//        for (int i = 0; i &lt; 20; i++) &#123;</span></span><br><span class="line"><span class="comment">//            rabbitTemplate.convertAndSend(&quot;the_exchange_dlx&quot;, &quot;the.dlx.haha&quot;, &quot;message dlx??....&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">//3. 测试消息绝收</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;the_exchange_dlx&quot;</span>, <span class="string">&quot;the.dlx.haha&quot;</span>, <span class="string">&quot;message dlx??....&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DlxListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="comment">//定义监听器，监听正常队列</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;the_queue_dlx&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. 接受转换消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">&quot;handle business logic&quot;</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span> / <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//3. 手动签收</span></span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">true</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/***</span></span><br><span class="line"><span class="comment">             * 第三个参数requeue：重回队列。如果设置为true,则重回queue，broker会重新发送该消息给消费端</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            System.out.println(<span class="string">&quot;出现异常，拒绝接受&quot;</span>);</span><br><span class="line">            <span class="comment">//4. 拒绝签收，不重回队列，requeue=false</span></span><br><span class="line">            channel.basicNack(deliveryTag, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="comment">//channel.basicReject(deliveryTag, true);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="死信队列小结"><a href="#死信队列小结" class="headerlink" title="死信队列小结"></a>死信队列小结</h4><ol>
<li>死信交换机和死信队列和普通的没有区别</li>
<li>当消息成为死信后，如果该队列绑定了死信交换机，则消息会被死信交换机重新路由到死信队列</li>
<li>消息成为死信的三种情况：<ol>
<li>队列消息长度到达限制；</li>
<li>消费者拒接消费消息，并且不重回队列；</li>
<li>原队列存在消息过期设置，消息到达超时时间未被消费；</li>
</ol>
</li>
</ol>
<h3 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a><strong>延迟队列</strong></h3><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><p>延迟队列，即消息进入队列后不会立即被消费，只有到达指定时间后，才会被消费。</p>
<p>需求：</p>
<ol>
<li><p>下单后，30分钟未支付，取消订单，回滚库存。</p>
</li>
<li><p>新用户注册成功7天后，发送短信问候。</p>
</li>
</ol>
<p>实现方式：</p>
<ol>
<li><p>定时器（不好，不优雅，开销大）</p>
</li>
<li><p>延迟队列</p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210191032656.png" alt="image-20221019103248546"></p>
<p>很可惜，在RabbitMQ中并未提供延迟队列功能。</p>
<p>但是可以使用：TTL+死信队列 组合实现延迟队列的效果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210191036225.png" alt="image-20221019103614158"></p>
<h4 id="Code-2"><a href="#Code-2" class="headerlink" title="Code"></a>Code</h4><p>配置类：</p>
<ul>
<li>配值死信队列、死信交换机</li>
<li>配置正常队列、正常交换机</li>
<li>正常队列绑定正常交换机</li>
<li>死信队列绑定死信交换机</li>
<li>正常队列绑定死信交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 延迟队列：</span></span><br><span class="line"><span class="comment">     * 1. 定义正常交换机order_exchange和队列order_queue</span></span><br><span class="line"><span class="comment">     * 2. 定义死信交换机exchange_order_dlx和队列queue_order_dlx</span></span><br><span class="line"><span class="comment">     * 3. 绑定，设置正常队列过期时间为30min</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//死信交换机和死信队列</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_ORDER_DLX_NAME</span> <span class="operator">=</span> <span class="string">&quot;queue_order_dlx&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_ORDER_DLX_NAME</span> <span class="operator">=</span> <span class="string">&quot;exchange_order_dlx&quot;</span>;</span><br><span class="line"><span class="comment">//正常交换机和正常队列</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_ORDER_NAME</span> <span class="operator">=</span> <span class="string">&quot;order_queue&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_ORDER_NAME</span> <span class="operator">=</span> <span class="string">&quot;order_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//正常交换机</span></span><br><span class="line"><span class="meta">@Bean(&quot;orderExchange&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Exchange <span class="title function_">orderExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_ORDER_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//死信交换机</span></span><br><span class="line"><span class="meta">@Bean(&quot;exchangeOrderDlx&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Exchange <span class="title function_">exchangeOrderDlx</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_ORDER_DLX_NAME).durable(<span class="literal">true</span>).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//正常队列</span></span><br><span class="line"><span class="meta">@Bean(&quot;orderQueue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">orderQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">    <span class="comment">//x-dead-letter-exchange    这里声明当前队列绑定的死信交换机</span></span><br><span class="line">    args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, EXCHANGE_ORDER_DLX_NAME);</span><br><span class="line">    <span class="comment">//x-dead-letter-routing-key  这里声明当前队列的死信路由key</span></span><br><span class="line">    args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;dlx.order.cancel&quot;</span>);</span><br><span class="line">    <span class="comment">//过期时间</span></span><br><span class="line">    args.put(<span class="string">&quot;x-message-ttl&quot;</span>,<span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(QUEUE_ORDER_NAME).withArguments(args).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//死信队列</span></span><br><span class="line"><span class="meta">@Bean(&quot;queueOrderDlx&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">queueOrderDlx</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(QUEUE_ORDER_DLX_NAME).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//正常队列交换机绑定</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchangePOrderNormal</span><span class="params">(<span class="meta">@Qualifier(&quot;orderQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;orderExchange&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;order.*&quot;</span>).noargs();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//死信队列交换机绑定</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchangeOrderDlx</span><span class="params">(<span class="meta">@Qualifier(&quot;queueOrderDlx&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;exchangeOrderDlx&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;dlx.order.*&quot;</span>).noargs();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//正常队列绑定死信交换机</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingQueueExchangeOrderDlxNormal</span><span class="params">(<span class="meta">@Qualifier(&quot;orderQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;exchangeOrderDlx&quot;)</span> Exchange exchange)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;&quot;</span>).noargs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者测试发送消息：向正常交换机发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 延迟队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelay</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">//1. 发送订单消息。将来是在订单系统中，下单完成，发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;order_exchange&quot;</span>, <span class="string">&quot;order.msg&quot;</span>, <span class="string">&quot;订单：id=1;name=huang&quot;</span>);</span><br><span class="line">    <span class="comment">//2. 打印倒计时</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        System.out.println(i + <span class="string">&quot;...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者：监听死信队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    <span class="comment">//延时队列：定义监听器，监听死信队列</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;queue_order_dlx&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. 接受转换消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">&quot;handle business logic&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;根据订单id查询其状态...&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;判断订单是否支付成功...&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;取消订单，回滚库存...&quot;</span>);</span><br><span class="line">            <span class="comment">//3. 手动签收</span></span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">true</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/***</span></span><br><span class="line"><span class="comment">             * 第三个参数requeue：重回队列。如果设置为true,则重回queue，broker会重新发送该消息给消费端</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            System.out.println(<span class="string">&quot;出现异常，拒绝接受&quot;</span>);</span><br><span class="line">            <span class="comment">//4. 拒绝签收，不重回队列，requeue=false</span></span><br><span class="line">            channel.basicNack(deliveryTag, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//channel.basicReject(deliveryTag, true);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果：10秒后监听死信队列的监听器响应。</p>
<h4 id="延迟队列小结"><a href="#延迟队列小结" class="headerlink" title="延迟队列小结"></a>延迟队列小结</h4><ol>
<li><p>延迟队列 指消息进入队列后，可以被延迟一定时间，再进行消费。</p>
</li>
<li><p>RabbitMQ没有提供延迟队列功能，但是可以使用 ： TTL + DLX 来实现延迟队列效果。</p>
</li>
</ol>
<h3 id="日志与监控"><a href="#日志与监控" class="headerlink" title="日志与监控"></a>日志与监控</h3><h4 id="RabbitMQ日志"><a href="#RabbitMQ日志" class="headerlink" title="RabbitMQ日志"></a>RabbitMQ日志</h4><p>RabbitMQ默认日志存放路径： &#x2F;var&#x2F;log&#x2F;rabbitmq&#x2F;<a href="mailto:&#114;&#97;&#98;&#x62;&#x69;&#116;&#x40;&#120;&#120;&#120;&#46;&#x6c;&#111;&#103;">&#114;&#97;&#98;&#x62;&#x69;&#116;&#x40;&#120;&#120;&#120;&#46;&#x6c;&#111;&#103;</a></p>
<p>日志包含了RabbitMQ的版本号、Erlang的版本号、RabbitMQ服务节点名称、cookie的hash值、RabbitMQ配置文件地址、内存限制、磁盘限制、默认账户guest的创建以及权限配置等等。</p>
<h4 id="web管控台监控"><a href="#web管控台监控" class="headerlink" title="web管控台监控"></a>web管控台监控</h4><h4 id="rabbitmqctl管理和监控"><a href="#rabbitmqctl管理和监控" class="headerlink" title="rabbitmqctl管理和监控"></a>rabbitmqctl管理和监控</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">查看队列</span><br><span class="line"># rabbitmqctl list_queues</span><br><span class="line">查看exchanges</span><br><span class="line"># rabbitmqctl list_exchanges</span><br><span class="line">查看用户</span><br><span class="line"># rabbitmqctl list_users</span><br><span class="line">查看连接</span><br><span class="line"># rabbitmqctl list_connections</span><br><span class="line">查看消费者信息</span><br><span class="line"># rabbitmqctl list_consumers</span><br><span class="line">查看环境变量</span><br><span class="line"># rabbitmqctl environment</span><br><span class="line">查看未被确认的队列</span><br><span class="line"># rabbitmqctl list_queues name messages_unacknowledged</span><br><span class="line">查看单个队列的内存使用</span><br><span class="line"># rabbitmqctl list_queues name memory</span><br><span class="line">查看准备就绪的队列</span><br><span class="line"># rabbitmqctl list_queues name messages_ready</span><br></pre></td></tr></table></figure>

<h3 id="消息追踪"><a href="#消息追踪" class="headerlink" title="消息追踪"></a>消息追踪</h3><p>在使用任何消息中间件的过程中，难免会出现某条消息异常丢失的情况。对于RabbitMQ而言，可能是因为生产者或消费者与RabbitMQ断开了连接，而它们与RabbitMQ又采用了不同的确认机制；也有可能是因为交换器与队列之间不同的转发策略；甚至是交换器并没有与任何队列进行绑定，生产者又不感知或者没有采取相应的措施；另外RabbitMQ本身的集群策略也可能导致消息的丢失。这个时候就需要有一个较好的机制跟踪记录消息的投递过程，以此协助开发和运维人员进行问题的定位。</p>
<p>在RabbitMQ中可以使用Firehose和rabbitmq_tracing插件功能来实现消息追踪。</p>
<h4 id="消息追踪-Firehose"><a href="#消息追踪-Firehose" class="headerlink" title="消息追踪-Firehose"></a>消息追踪-Firehose</h4><p>firehose的机制是将生产者投递给rabbitmq的消息，rabbitmq投递给消费者的消息按照指定的格式发送到默认的exchange上。这个默认的exchange的名称为amq.rabbitmq.trace，它是一个topic类型的exchange。发送到这个exchange上的消息的routing key为 publish.exchangename 和deliver.queuename。其中exchangename和queuename为实际exchange和queue的名称，分别对应生产者投递到exchange的消息，和消费者从queue上获取的消息。</p>
<p>注意：打开 trace 会影响消息写入功能，适当打开后请关闭。</p>
<p>rabbitmqctl trace_on：开启Firehose命令</p>
<p>rabbitmqctl trace_off：关闭Firehose命令</p>
<p>指定虚拟机开启：rabbitmqctl trace_on -p &#x2F;itcast</p>
<h4 id="消息追踪-rabbitmq-tracing"><a href="#消息追踪-rabbitmq-tracing" class="headerlink" title="消息追踪-rabbitmq_tracing"></a>消息追踪-rabbitmq_tracing</h4><p>rabbitmq_tracing和Firehose在实现上如出一辙，只不过rabbitmq_tracing的方式比Firehose多了一层GUI的包装，更容易使用和管理。</p>
<p>启用插件：rabbitmq-plugins enable rabbitmq_tracing</p>
<p>关闭插件：rabbitmq-plugins disable rabbitmq_tracing</p>
<h2 id="Rabbit-MQ应用问题"><a href="#Rabbit-MQ应用问题" class="headerlink" title="Rabbit MQ应用问题"></a>Rabbit MQ应用问题</h2><h3 id="消息可靠性保障"><a href="#消息可靠性保障" class="headerlink" title="消息可靠性保障"></a><strong>消息可靠性保障</strong></h3><p>需求：</p>
<p>100%确保消息发送成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210191246843.png" alt="image-20221019124645756"></p>
<h3 id="消息幂等性保障"><a href="#消息幂等性保障" class="headerlink" title="消息幂等性保障"></a><strong>消息幂等性保障</strong></h3><p>幂等性指一次和多次请求某一个资源，对于资源本身应该具有同样的结果。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。</p>
<p>在MQ中指，消费多条相同的消息，得到与消费该消息一次相同的结果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/messi-study-java/pic_go/raw/master/img/202210191256721.png" alt="image-20221019125631634"></p>
<h2 id="Rabbit-MQ集群搭建"><a href="#Rabbit-MQ集群搭建" class="headerlink" title="Rabbit MQ集群搭建"></a>Rabbit MQ集群搭建</h2><h2 id="Spring-Boot配置Rabbit-MQ"><a href="#Spring-Boot配置Rabbit-MQ" class="headerlink" title="Spring Boot配置Rabbit MQ"></a>Spring Boot配置Rabbit MQ</h2><ol>
<li>可以在配置文件中配置属性（全局）</li>
<li>在@RabbitListener配置contanierFactory属性</li>
</ol>
<p>inux系统：centos7<br>1.启动前，查看mq状态</p>
<p>systemctl status rabbitmq-server<br>2.启动</p>
<p>systemctl start rabbitmq-server<br>3.停止</p>
<p>systemctl stop rabbitmq-server<br>4.重启</p>
<p>restart<br>5.打开浏览器管理页面：默认端口号15672</p>
<p>systemctl status firewalld<br>&#x2F;&#x2F;关闭防火墙<br>systemctl disable firewalld<br>systemctl stop firewalld<br>6.登陆<br>用户名和密码都是guest</p>
<p>7.插件管理相关命令</p>
<p>rabbitmq-plugins enable|list|disable</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.haungrd.top">Huang RD</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.haungrd.top/2022/11/20/RabbitMQ/">http://www.haungrd.top/2022/11/20/RabbitMQ/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.haungrd.top" target="_blank">Huang Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><a class="post-meta__tags" href="/tags/Rabbit-MQ/">Rabbit MQ</a></div><div class="post_share"><div class="social-share" data-image="https://www.huangrd.top/images/agentina/8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/11/20/css/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/11.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CSS</div></div></a></div><div class="next-post pull-right"><a href="/2022/11/20/html/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.huangrd.top/images/agentina/2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">HTML</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://getwallpapers.com/wallpaper/full/a/1/8/1057222-free-download-cool-nature-backgrounds-1920x1200-windows-10.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Huang RD</div><div class="author-info__description">Huang Rui Dong Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/A-JAVAer-HRD"><i class="fab fa-github"></i><span>了解我..</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/A-JAVAer-HRD" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangruidong.xauat@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Rabbit-MQ"><span class="toc-text">Rabbit MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MQ%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">MQ基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E6%A6%82%E8%BF%B0"><span class="toc-text">MQ概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E7%9A%84%E4%BC%98%E5%8A%A3"><span class="toc-text">MQ的优劣</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MQ%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-text">MQ的优势</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6"><span class="toc-text">应用解耦</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%8F%90%E9%80%9F"><span class="toc-text">异步提速</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8A%E5%B3%B0%E5%A1%AB%E8%B0%B7"><span class="toc-text">削峰填谷</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQ%E7%9A%84%E5%8A%A3%E5%8A%BF"><span class="toc-text">MQ的劣势</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%AF%E7%94%A8%E6%80%A7%E9%99%8D%E4%BD%8E"><span class="toc-text">系统可用性降低</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%A4%8D%E6%9D%82%E5%BA%A6%E9%99%8D%E4%BD%8E"><span class="toc-text">系统复杂度降低</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">一致性问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84MQ%E4%BA%A7%E5%93%81"><span class="toc-text">常见的MQ产品</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rabbit-MQ%E7%AE%80%E4%BB%8B"><span class="toc-text">Rabbit MQ简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JMS"><span class="toc-text">JMS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">MQ快速入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQ%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-text">MQ的工作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Work-Queue%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="toc-text">Work Queue工作队列模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pub-x2F-Sub-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">Pub&#x2F;Sub 订阅模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Routing%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-text">Routing路由模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Topics%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F"><span class="toc-text">Topics通配符模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="toc-text">工作模式总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot%E6%95%B4%E5%90%88Rabbit-MQ"><span class="toc-text">Spring Boot整合Rabbit MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BABoot%E5%B7%A5%E7%A8%8B"><span class="toc-text">创建Boot工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AERabbit-MQ%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-text">配置Rabbit MQ的基本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81"><span class="toc-text">编写代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rabbit-MQ%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-text">Rabbit MQ高级特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92"><span class="toc-text">消息的可靠投递</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#confirm%E7%A1%AE%E8%AE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">confirm确认模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#return%E9%80%80%E5%9B%9E%E6%A8%A1%E5%BC%8F"><span class="toc-text">return退回模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92%E5%B0%8F%E7%BB%93"><span class="toc-text">消息的可靠投递小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer-Ack"><span class="toc-text">Consumer Ack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-text">消费者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Consumer-Ack-%E5%B0%8F%E7%BB%93"><span class="toc-text">Consumer Ack 小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81"><span class="toc-text">消费端限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Code"><span class="toc-text">Code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81%E5%B0%8F%E7%BB%93"><span class="toc-text">消费端限流小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TTL"><span class="toc-text">TTL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TTL-%E5%B0%8F%E7%BB%93"><span class="toc-text">TTL 小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-text">死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%88%90%E4%B8%BA%E6%AD%BB%E4%BF%A1%E7%9A%84%E4%B8%89%E7%A7%8D%E6%83%85%E5%86%B5"><span class="toc-text">消息成为死信的三种情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E7%BB%91%E5%AE%9A%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-text">队列绑定死信交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Code-1"><span class="toc-text">Code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E5%B0%8F%E7%BB%93"><span class="toc-text">死信队列小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-text">延迟队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Code-2"><span class="toc-text">Code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E5%B0%8F%E7%BB%93"><span class="toc-text">延迟队列小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E4%B8%8E%E7%9B%91%E6%8E%A7"><span class="toc-text">日志与监控</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RabbitMQ%E6%97%A5%E5%BF%97"><span class="toc-text">RabbitMQ日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web%E7%AE%A1%E6%8E%A7%E5%8F%B0%E7%9B%91%E6%8E%A7"><span class="toc-text">web管控台监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rabbitmqctl%E7%AE%A1%E7%90%86%E5%92%8C%E7%9B%91%E6%8E%A7"><span class="toc-text">rabbitmqctl管理和监控</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA"><span class="toc-text">消息追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-Firehose"><span class="toc-text">消息追踪-Firehose</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-rabbitmq-tracing"><span class="toc-text">消息追踪-rabbitmq_tracing</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rabbit-MQ%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98"><span class="toc-text">Rabbit MQ应用问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-text">消息可靠性保障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-text">消息幂等性保障</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rabbit-MQ%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-text">Rabbit MQ集群搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot%E9%85%8D%E7%BD%AERabbit-MQ"><span class="toc-text">Spring Boot配置Rabbit MQ</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By Huang RD</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>